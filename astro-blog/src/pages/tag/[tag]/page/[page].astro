---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import SEO from '../../../../components/SEO.astro';
import BlogCard from '../../../../components/BlogCard.astro';
import Pagination from '../../../../components/Pagination.astro';
import { getPublishedPosts, paginateArray, getTags, slugify, POSTS_PER_PAGE } from '../../../../utils/blog';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  const tags = getTags(posts);
  const paths: any[] = [];

  for (const tag of tags) {
    const tagSlug = slugify(tag);
    const filtered = posts.filter(p => p.data.tags.some((t: string) => slugify(t) === tagSlug));
    const totalPages = Math.ceil(filtered.length / POSTS_PER_PAGE);
    for (let i = 2; i <= totalPages; i++) {
      paths.push({
        params: { tag: tagSlug, page: String(i) },
        props: { tagName: tag },
      });
    }
  }

  return paths;
}

const { tag, page } = Astro.params;
const { tagName } = Astro.props;
const pageNum = parseInt(page!);
const posts = await getPublishedPosts();
const filtered = posts.filter(p => p.data.tags.some((t: string) => slugify(t) === tag));
const { data, totalPages, currentPage } = paginateArray(filtered, pageNum, POSTS_PER_PAGE);
const base = import.meta.env.BASE_URL;
const baseUrl = `${base}tag/${tag}/`;

const prevPage = pageNum === 2
  ? `https://parvaly.com/blog/tag/${tag}/`
  : `https://parvaly.com/blog/tag/${tag}/page/${pageNum - 1}/`;
const nextPage = pageNum < totalPages
  ? `https://parvaly.com/blog/tag/${tag}/page/${pageNum + 1}/`
  : undefined;
---

<BaseLayout class="listing-page">
  <Fragment slot="head">
    <SEO
      title={`Tag: ${tagName} - Page ${currentPage}`}
      description={`Articles tagged with "${tagName}" - page ${currentPage}.`}
      canonical={`https://parvaly.com/blog/tag/${tag}/page/${currentPage}/`}
      prevPage={prevPage}
      nextPage={nextPage}
    />
  </Fragment>

  <div class="listing-container">
    <header class="listing-header">
      <p class="listing-label">Tag</p>
      <h1>{tagName} - Page {currentPage}</h1>
    </header>

    <div class="post-list">
      {data.map(post => <BlogCard post={post} />)}
    </div>

    <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={baseUrl} />
  </div>
</BaseLayout>
