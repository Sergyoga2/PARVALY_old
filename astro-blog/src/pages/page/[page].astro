---
import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import BlogCard from '../../components/BlogCard.astro';
import Pagination from '../../components/Pagination.astro';
import { getPublishedPosts, paginateArray, POSTS_PER_PAGE, SITE_TITLE, SITE_DESCRIPTION } from '../../utils/blog';

export async function getStaticPaths() {
  const posts = await getPublishedPosts();
  const totalPages = Math.ceil(posts.length / POSTS_PER_PAGE);
  const paths = [];
  for (let i = 2; i <= totalPages; i++) {
    paths.push({ params: { page: String(i) } });
  }
  return paths;
}

const { page } = Astro.params;
const pageNum = parseInt(page!);
const posts = await getPublishedPosts();
const { data, totalPages, currentPage } = paginateArray(posts, pageNum, POSTS_PER_PAGE);
const base = import.meta.env.BASE_URL;

const prevPage = pageNum === 2 ? 'https://parvaly.com/blog/' : `https://parvaly.com/blog/page/${pageNum - 1}/`;
const nextPage = pageNum < totalPages ? `https://parvaly.com/blog/page/${pageNum + 1}/` : undefined;
---

<BaseLayout class="listing-page">
  <Fragment slot="head">
    <SEO
      title={`${SITE_TITLE} - Page ${currentPage}`}
      description={SITE_DESCRIPTION}
      canonical={`https://parvaly.com/blog/page/${currentPage}/`}
      prevPage={prevPage}
      nextPage={nextPage}
    />
  </Fragment>

  <div class="listing-container">
    <header class="listing-header">
      <h1>Blog - Page {currentPage}</h1>
    </header>

    <div class="post-list">
      {data.map(post => <BlogCard post={post} />)}
    </div>

    <Pagination currentPage={currentPage} totalPages={totalPages} baseUrl={base} />
  </div>
</BaseLayout>
