# CloudPayments API: Результаты исследования

> Источник: https://developers.cloudpayments.ru/
> Дата исследования: 2026-02-24

---

## 1. Общая информация

- **Base URL:** `https://api.cloudpayments.ru`
- **Аутентификация:** HTTP Basic Auth (Public ID = username, API Secret = password)
- **Формат запросов:** POST, `application/json` или `application/x-www-form-urlencoded`
- **Формат ответов:** JSON `{ "Success": boolean, "Message": string, "Model": object }`
- **Idempotency:** Поддерживается через заголовок `X-Request-ID`
- **Timeout:** 5 минут на ответ

### Rate Limits

| Среда | Лимит |
|-------|-------|
| Test terminal | 5 одновременных запросов |
| Production terminal | 30 одновременных запросов |
| Превышение | HTTP 429 (Too Many Requests) |

→ **Вывод для проекта:** Лимиты достаточны для нашего объёма (~500 подписчиков). Массовые retry не создадут проблем.

---

## 2. Тестовый режим (Sandbox)

- **Есть ли sandbox?** Да. Используется отдельный test terminal ID (пример: `test_api_00000000000000000000002`)
- **Как работает:** Те же API endpoints, те же методы. Деньги НЕ списываются
- **Тестовые карты:** Можно использовать как тестовые, так и реальные карты — списания не произойдёт
- **Ответы:** Содержат `"TestMode": true` для отличия от production
- **Ограничения:** Rate limit 5 запросов (vs 30 в production)

→ **Ответ на OQ-07:** Sandbox есть. Можно тестировать полный billing flow включая trial и recurring.

---

## 3. Подписки (рекуррентные платежи)

### 3.1 Создание подписки

**Endpoint:** `POST /subscriptions/create`

| Параметр | Обязательный | Тип | Описание |
|----------|:---:|------|----------|
| `Token` | Да | String | Токен карты от предыдущего успешного платежа |
| `AccountId` | Да | String (max 255) | Внешний ID пользователя |
| `Amount` | Да | Decimal | Сумма регулярного платежа |
| `Currency` | Да | String | Валюта (RUB/USD/EUR/GBP) |
| `Period` | Да | Integer (>0) | Множитель частоты |
| `Interval` | Да | String | Единица времени: `Day`, `Week`, `Month` |
| `StartDate` | Нет | DateTime | Дата первого списания (должна быть в будущем) |
| `MaxPeriods` | Нет | Integer | Максимальное кол-во платежей |
| `Description` | Нет | String | Описание платежа |
| `Email` | Нет | String | Email для уведомлений |

### 3.2 Мультимесячные интервалы

**Interval + Period определяют частоту:**

| Наш тариф | Interval | Period | Результат |
|-----------|----------|--------|-----------|
| 1 мес (3 900 ₽) | `Month` | `1` | Каждый месяц |
| 3 мес (9 900 ₽) | `Month` | `3` | Каждые 3 месяца |
| 6 мес (17 400 ₽) | `Month` | `6` | Каждые 6 месяцев |
| 12 мес (28 800 ₽) | `Month` | `12` | Каждые 12 месяцев |

**Ограничение:** интервал между платежами не может превышать 1 год. 12 месяцев — максимум, но это нам подходит.

→ **Ответ на AS-02 / Spike 2 / R-02:** CloudPayments **ПОДДЕРЖИВАЕТ** мультимесячные интервалы нативно. Кастомный scheduler НЕ нужен. Риск R-02 (20%) **снят**.

### 3.3 Управление подпиской

| Операция | Endpoint | Что можно |
|----------|----------|-----------|
| Получить | `GET /subscriptions/get?subscriptionId={id}` | Статус, детали |
| Найти | `POST /subscriptions/find` | Поиск по AccountId |
| Изменить | `POST /subscriptions/update` | Amount, StartDate, MaxPeriods, пауза |
| Отменить | `POST /subscriptions/cancel` | Прекращение рекуррента |

### 3.4 Изменение суммы

API позволяет изменить сумму через `subscriptions/update` **в любой момент**, без пересоздания подписки.

→ **Ответ на AS-05:** CloudPayments **ПОЗВОЛЯЕТ** изменить сумму рекуррента. Для cancellation save-offer (скидка 30%) можно:
- Вариант A: Изменить Amount на 1 период, потом вернуть обратно
- Вариант B: Отменить старую, создать новую (более чисто для логики «скидка на 1 месяц»)

**Рекомендация:** Вариант B (cancel + create) для скидки, т.к. скидка действует ровно 1 период, а потом нужна полная цена.

### 3.5 Статусы подписки в CloudPayments

| Статус | Описание |
|--------|----------|
| `Active` | Активная, списания по расписанию |
| `Paused` | Приостановлена (можно через API или dashboard) |
| `Cancelled` | Отменена |
| `Expired` | Достигнут MaxPeriods |

→ CloudPayments нативно поддерживает статус **Paused** — это полезно для Phase D (пауза подписки).

### 3.6 Автоматическая обработка ошибок (retry)

CloudPayments сам обрабатывает retry:
1. При неуспешном списании — уведомляет пользователя
2. Повторяет попытку **каждый день в течение 3 дней**
3. После 3 неуспешных попыток подряд — **отменяет подписку**
4. Предлагает пользователю обновить карту

→ **Важно:** Это расходится с нашим дизайном (4 retry: +0ч, +24ч, +48ч, +96ч). CloudPayments делает 3 retry с интервалом 1 день. Нужно решить:
- **Вариант A:** Использовать встроенный retry CloudPayments (3 попытки, 3 дня) — проще
- **Вариант B:** Отключить встроенный retry, управлять retry самостоятельно через token-based payments — гибче, но сложнее

**Рекомендация:** Вариант A для Phase A/B. Адаптировать наш дизайн: grace period = 72 часа (3 дня), 3 retry вместо 4.

---

## 4. Trial Period: Нативная поддержка

### Есть ли нативный trial?

**НЕТ.** CloudPayments не имеет встроенного параметра `trialDays` или `trialPeriod` при создании подписки.

### Как реализовать trial:

**Рекомендуемый подход (Вариант B из наших документов):**

1. Пользователь привязывает карту через виджет с `tokenize: true`
2. Выполняется «установочный платёж» (establishment payment) на минимальную сумму (1 ₽) для валидации карты и получения токена
3. Токен сохраняется в нашей базе
4. Приложение управляет trial-периодом (7 дней) через собственную логику
5. По истечении 7 дней — создаём подписку через `POST /subscriptions/create` с сохранённым токеном

**Параметр StartDate:** Можно создать подписку сразу, но с `StartDate = now + 7 days`. Первое списание произойдёт через 7 дней.

→ **Ответ на AS-01 / Spike 1 / R-01:** CloudPayments **НЕ ПОДДЕРЖИВАЕТ** trial нативно. Нужна реализация на стороне приложения. Риск R-01 **подтверждён**. Есть два подхода:

| Подход | Описание | Плюсы | Минусы |
|--------|----------|-------|--------|
| A: Отложенная подписка | `subscriptions/create` с `StartDate = now + 7 days` | Проще: подписка создаётся сразу | Отмена trial = отмена подписки в CP. Нет гибкости |
| B: Token + scheduler | Сохраняем token, через 7 дней создаём подписку | Полный контроль: отмена без обращения к CP | Нужен собственный TrialExpirationJob |

**Рекомендация:** Подход A (отложенная подписка) как более простой:
- `subscriptions/create` с `StartDate = trial_ends_at`, `Amount = 3900`, `Period = 1`, `Interval = Month`
- Отмена trial = `subscriptions/cancel`
- CloudPayments сам выполнит первое списание через 7 дней

---

## 5. Токены

### Получение токена

Два способа:
1. **Через виджет:** параметр `tokenize: true` при инициализации
2. **Через API:** параметр `SaveCard: true` при платеже

Токен приходит в Pay webhook в поле `Token`.

### Сохраняется ли токен после отмены подписки?

Документация **явно не описывает** поведение токена после cancel. Однако:
- Токен привязан к карте, а не к подписке
- `Token` приходит при первом успешном платеже (Pay webhook)
- Подписка создаётся по токену, а не наоборот

→ **Ответ на AS-03:** Скорее всего токен **сохраняется** после отмены подписки (он привязан к карте, не к подписке). Но это нужно **подтвердить тестированием в sandbox**. Это критично для:
- Win-back (переоформление без ввода карты)
- Pause → Resume (пересоздание подписки)

---

## 6. Webhooks (уведомления)

### Типы webhooks

| Тип | Когда срабатывает | Ключевые поля |
|-----|-------------------|---------------|
| **Check** | До обработки платежа (проверка суммы) | TransactionId, Amount, AccountId |
| **Pay** | После успешного платежа | TransactionId, Amount, Token, AccountId, SubscriptionId |
| **Fail** | При неуспешном платеже | TransactionId, ReasonCode, Amount, AccountId |
| **Recurrent** | При выполнении рекуррентного платежа | SubscriptionId, Amount, Status |
| **Cancel** | При отмене транзакции/подписки | TransactionId |
| **Refund** | При возврате | TransactionId, Amount |
| **Confirm** | Для двухстадийных платежей | TransactionId |

### Поле retry_count в Fail webhook

**НЕТ** отдельного поля `retry_count` в Fail webhook. CloudPayments управляет retry внутренне. Fail webhook приходит при каждой неуспешной попытке. Для отслеживания retry нужно считать Fail webhooks на стороне приложения.

→ **Ответ на OQ-06 (формат subscription_id):** SubscriptionId — строка формата `"sc_XXXXXXXXXXXX"`.

→ **Ответ на AS-04:** Webhook содержит TransactionId, Amount, AccountId, SubscriptionId, Token — этого **достаточно** для идентификации.

---

## 7. 3D Secure

### Первый платёж

3D Secure может потребоваться при первом платеже (привязка карты / widget). Это зависит от банка-эмитента карты.

### Рекуррентные платежи

Рекуррентные платежи выполняются **автоматически, без подтверждения плательщика**. 3D Secure **не применяется** к рекуррентным списаниям.

→ **Ответ на OQ-08:** 3D Secure **НЕ блокирует** рекуррентные списания и auto-conversion. 3DS применяется только к первому платежу (привязка карты). Это снимает риск «auto-conversion заблочиться на 3DS».

---

## 8. Виджет

### Инициализация

```html
<script src="https://widget.cloudpayments.ru/bundles/cloudpayments.js"></script>
```

```javascript
const widget = new cp.CloudPayments();
widget.start({
  publicTerminalId: "pk_...",
  amount: 1,           // 1 ₽ для валидации карты
  currency: "RUB",
  tokenize: true,       // сохранить токен
  recurrent: {          // или сразу создать подписку
    period: 1,
    interval: 'Month',
    amount: 3900,
    startDate: '2026-03-03T00:00:00Z'  // через 7 дней
  }
});
```

### Параметры для trial

Для trial рекомендуется два варианта:
1. **tokenize: true** — просто сохранить карту, подписку создать позже через API
2. **recurrent с startDate** — создать подписку через виджет, но с отложенным стартом

---

## 9. Ответы на Open Questions из README.md

### Backend / Платежи

| # | Вопрос | Ответ из документации |
|---|--------|-----------------------|
| OQ-05 → AS-01 | Поддерживает ли API нативный trial? | **НЕТ.** Нужна реализация на стороне приложения. Рекомендация: отложенная подписка (StartDate) |
| OQ-06 | Формат subscription_id | Строка `"sc_XXXXXXXXXXXX"` |
| OQ-07 | Есть ли sandbox? | **ДА.** Test terminal, те же endpoints, деньги не списываются |
| OQ-08 | 3D Secure при рекуррентных | **НЕ ПРИМЕНЯЕТСЯ.** Только для первого платежа |
| OQ-10 | Rate limits | Test: 5, Production: 30 одновременных запросов. HTTP 429 при превышении |

### Assumptions

| # | Assumption | Статус | Комментарий |
|---|-----------|--------|-------------|
| AS-01 | Trial нативно | **НЕ ПОДТВЕРДИЛСЯ** | Trial реализуем через StartDate или token + scheduler |
| AS-02 | Multi-month intervals | **ПОДТВЕРДИЛСЯ** | Period=3/6/12 + Interval=Month |
| AS-03 | Токен сохраняется после cancel | **ВЕРОЯТНО ДА**, нужен тест в sandbox |
| AS-04 | Webhook содержит достаточно данных | **ПОДТВЕРДИЛСЯ** | TransactionId, Amount, AccountId, SubscriptionId, Token |
| AS-05 | Можно изменить сумму рекуррента | **ПОДТВЕРДИЛСЯ** | subscriptions/update → Amount |

### Risks

| # | Риск | Обновлённый статус |
|---|------|--------------------|
| R-01 | Trial не нативно (+2-3 нед) | **ПОДТВЕРЖДЁН**, но impact ниже ожидаемого: через StartDate реализуется за ~1 неделю |
| R-02 | Multi-month не поддерживается | **СНЯТ** — поддерживается нативно |

---

## 10. Spike / PoC: обновлённые рекомендации

### Spike 1: Trial (упрощён)

Вместо полного исследования — достаточно проверить в sandbox:
1. Создать подписку с `StartDate = now + 7 days` — убедиться, что списание произойдёт через 7 дней
2. Отменить эту подписку до StartDate — убедиться, что списания не будет
3. Проверить, какой webhook приходит при автоматическом первом списании (Pay? Recurrent?)

### Spike 2: Multi-Month (снят)

Документация подтверждает поддержку. Spike не нужен — достаточно проверить в sandbox при реализации Phase A.

### Spike 3: Feature Flags (без изменений)

Зависит от текущего стека проекта. Вопрос к команде.

---

## 11. Рекомендации по адаптации дизайна

### Retry логика

**Было:** 4 retry (+0ч, +24ч, +48ч, +96ч), grace period до 96ч
**Стало (рекомендация):** Использовать встроенный retry CloudPayments:
- 3 retry с интервалом 1 день
- Grace period = **72 часа** (3 дня)
- После 3 неуспешных попыток → CloudPayments отменяет подписку → webhook Cancel → наш статус → expired

Это упрощает реализацию: не нужен GracePeriodRetryJob для рекуррентных платежей.

### Trial flow

**Было:** Два варианта (A: CP manages trial, B: App manages trial)
**Стало:** Гибридный подход:
1. Виджет с `tokenize: true` для получения токена
2. Минимальный «установочный» платёж (1 ₽) — опционально, если нужен чек
3. `subscriptions/create` с `StartDate = trial_ends_at`
4. Наш TrialExpirationJob **не нужен для списания** — CP спишет сам
5. Наш TrialReminderEmailJob **нужен** — для email за 24ч и 1ч
6. Отмена trial = `subscriptions/cancel` → наш статус trial_cancelled

### Пауза

CloudPayments нативно поддерживает статус `Paused` через `subscriptions/update`. При resume — подписка возобновляется. Это упрощает Phase D:
- Пауза: `subscriptions/update` → status Paused
- Resume: `subscriptions/update` → status Active + новый StartDate
