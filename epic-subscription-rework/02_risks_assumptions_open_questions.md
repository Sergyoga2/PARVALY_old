# Риски, Assumptions и Open Questions

## 1. Assumptions (что предполагаем для реализации)

### Billing / CloudPayments

> **Обновлено 2026-02-24** по результатам исследования CloudPayments API.
> Полный отчёт: [appendix/cloudpayments-api-research.md](appendix/cloudpayments-api-research.md)

| # | Assumption | Статус | Комментарий |
|---|-----------|--------|-------------|
| AS-01 | CloudPayments поддерживает создание подписки с trial period | ❌ **Не подтвердился** | Нет нативного trial. Решение: `subscriptions/create` с `StartDate = now + 7 days`. Spike 1 упрощён |
| AS-02 | CloudPayments поддерживает интервалы подписки 3/6/12 месяцев | ✅ **Подтвердился** | `Interval: "Month"` + `Period: 3/6/12`. Spike 2 **снят** |
| AS-03 | При отмене подписки токен карты сохраняется | ⚠️ **Вероятно да** | Токен привязан к карте, не к подписке. Но явного подтверждения в документации нет. **Нужен тест в sandbox** |
| AS-04 | Webhook содержит достаточно данных (subscription_id, transaction_id, status, amount) | ✅ **Подтвердился** | Pay webhook содержит: TransactionId, Amount, Token, AccountId, SubscriptionId |
| AS-05 | Можно изменить сумму рекуррента | ✅ **Подтвердился** | `subscriptions/update` → поле Amount. Можно менять в любой момент |

### Архитектура

| # | Assumption | Impact if wrong |
|---|-----------|-----------------|
| AS-06 | На проекте есть background job runner (Sidekiq, Celery, cron) для отложенных задач | Высокий: нужно внедрять. Критично для trial expiration, retry, scheduled emails |
| AS-07 | На проекте есть email-sending инфраструктура (SMTP / API) | Средний: нужно выбрать и подключить сервис |
| AS-08 | Текущая модель данных подписки может быть расширена (добавление полей status, trial_*, pause_*) без breaking changes | Средний: если структура жёсткая — нужна миграция |
| AS-09 | Текущая авторизация/аутентификация не требует изменений для trial | Низкий: trial — это просто новый статус подписки |

### Продуктовые

| # | Assumption | Impact if wrong |
|---|-----------|-----------------|
| AS-10 | Trial доступен ТОЛЬКО пользователям, которые НИКОГДА не имели платной подписки | Средний: если нужно давать trial бывшим подписчикам (>12 мес назад) — нужна дополнительная логика |
| AS-11 | При upgrade из trial на платный тариф — оставшиеся дни trial «дарим» (не вычитаем и не прибавляем) | Низкий: простая логика |
| AS-12 | При отмене мультимесячного тарифа доступ сохраняется до конца оплаченного периода, деньги не возвращаются | Низкий: подтверждено владельцем продукта |
| AS-13 | При автопродлении мультимесячного тарифа — продление на тот же период по той же цене | Низкий: подтверждено |
| AS-14 | Win-back скидка: 1 использование за 6 месяцев. Cancellation save-offer и win-back делят один и тот же лимит | Средний: если раздельные лимиты — другая логика |

---

## 2. Open Questions

### Для продукта (адресовать Product Owner)

| # | Вопрос | Зачем нужен ответ | Рекомендация | Impact if unresolved |
|---|--------|-------------------|-------------|---------------------|
| OQ-01 | При upgrade из месячного на 6-мес: остаток текущего месяца «дарим» или пересчитываем pro-rata? | Влияет на billing-логику | Дарим (проще в реализации, лучше UX) | Средний: задержка реализации upgrade flow |
| OQ-02 | Пользователь оформил trial, отменил на 2-й день, через год хочет вернуться. Trial или только платный? | Влияет на бизнес-логику trial restriction | Только платный (trial_used = forever), но можно предложить win-back скидку | Низкий |
| OQ-03 | Нужно ли показывать trial CTA на других страницах (главная, каталог, страница навыка) или только на pricing page? | Влияет на frontend scope | Начать с pricing page, расширить позже | Низкий |
| OQ-04 | После конвертации trial → paid: сразу предлагать upgrade на мультимесячный или дать 1-2 месяца? | Влияет на email-цепочку | В confirmation email после конвертации + через 2 недели | Низкий |
| OQ-05 | Пауза: пользователь на паузе может покупать ДПО (отдельные профессии)? | Влияет на access control | Да, ДПО — независимый продукт | Низкий |

### Для backend / платежей (✅ ответы получены из документации API)

| # | Вопрос | Ответ | Источник |
|---|--------|-------|----------|
| OQ-06 | Какой формат subscription_id? | Строка `"sc_XXXXXXXXXXXX"` | API docs: subscriptions/create response |
| OQ-07 | Есть ли sandbox? | **Да.** Test terminal (ID: `test_api_...`). Те же endpoints, деньги не списываются. Rate limit: 5 запросов | API docs: тестовый режим |
| OQ-08 | 3D Secure при рекуррентных? | **Не применяется.** 3DS только для первого платежа (привязка карты). Рекуррентные списания автоматические без подтверждения | API docs: 3-D Secure |
| OQ-09 | Кодовая база: фреймворк, ORM? | **Ожидает ответа от команды** | — |
| OQ-10 | Rate limits? | Test: 5, Production: **30 одновременных запросов**. HTTP 429 при превышении | API docs: общая информация |

### Для юристов (адресовать Legal)

| # | Вопрос | Зачем нужен ответ | Рекомендация | Impact if unresolved |
|---|--------|-------------------|-------------|---------------------|
| OQ-11 | Нужен ли чек на 0 ₽ при активации trial (54-ФЗ)? | Может потребоваться интеграция с ОФД | Скорее да, проверить с юристом | Средний: может потребовать доп. интеграции |
| OQ-12 | Обязательно ли уведомление за 24ч до автосписания по закону? | Определяет обязательность email T4 | Да, даже если не обязательно — best practice и снижение chargebacks | Высокий: юридический риск |
| OQ-13 | Нужно ли отдельное согласие (checkbox) на рекуррент при привязке карты? | UX привязки карты | Да, checkbox «Согласен с условиями подписки и автопродлением» | Высокий |
| OQ-14 | Политика возвратов мультимесячных: нужно ли описывать в оферте? | Юридическая защита | Да, явно прописать: «возврат за вычетом использованного по цене месячного тарифа» | Средний |
| OQ-15 | Можно ли отправлять win-back письма со скидками без нарушения закона о рекламе (если пользователь отписался от маркетинговых)? | Легальность win-back | Win-back ≠ маркетинг (это service communication), но лучше уточнить | Средний |

### Для аналитики (адресовать Data Analyst)

| # | Вопрос | Зачем нужен ответ | Impact if unresolved |
|---|--------|-------------------|---------------------|
| OQ-16 | Какая система аналитики используется? | Реализация event tracking | Средний: может потребовать доп. интеграции |
| OQ-17 | Есть ли DWH / data pipeline? | Когортный анализ trial vs direct | Средний |
| OQ-18 | Нужен ли real-time дашборд или достаточно daily? | Архитектура аналитики | Низкий |

---

## 3. Риски

### Технические

| # | Риск | Probability | Impact | Митигация | Owner |
|---|------|:-----------:|:------:|-----------|-------|
| R-01 | ~~CloudPayments не поддерживает trial natively~~ | ~~30%~~ | ~~Высокий~~ | ✅ **Подтверждён, но impact ниже:** trial через `StartDate` реализуется за ~1 нед, не 2-3. Spike упрощён | Backend |
| R-02 | ~~CloudPayments не поддерживает multi-month intervals~~ | ~~20%~~ | ~~Высокий~~ | ✅ **СНЯТ:** `Period=3/6/12, Interval=Month` работает нативно | Backend |
| R-03 | Trial expiration job опаздывает (задержка cron) → списание происходит позже 7 дней | 15% | Средний | Idempotent job, мониторинг задержек | Backend |
| R-04 | Race condition: пользователь отменяет trial за секунды до авто-конвертации | 10% | Средний | DB lock на subscription при изменении статуса, проверка status перед списанием | Backend |
| R-05 | Email scheduler отправляет дубликаты (за 24ч и за 1ч) | 10% | Низкий | Idempotency key на email sends, deduplication | Backend |

### Бизнесовые

| # | Риск | Probability | Impact | Митигация |
|---|------|:-----------:|:------:|-----------|
| R-06 | Trial каннибализирует direct purchases: текущие 88 покупателей начнут trial вместо оплаты, конверсия trial→paid < 20% | 25% | Высокий | Staged rollout с kill-метрикой RPV |
| R-07 | Мультимесячные тарифы не востребованы: 90%+ берут месячный | 20% | Средний | Якорный эффект в UI (6 мес = «Выбор большинства»), A/B тест цен позже |
| R-08 | Chargeback rate вырастет из-за авто-конвертации trial | 15% | Высокий | Два email-уведомления, простая отмена, ясный текст при оформлении |
| R-09 | Abuse trial: массовые регистрации | 10% | Средний | V1: 1 trial/account. V2: card token dedup. V3: device fingerprint |
| R-10 | Legacy-подписчики недовольны изменениями | 5% | Низкий | Их условия не меняются. Коммуникация: «ваш тариф сохранён» |

### Операционные

| # | Риск | Probability | Impact | Митигация |
|---|------|:-----------:|:------:|-----------|
| R-11 | Нагрузка на support из-за вопросов о trial / авто-списании | 40% | Средний | FAQ, ясный UX, in-app подсказки |
| R-12 | Юридическая оферта не обновлена до запуска trial | 20% | Высокий (блокер) | Включить legal review в Phase B checklist |
| R-13 | Email-инфраструктура не справляется с объёмом (scheduled + triggered) | 10% | Средний | Нагрузочное тестирование перед Phase B |
