# TASK-D03: Win-back email серия для trial-отменивших

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D03 |
| Title | Win-back email серия для пользователей, отменивших trial |
| Phase | D — Retention |
| Priority | P2 |

---

## A) Краткое описание

Вернуть пользователей, которые попробовали trial и не конвертировались. Серия из 4 писем с нарастающей ценностью и скидкой. Скидки предоставляются с учётом общего лимита 1 retention-скидка за 6 месяцев (C07). Если пользователь не eligible для скидки — письмо отправляется без скидки (только контент + CTA на полную цену).

---

## B) Scope / Out of Scope

### Scope
- Серия из 4 писем: +1 день, +7 дней, +14 дней (скидка 20%), +30 дней (скидка 30%)
- Триггер: отмена trial (B04)
- Интеграция с сервисом проверки права на скидку (C07)
- Исключения: пользователи с активной подпиской, на паузе, отписавшиеся от рассылки
- Идемпотентность: каждое письмо отправляется однократно
- Возможность отписки от win-back серии

### Out of Scope
- Win-back для платных отменивших (D04)
- Финальные тексты и дизайн email (утверждаются с маркетингом)
- Реализация применения скидки (используется существующий механизм)

---

## C) Бизнес-правила и состояния

### Расписание серии

| # | День после отмены | Тема | Скидка | Содержание |
|---|:-:|---------|:---:|-----------|
| W1 | +1 | «Мы сохранили ваш прогресс» | Нет | Мягкое, контентное. Прогресс пользователя, рекомендации |
| W2 | +7 | «Новые навыки в каталоге» | Нет | Контентное. Популярные / новые навыки |
| W3 | +14 | «Вернитесь со скидкой 20%» | 20% | Первый месяц со скидкой. Действует 7 дней |
| W4 | +30 | «Последнее предложение: -30%» | 30% | Первый месяц со скидкой. Действует 7 дней. Финальное |

### Правила скидок в письмах
- Скидка применяется только к первому месяцу, далее полная цена
- Скидка действует 7 дней с момента отправки письма
- Если пользователь **не eligible** (лимит C07): письмо отправляется без скидки (только контент + CTA на полную цену)
- Скидка используется через общий лимит retention-скидок (C07)

### Правила исключения
- Пользователь переоформил подписку → пропускается
- Пользователь на паузе → пропускается
- Пользователь отписался от win-back рассылки → пропускается
- Письмо данного типа уже отправлено → дубликат не отправляется

### Отписка
- Все win-back письма содержат ссылку на отписку от серии
- При отписке — пользователь исключается из текущей и будущих win-back серий

---

## D) Пользовательские и системные сценарии

1. **Given** trial отменён вчера, **When** фоновая задача, **Then** W1 email отправлен с прогрессом пользователя.
2. **Given** trial отменён 7 дней назад, W1 уже отправлен, **When** фоновая задача, **Then** W2 email отправлен.
3. **Given** trial отменён 14 дней назад, eligible для скидки, **When** фоновая задача, **Then** W3 с 20% скидкой отправлен.
4. **Given** trial отменён 14 дней назад, NOT eligible (лимит C07), **When** фоновая задача, **Then** W3 без скидки отправлен.
5. **Given** пользователь переоформил подписку между W1 и W2, **When** фоновая задача, **Then** W2 не отправляется.
6. **Given** W1 уже отправлен, **When** фоновая задача запускается повторно, **Then** дубликат W1 не отправлен.
7. **Given** пользователь на паузе, **When** фоновая задача, **Then** пропускается.
8. **Given** пользователь отписался от win-back после W2, **When** наступает день W3, **Then** W3 не отправляется.
9. **Given** пользователь использовал скидку в cancellation (C03) 2 месяца назад, **When** W3 с предложением скидки, **Then** W3 без скидки.
10. **Given** trial отменён 30 дней назад, eligible для скидки, **When** фоновая задача, **Then** W4 с 30% скидкой отправлен (финальное предложение).
11. **Given** пользователь кликнул ссылку со скидкой в W3, **When** оформляет подписку, **Then** скидка применена, дата использования скидки зафиксирована (C07).
12. **Given** пользователь получил W4, скидка истекла (прошло 7 дней), **When** пользователь пытается использовать ссылку, **Then** скидка не применяется, стандартная цена.

---

## E) Acceptance Criteria

- [ ] W1 отправляется через 1 день после отмены trial
- [ ] W2 отправляется через 7 дней после отмены trial
- [ ] W3 с 20% скидкой через 14 дней (если eligible)
- [ ] W4 с 30% скидкой через 30 дней (если eligible)
- [ ] Письмо без скидки, если пользователь не eligible (лимит C07)
- [ ] Пользователи с активной подпиской / на паузе исключаются
- [ ] Идемпотентность: дубликаты не отправляются
- [ ] Отписка от серии работает корректно
- [ ] Скидка действует 7 дней

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `winback_email_sent` | user_id, email_number, type: "trial", has_discount |
| `winback_email_opened` | user_id, email_number |
| `winback_email_clicked` | user_id, email_number |
| `winback_converted` | user_id, email_number, plan_type, discount_used |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Инфраструктура email-рассылок уже существует (в том числе отложенная отправка)
- Механизм отписки от маркетинговых рассылок уже реализован
- Данные о прогрессе пользователя доступны для персонализации писем

### Риски
- Win-back письма попадают в спам → настройка deliverability, SPF/DKIM
- Скидочная ссылка может быть передана другому пользователю → привязка к конкретному пользователю
- Массовая отмена trial → большой объём win-back писем → мониторинг нагрузки на email-сервис

---

## H) Open questions для CTO/разработчиков

1. Как реализовать фоновую задачу: ежедневный cron, событийная модель при отмене trial, или отложенные задачи?
2. Win-back email — marketing или transactional? Нужно ли уважать отписку от маркетинговых рассылок?
3. Как генерировать уникальную скидочную ссылку: одноразовый токен, промокод, или специальный URL?
4. Как контролировать срок действия скидки (7 дней): на уровне ссылки или на уровне применения?
5. Нужна ли A/B тестирование тем и содержания писем?
6. Как персонализировать W1 (прогресс): запрашивать данные при отправке или кешировать при отмене?
7. Как обрабатывать ситуацию, когда пользователь отменяет trial повторно (после win-back): новая серия или продолжение?
8. Нужна ли возможность администратора остановить/перезапустить серию для конкретного пользователя?
9. Как отслеживать конверсии из win-back: UTM-метки, специальный параметр, или промокод?
10. Нужно ли ограничивать отправку в определённое время суток (например, не отправлять ночью)?
11. Как обрабатывать ситуацию: пользователь получил W3 со скидкой, но не использовал, затем получает W4 с большей скидкой — может ли использовать обе?
12. Нужна ли отдельная отписка от win-back (отдельно от общей маркетинговой отписки)?

---

## I) Что убрано из исходника

- **Ruby-код** (`WinBackTrialJob`, `find_eligible_users`, `already_sent?`, SQL-запрос) → заменён на бизнес-правила и расписание серии
- **Конкретные имена сервисов** (`WinBackMailer`, `EmailLog`, `DiscountEligibilityService.new.eligible?`) → заменены на описание логики
- **SQL-запросы** для поиска eligible пользователей → заменены на правила исключения
- **Конкретные цены** (3 120 ₽, 2 730 ₽) → заменены на формулировку «со скидкой»
