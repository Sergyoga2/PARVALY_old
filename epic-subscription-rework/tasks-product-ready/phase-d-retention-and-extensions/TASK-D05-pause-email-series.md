# TASK-D05: Email-серия для паузы подписки

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D05 |
| Title | Email-серия для паузы: активация, напоминание, возобновление |
| Phase | D — Retention |
| Priority | P2 |

---

## A) Краткое описание

Серия из 3 email-уведомлений, сопровождающих паузу подписки: при активации паузы, за 3 дня до автоматического возобновления (напоминание) и при возобновлении. Обеспечивает информирование пользователя на каждом этапе жизненного цикла паузы.

---

## B) Scope / Out of Scope

### Scope
- H1: Email при активации паузы (немедленно)
- H2: Email за 3 дня до возобновления (по расписанию)
- H3: Email при возобновлении подписки — автоматическом или досрочном (немедленно)
- Идемпотентность: каждое уведомление отправляется однократно
- Отмена неотправленных уведомлений при отмене подписки во время паузы

### Out of Scope
- Pause backend (D01)
- Read-only доступ (D02)
- Финальные тексты email (утверждаются с маркетингом)

---

## C) Бизнес-правила и состояния

### Расписание серии

| ID | Триггер | Тема | Содержание |
|----|---------|------|------------|
| H1 | Пауза активирована | «Подписка на паузе. Увидимся через 30 дней» | Что доступно (read-only), когда возобновится, дата |
| H2 | За 3 дня до окончания паузы | «Через 3 дня подписка возобновится» | Напоминание, сумма списания, CTA «Отменить если нужно» |
| H3 | Подписка возобновлена (auto или manual) | «С возвращением! Вот что вы пропустили» | Новые навыки/уроки за время паузы, CTA «Продолжить обучение» |

### Правила отправки
- H1: отправляется немедленно при активации паузы
- H2: отправляется за 3 дня до даты автоматического возобновления (если подписка всё ещё на паузе)
- H3: отправляется при любом способе возобновления (автоматическом через 30 дней или досрочном по инициативе пользователя)
- H2: transactional email (отправляется даже при отписке от маркетинга, т.к. содержит информацию о предстоящем списании)
- Если подписка отменена во время паузы → H2 и H3 не отправляются

### Содержание H2 (обязательное)
- Дата возобновления
- Сумма предстоящего списания
- Ссылка на отмену (если пользователь передумал)

---

## D) Пользовательские и системные сценарии

1. **Given** подписка поставлена на паузу, **When** немедленно, **Then** H1 email отправлен с датой возобновления.
2. **Given** подписка на паузе, **When** до возобновления осталось 3 дня, **Then** H2 email отправлен с суммой и датой.
3. **Given** подписка автоматически возобновлена через 30 дней, **When** немедленно, **Then** H3 email отправлен.
4. **Given** подписка досрочно возобновлена пользователем, **When** немедленно, **Then** H3 email отправлен.
5. **Given** подписка отменена во время паузы (до H2), **When** наступает запланированная дата H2, **Then** H2 НЕ отправлен.
6. **Given** подписка отменена во время паузы, **When** дата возобновления, **Then** H3 НЕ отправлен.
7. **Given** H1 уже отправлен, **When** повторный запуск задачи, **Then** дубликат H1 не отправлен.
8. **Given** пользователь отписался от маркетинга, **When** H2, **Then** H2 всё равно отправляется (transactional).
9. **Given** подписка на паузе, возобновление через 4 дня, **When** фоновая задача проверки, **Then** H2 не отправляется (ещё не 3 дня).
10. **Given** подписка досрочно возобновлена на 2-й день паузы, **When** немедленно, **Then** H3 отправлен, H2 не будет отправлен.

---

## E) Acceptance Criteria

- [ ] H1 отправляется немедленно при активации паузы
- [ ] H2 отправляется за 3 дня до возобновления
- [ ] H3 отправляется при возобновлении (auto и manual)
- [ ] H2 содержит сумму и дату предстоящего списания
- [ ] Отменённая подписка: H2/H3 не отправляются
- [ ] Идемпотентность: дубликаты не отправляются
- [ ] H2 отправляется как transactional (даже при отписке от маркетинга)

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `pause_email_sent` | user_id, email_type (H1/H2/H3) |
| `pause_email_opened` | user_id, email_type |
| `pause_email_clicked` | user_id, email_type, link |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Инфраструктура email-рассылок существует (в том числе отложенная отправка)
- H2 является transactional email (предупреждение о списании)
- Данные о новых навыках/уроках за период паузы доступны для H3

### Риски
- H2 попадает в спам → пользователь не узнаёт о предстоящем списании → проверить deliverability
- Задержка в отправке H2: приходит менее чем за 3 дня → выделенная очередь для time-critical emails

---

## H) Open questions для CTO/разработчиков

1. Как реализовать отложенную отправку H2: отложенная задача при активации паузы или ежедневная проверка?
2. Является ли H2 юридически обязательным (как T4/T5 в B06)? Если да — transactional.
3. Как получить данные «что нового за время паузы» для H3: запрос к каталогу или предрассчитанные данные?
4. Нужно ли в H1 показывать, что именно будет доступно в read-only?
5. Как обрабатывать ситуацию: досрочное возобновление, H2 уже в очереди — отменить?
6. В каком timezone показывать дату возобновления в H2?
7. Нужно ли различать H3 для auto-resume и manual resume (разный контент)?
8. Нужен ли механизм ручной переотправки email (admin tool)?
9. Как обрабатывать bounce (email не доставлен): retry, алерт, или игнорировать?
10. Нужно ли в H2 предлагать альтернативу (например, «отменить» vs «продлить паузу»)?

---

## I) Что убрано из исходника

- **Конкретные триггеры и обработчики** → заменены на описание триггеров и правил
- **Детали реализации отложенной отправки** → вынесены в Open Questions
