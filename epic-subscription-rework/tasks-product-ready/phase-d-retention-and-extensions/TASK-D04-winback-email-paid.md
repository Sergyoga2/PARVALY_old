# TASK-D04: Win-back email серия для платных-отменивших

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D04 |
| Title | Win-back email серия для пользователей, отменивших платную подписку |
| Phase | D — Retention |
| Priority | P2 |

---

## A) Краткое описание

Вернуть пользователей, отменивших платную подписку. Серия из 5 писем с персонализацией (прогресс, рекомендации) и нарастающей скидкой. Отличается от trial win-back (D03) более длинной серией, персонализацией по прогрессу и таргетированием скидок на мультимесячные тарифы.

---

## B) Scope / Out of Scope

### Scope
- Серия из 5 писем: +1 день, +7 дней, +14 дней (скидка 25%), +30 дней (скидка 30%), +60 дней (скидка 50%)
- Триггер: отмена платной подписки (C01)
- Персонализация: прогресс пользователя (пройденные уроки, навыки)
- Интеграция с сервисом проверки права на скидку (C07)
- Исключения: пользователи с активной подпиской, на паузе, отписавшиеся
- Скидки таргетированы на 3-месячный тариф

### Out of Scope
- Win-back для trial-отменивших (D03)
- Финальные тексты и дизайн email (утверждаются с маркетингом)

---

## C) Бизнес-правила и состояния

### Расписание серии

| # | День после отмены | Тема | Скидка | Содержание |
|---|:-:|---------|:---:|-----------|
| P1 | +1 | «Подписка отменена. Ваш прогресс: X уроков, Y навыков» | Нет | Персонализированное. Прогресс, рекомендации |
| P2 | +7 | «Тем временем, вот что нового в каталоге» | Нет | Контентное. Новые навыки, обновления |
| P3 | +14 | «Вернитесь: -25% на первый месяц из 3-мес тарифа» | 25% | Скидка на первый месяц, действует 7 дней |
| P4 | +30 | «-30% на первый месяц из 3-мес тарифа» | 30% | Скидка на первый месяц, действует 7 дней |
| P5 | +60 | «Последний шанс: -50% на первый месяц» | 50% | Финальное предложение, действует 7 дней |

### Правила скидок
- Скидка применяется только к первому месяцу, далее полная цена
- Скидка действует 7 дней с момента отправки
- Скидки таргетированы на 3-месячный тариф (или более длительный)
- Если пользователь **не eligible** (лимит C07): письмо без скидки
- 1 использование / 6 месяцев — общий лимит с cancellation save-offer (C03)

### Персонализация P1
- Количество пройденных уроков
- Количество завершённых навыков
- Количество навыков в процессе
- Сообщение: «Всё это сохранено и ждёт вас»

### Правила исключения
- Аналогично D03: активная подписка, пауза, отписка, дубликаты

---

## D) Пользовательские и системные сценарии

1. **Given** подписка отменена вчера, **When** фоновая задача, **Then** P1 отправлен с корректным прогрессом пользователя.
2. **Given** отмена 7 дней назад, **When** фоновая задача, **Then** P2 отправлен с новостями каталога.
3. **Given** отмена 14 дней назад, eligible для скидки, **When** фоновая задача, **Then** P3 со скидкой 25%.
4. **Given** отмена 14 дней назад, NOT eligible (лимит C07), **When** фоновая задача, **Then** P3 без скидки.
5. **Given** пользователь переоформил подписку после P1, **When** фоновая задача, **Then** P2 не отправляется.
6. **Given** пользователь на паузе, **When** фоновая задача, **Then** пропускается.
7. **Given** пользователь использовал скидку в cancellation (C03) 3 месяца назад, **When** P3/P4, **Then** письмо без скидки.
8. **Given** отмена 60 дней назад, eligible, **When** фоновая задача, **Then** P5 со скидкой 50% (финальное).
9. **Given** P1 уже отправлен, **When** фоновая задача повторно, **Then** дубликат P1 не отправлен.
10. **Given** пользователь отписался от win-back после P2, **When** наступает день P3, **Then** P3 не отправляется.
11. **Given** пользователь кликнул скидочную ссылку в P3, скидка ещё действует, **When** оформляет подписку, **Then** скидка применена.
12. **Given** пользователь пришёл из trial win-back (D03), конвертировался, затем отменил платную подписку, **When** win-back paid, **Then** получает серию P1-P5.

---

## E) Acceptance Criteria

- [ ] P1 отправляется через 1 день после отмены с персонализированным прогрессом
- [ ] P2-P5 отправляются по расписанию
- [ ] P3/P4/P5 содержат скидку, если пользователь eligible (C07)
- [ ] Письмо без скидки, если пользователь не eligible
- [ ] Пользователи с активной подпиской / на паузе исключаются
- [ ] Идемпотентность: дубликаты не отправляются
- [ ] Отписка от серии работает
- [ ] Скидки действуют 7 дней

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `winback_email_sent` | user_id, email_number, type: "paid", has_discount |
| `winback_email_opened` | user_id, email_number |
| `winback_email_clicked` | user_id, email_number |
| `winback_converted` | user_id, email_number, plan_type, discount_used |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Данные о прогрессе пользователя доступны для персонализации
- Логика аналогична D03, отличия в расписании, скидках и персонализации
- Email-инфраструктура уже существует

### Риски
- Персонализация P1 с прогрессом может быть неточной (кеширование)
- Большие скидки (50% в P5) могут создать нежелательный прецедент → мониторинг конверсий по каждому письму

---

## H) Open questions для CTO/разработчиков

1. Нужно ли разделять win-back серию для разных тарифов (месячный vs мультимесячный)?
2. Как кешировать данные о прогрессе для P1: при отмене подписки или при отправке?
3. Нужно ли менять скидку в зависимости от tenure (стажа) пользователя?
4. Как обрабатывать ситуацию: пользователь отменил подписку, получил P3, не использовал, затем снова подписался и снова отменил — новая серия?
5. Нужно ли ограничивать количество win-back серий на пользователя (max N серий за всё время)?
6. Как таргетировать скидку на конкретный тариф: через промокод, специальную ссылку, или автоматически?
7. Нужно ли показывать прогресс (P1) только по завершённым навыкам или по всем начатым?
8. Как обрабатывать ситуацию: пользователь вернулся из win-back со скидкой, но выбрал другой тариф (не 3-мес)?
9. Нужна ли координация между D03 и D04: если пользователь сначала trial, потом paid, какая серия?
10. Какой максимальный % скидки допустим (50% в P5 — это максимум)?
11. Нужно ли в P1 показывать «что вы пропустите» (новые навыки, обновления)?
12. Как отслеживать ROI каждого письма серии: UTM-метки, промокоды, или внутренний tracking?

---

## I) Что убрано из исходника

- **Ruby-код** (аналогичный D03: `WinBackPaidJob`) → заменён на бизнес-правила и расписание
- **Конкретные имена сервисов и классов** → заменены на описание логики
- **ASCII-шаблон** персонализации P1 → заменён на описание данных
- **Конкретные цены со скидкой** → заменены на формулировку «со скидкой X%»
