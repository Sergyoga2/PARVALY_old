# TASK-D01: Пауза подписки — backend

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D01 |
| Title | Пауза подписки: 30 дней, лимит 1 раз / 6 месяцев |
| Phase | D — Retention |
| Priority | P1 |

---

## A) Краткое описание

Реализовать паузу подписки как альтернативу полной отмене. Пользователь приостанавливает рекуррентные списания на 30 дней. Через 30 дней — автоматическое возобновление и списание. Из документации CloudPayments: провайдер **нативно поддерживает статус Paused** для подписок.

---

## B) Scope / Out of Scope

### Scope
- Постановка подписки на паузу (30 дней)
- Досрочное возобновление (resume)
- Автоматическое возобновление через 30 дней (фоновая задача)
- Приостановка рекуррента у провайдера
- Лимит: 1 пауза / 6 месяцев
- Отмена из состояния паузы
- Напоминание за 3 дня до возобновления

### Out of Scope
- Read-only доступ к контенту (D02)
- Pause emails (D05)
- UI (интегрируется с C02)

---

## C) Бизнес-правила и состояния

### Правила паузы
- Доступна только для ACTIVE подписок
- Длительность: 30 дней
- Лимит: 1 пауза за 6 месяцев (счётчик сбрасывается через 6 мес после последней паузы)
- При паузе рекуррент приостанавливается у провайдера — **из документации CloudPayments: нативный статус Paused**

### Досрочное возобновление (resume)
- Пользователь может возобновить подписку до окончания 30 дней
- При resume: списание за новый период, создание нового рекуррента
- Если оплата при resume не прошла — ошибка, подписка остаётся на паузе

### Автоматическое возобновление
- Через 30 дней: фоновая задача возобновляет подписку
- Если оплата не прошла → GRACE_PERIOD → retry (логика B07)

### Отмена из паузы
- Пользователь может отменить подписку во время паузы
- Если есть оставшийся оплаченный период → доступ до его конца
- Если нет → сразу EXPIRED

---

## D) Пользовательские и системные сценарии

1. **Given** active подписка, пауз = 0, **When** pause, **Then** статус = PAUSED, рекуррент приостановлен, пауза = 30 дней.
2. **Given** paused подписка, **When** 30 дней прошли, **Then** auto-resume, списание, статус = ACTIVE.
3. **Given** paused подписка, **When** досрочный resume, **Then** списание, статус = ACTIVE, новый период.
4. **Given** paused подписка, **When** cancel, **Then** статус = CANCELLED/EXPIRED.
5. **Given** pause_count = 1 (за последние 6 мес), **When** попытка паузы, **Then** ошибка «лимит».
6. **Given** last_pause > 6 мес назад, **When** проверяем, **Then** пауза доступна.
7. **Given** пауза за 1 день до renewal, **When** pause, **Then** рекуррент приостанавливается, renewal не происходит.
8. **Given** auto-resume: платёж не прошёл, **When** обрабатываем, **Then** GRACE_PERIOD → retry.
9. **Given** resume + cancel в один день, **When** обрабатываем, **Then** оплата прошла, доступ до конца нового периода.
10. **Given** приостановка рекуррента у провайдера не удалась, **When** pause, **Then** rollback, подписка остаётся ACTIVE.
11. **Given** два одновременных запроса на паузу, **When** обрабатываются, **Then** только один успешен.
12. **Given** paused подписка, **When** напоминание за 3 дня, **Then** email отправлен.

---

## E) Acceptance Criteria

- [ ] Пауза на 30 дней: статус PAUSED, рекуррент приостановлен у провайдера
- [ ] Auto-resume через 30 дней с успешным списанием
- [ ] Досрочный resume с успешным списанием
- [ ] Лимит 1 пауза / 6 мес
- [ ] Отмена из паузы корректна
- [ ] Auto-resume с неуспешной оплатой → GRACE_PERIOD
- [ ] Напоминание за 3 дня до resume
- [ ] Rollback при ошибке провайдера

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `subscription_paused` | user_id, plan_months |
| `subscription_pause_resumed_auto` | user_id |
| `subscription_pause_resumed_early` | user_id, days_remaining |
| `subscription_pause_then_cancel` | user_id |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Провайдер поддерживает нативный статус Paused — **подтверждено из документации CloudPayments**
- Токен карты сохраняется после паузы — **из документации CloudPayments: токен привязан к карте, не к подписке** (нужно подтвердить в sandbox)
- При resume возможно создание новой подписки по сохранённому токену

### Риски
- Токен карты может не работать после паузы → тестировать в sandbox
- Auto-resume при неуспешной оплате требует grace period логику (B07)

---

## H) Open questions для CTO/разработчиков

1. Как приостановить подписку у провайдера: использовать нативный статус Paused или cancel + recreate?
2. Как реализовать auto-resume: фоновая задача по расписанию, отложенная задача при создании паузы, или другой механизм?
3. Нужно ли при resume создавать НОВУЮ подписку у провайдера или возобновлять приостановленную?
4. Как хранить счётчик пауз и дату последней паузы?
5. Как сбрасывать счётчик пауз: фоновая задача или проверка при каждом запросе?
6. Нужна ли admin-возможность принудительно resume или отменить паузу?
7. Что происходит с оплаченным периодом при паузе: он «замораживается» или продолжает течь?
8. При auto-resume: какой тариф используется (текущий на момент паузы)?
9. Нужен ли webhook от провайдера при изменении статуса подписки на Paused?
10. Как обрабатывать ситуацию, когда пользователь на паузе изменил карту?
11. Нужна ли возможность продлить паузу (например, на ещё 30 дней)?
12. Как считать tenure (стаж подписки): включать ли период паузы?

---

## I) Что убрано из исходника

- **Ruby-код** (`PauseService`, `ResumeService`, `PauseExpirationJob`, `CancelFromPauseService`, `PauseCountResetJob`) → заменён на бизнес-правила
- **Конкретные API endpoints** (`POST /api/subscriptions/{id}/pause`, `resume`, `cancel`) → заменены на описание
- **CloudPayments API calls** (`CloudPaymentsClient.update_subscription`, `charge_saved_card`) → заменены на «взаимодействие с провайдером»
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
