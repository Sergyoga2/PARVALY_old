# TASK-D02: Read-only доступ к контенту во время паузы

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D02 |
| Title | Read-only доступ к пройденным урокам во время паузы |
| Phase | D — Retention |
| Priority | P1 |

---

## A) Краткое описание

Во время паузы подписки пользователь сохраняет связь с платформой: может просматривать пройденные уроки, свои решения, заметки. Это повышает вероятность возобновления. Полная блокировка доступа снижает мотивацию к возврату. Реализуется read-only режим доступа к контенту для подписок в статусе PAUSED.

---

## B) Scope / Out of Scope

### Scope
- Read-only режим для подписок в статусе PAUSED
- Разрешено: просмотр теории пройденных уроков, своих решений
- Заблокировано: доступ к новым урокам, сдача заданий, начало новых навыков
- Баннер «Подписка на паузе» на страницах контента
- Сообщение на заблокированных (непройденных) уроках с CTA «Возобновить»
- Отображение состояния паузы в личном кабинете (прогресс, кнопки resume/cancel)

### Out of Scope
- Pause backend (D01)
- Pause email серия (D05)
- Дизайн-макеты (совместно с дизайн-командой)

---

## C) Бизнес-правила и состояния

### Правила доступа по статусам подписки

| Действие | ACTIVE / TRIAL / GRACE_PERIOD | PAUSED | CANCELLED (период не истёк) | EXPIRED / нет подписки |
|----------|:---:|:---:|:---:|:---:|
| Просмотр пройденного урока (теория) | Да | **Да (read-only)** | Да | Нет |
| Сдача задания | Да | **Нет** | Да | Нет |
| Начало нового навыка | Да | **Нет** | Да | Нет |
| Доступ к непройденному уроку | Да | **Нет** | Да | Нет |
| Просмотр своих решений | Да | **Да** | Да | Нет |

### Определение «пройденного» урока
- Урок считается доступным в read-only, если пользователь его завершил ИЛИ начал (есть прогресс)
- Урок, который пользователь никогда не открывал — заблокирован

### UI-элементы при паузе
- Баннер на каждой странице контента: информация о паузе + CTA «Возобновить»
- На заблокированных уроках: сообщение «Урок недоступен во время паузы» + CTA «Возобновить подписку»
- В ЛК: дата окончания паузы, прогресс (уроки пройдено, навыки в процессе), кнопки «Возобновить» и «Отменить подписку»

---

## D) Пользовательские и системные сценарии

1. **Given** подписка на паузе, **When** пользователь открывает пройденный урок, **Then** теория доступна для чтения, задание отображается в read-only режиме.
2. **Given** подписка на паузе, **When** пользователь открывает непройденный урок, **Then** урок заблокирован, отображается CTA «Возобновить подписку».
3. **Given** подписка на паузе, **When** пользователь пытается сдать задание в пройденном уроке, **Then** кнопка «Отправить» заблокирована, появляется подсказка.
4. **Given** подписка на паузе, **When** пользователь пытается начать новый навык, **Then** действие заблокировано с сообщением и CTA.
5. **Given** подписка на паузе, **When** пользователь открывает любую страницу контента, **Then** вверху отображается баннер «Подписка на паузе».
6. **Given** подписка на паузе, **When** пользователь открывает личный кабинет, **Then** видит прогресс (уроки, навыки), дату окончания паузы, кнопки «Возобновить» и «Отменить».
7. **Given** подписка на паузе, **When** пользователь просматривает список своих решений, **Then** решения доступны для просмотра.
8. **Given** подписка возобновлена (resume), **When** пользователь открывает ранее заблокированный урок, **Then** урок доступен полностью (режим read-only снят).
9. **Given** подписка на паузе, **When** пользователь нажимает CTA «Возобновить» в баннере, **Then** инициируется процесс досрочного возобновления (D01).
10. **Given** подписка на паузе, урок начат но не завершён, **When** пользователь открывает урок, **Then** теория доступна, задание в read-only.
11. **Given** подписка на паузе, **When** пользователь пытается получить доступ к контенту через прямую ссылку на непройденный урок, **Then** заблокировано с корректным сообщением.
12. **Given** подписка на паузе, **When** пользователь нажимает «Отменить подписку» в ЛК, **Then** инициируется отмена из паузы (D01).

---

## E) Acceptance Criteria

- [ ] Пройденные/начатые уроки доступны для чтения при PAUSED статусе
- [ ] Непройденные уроки заблокированы при PAUSED статусе
- [ ] Сдача заданий заблокирована при PAUSED статусе
- [ ] Начало новых навыков заблокировано при PAUSED статусе
- [ ] Баннер «Подписка на паузе» отображается на страницах контента
- [ ] Заблокированные уроки показывают CTA «Возобновить подписку»
- [ ] ЛК корректно отображает: прогресс, дату окончания паузы, кнопки resume/cancel
- [ ] После возобновления подписки read-only режим полностью снимается

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `paused_content_accessed` | user_id, lesson_id, type: "completed_lesson" |
| `paused_content_blocked` | user_id, lesson_id, type: "new_lesson" |
| `paused_resume_cta_clicked` | user_id, source: "content_page" / "lk" / "banner" |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Система хранит информацию о прогрессе пользователя (пройденные уроки, начатые навыки)
- Баннер и блокировки не требуют серверного рендеринга (можно реализовать на клиенте по статусу подписки)

### Риски
- Неоднозначность «пройденного» урока: нужно чёткое определение (завершён vs начат)
- Кеширование доступа: при смене статуса подписки read-only режим должен применяться немедленно

---

## H) Open questions для CTO/разработчиков

1. Как определить «пройденный» урок: только завершённые или также начатые (с частичным прогрессом)?
2. Нужно ли кешировать права доступа или проверять статус подписки при каждом запросе?
3. Как реализовать баннер: серверный компонент или клиентский, основанный на статусе из API?
4. Нужно ли ограничивать количество обращений к пройденным урокам (rate limiting)?
5. Как обрабатывать ситуацию, когда пользователь был на середине задания при постановке на паузу?
6. Нужно ли показывать прогресс по навыкам (процент завершения) в ЛК при паузе?
7. Как обрабатывать API-запросы к заблокированному контенту: HTTP 403 с описательным сообщением?
8. Нужно ли скрывать заблокированные уроки или показывать их с визуальной блокировкой?
9. Как обрабатывать смену статуса в реальном времени (например, пользователь на странице урока, подписка возобновилась)?
10. Нужен ли отдельный API endpoint для получения списка доступных уроков при паузе?
11. Как обрабатывать просмотр заметок пользователя: доступны все или только к пройденным урокам?
12. Нужно ли логировать попытки доступа к заблокированному контенту (для аналитики)?

---

## I) Что убрано из исходника

- **Ruby-код** (`AccessService.can_access_lesson?`, `can_submit_assignment?`, `can_start_new_skill?`) → заменён на бизнес-правила доступа
- **Конкретная логика проверки** (`user.completed_lesson?(lesson)`, `user.started_lesson?(lesson)`) → заменена на описание правил
- **ASCII wireframes** (баннер паузы, заблокированный урок, ЛК paused state) → заменены на описание UI-элементов
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
