# TASK-D06: Антифрод — мониторинг trial abuse

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D06 |
| Title | Антифрод дашборд и мониторинг trial abuse |
| Phase | D — Retention |
| Priority | P2 |

---

## A) Краткое описание

Мониторинг масштаба злоупотреблений trial: пользователи создают множество аккаунтов для повторного использования бесплатного периода. V1: дашборд с метриками abuse и алерты для команды. Без автоматических блокировок — только информирование и ручной анализ.

---

## B) Scope / Out of Scope

### Scope
- Расширенное логирование при активации trial: IP, user agent, данные карты (маскированные), email-домен
- Дашборд: trial активации по IP, по карте, по email-домену
- Алерт: > 5 trial с одного IP за 24 часа
- Алерт: одна карта на > 2 аккаунтах за 30 дней
- Топ email-доменов по количеству trial

### Out of Scope
- Автоматическая блокировка пользователей
- Device fingerprinting
- Admin-панель для ручной блокировки
- Автоматические меры противодействия

---

## C) Бизнес-правила и состояния

### Данные для логирования (при каждой активации trial)
- Идентификатор пользователя
- IP-адрес
- User Agent
- Последние 4 цифры карты + дата истечения (маскированные данные)
- Email и email-домен
- Дата и время активации

### Дашборд

**Trial по IP (последние 7 дней):**
- IP-адрес, количество trial, количество уникальных пользователей
- Фильтр: только IP с > 3 trial

**Trial по карте (последние 30 дней):**
- Маскированные данные карты, количество аккаунтов
- Фильтр: только карты с > 1 аккаунтом

**Trial по email-домену (последние 30 дней):**
- Домен, количество trial
- Топ-20 по количеству

### Алерты

| Условие | Порог | Действие |
|---------|-------|----------|
| Trial с одного IP за 24ч | > 5 | Уведомление команде |
| Одна карта на нескольких аккаунтах за 30 дней | > 2 | Уведомление команде |

### Принцип V1
- Только информирование, без автоматических блокировок
- Алерты = уведомления для команды для ручного анализа
- Дашборд = визуализация для регулярного мониторинга

---

## D) Пользовательские и системные сценарии

1. **Given** 6 trial активаций с одного IP за 24 часа, **When** фоновая задача алертов, **Then** уведомление отправлено команде.
2. **Given** одна карта (last4 + exp) на 3 аккаунтах, **When** фоновая задача алертов, **Then** уведомление отправлено.
3. **Given** trial активирован, **When** логирование, **Then** IP, user agent, маскированные данные карты записаны.
4. **Given** 2 trial с одного IP за 24 часа, **When** фоновая задача, **Then** алерт НЕ срабатывает (порог не достигнут).
5. **Given** одна карта на 2 аккаунтах, **When** фоновая задача, **Then** алерт НЕ срабатывает (порог 2, нужно > 2).
6. **Given** 10 trial с домена @tempmail.com, **When** дашборд, **Then** домен отображается в топе.
7. **Given** алерт по IP сработал, **When** команда проверяет, **Then** видит список аккаунтов, trial-даты, email.
8. **Given** корпоративный IP (офис), 6 trial за 24ч, **When** алерт, **Then** false positive — команда анализирует вручную.
9. **Given** карта last4=1234 + exp=12/27 на 3 аккаунтах, другая карта last4=1234 + exp=06/28 на 1 аккаунте, **When** алерт, **Then** алерт только для первой (комбинация last4 + exp).
10. **Given** trial активирован без IP (edge case), **When** логирование, **Then** запись создана с пустым IP, ошибки нет.

---

## E) Acceptance Criteria

- [ ] При каждой trial-активации записываются: IP, user agent, маскированные данные карты, email-домен
- [ ] Алерт срабатывает при > 5 trial с одного IP за 24ч
- [ ] Алерт срабатывает при одной карте на > 2 аккаунтах за 30 дней
- [ ] Дашборд показывает trial по IP, по карте, по email-домену
- [ ] Автоматических блокировок нет (V1 — только мониторинг)
- [ ] Алерты отправляются команде (email/мессенджер)

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `trial_abuse_alert_triggered` | alert_type (ip/card), threshold, value |
| `trial_audit_log_created` | user_id, ip_address, email_domain |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Данные IP и user agent доступны при активации trial
- Маскированные данные карты (last4 + exp) доступны из callback платёжного провайдера
- Комбинация last4 + exp_date достаточна для идентификации карты (не 100%, но приемлемо для V1)

### Риски
- False positives: shared IP (офис, университет, VPN) → алерты только информационные, нет автоблокировок
- Collision по last4: разные карты с одинаковыми last4 → комбинация с exp_date снижает вероятность
- Хранение IP-адресов может иметь юридические ограничения (GDPR и аналоги)

---

## H) Open questions для CTO/разработчиков

1. Как реализовать дашборд: встроенный в admin-панель, BI-инструмент, или запросы к хранилищу?
2. Как часто запускать фоновую задачу алертов: каждый час, каждые 15 минут?
3. Куда отправлять алерты: email, мессенджер (Slack/Telegram), внутренняя система?
4. Нужно ли хранить IP-адреса в отдельном хранилище (с учётом требований по персональным данным)?
5. Как долго хранить логи trial-активаций: 30 дней, 90 дней, бессрочно?
6. Нужно ли учитывать IPv6 при группировке по IP (подсети вместо точного адреса)?
7. Нужен ли порог по email-домену (> N trial с одного домена за период)?
8. Как обрабатывать ситуацию, когда одна карта привязана к нескольким аккаунтам легитимно (семья)?
9. Нужно ли интегрировать антифрод с ограничением trial (B09)?
10. Какие данные показывать в алерте: полный список аккаунтов, email, даты?
11. Нужна ли метрика «estimated revenue loss from abuse» на дашборде?
12. Как обрабатывать VPN/proxy IP: игнорировать в алертах или отдельный порог?
13. Нужно ли V2 планировать заранее (автоблокировка)? Какие критерии для перехода к V2?

---

## I) Что убрано из исходника

- **Ruby-код** (`TrialAuditLog.create!`, `TrialAbuseAlertJob`, `AdminNotifier`) → заменён на бизнес-правила
- **SQL-запросы** для дашборда (GROUP BY ip_address, card_last4) → заменены на описание метрик
- **Конкретные поля модели** (`ip_address`, `user_agent`, `card_last4`, `card_exp`, `email_domain`) → заменены на описание данных для логирования
- **Конкретное расписание job** → вынесено в Open Questions
