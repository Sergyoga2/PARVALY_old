# TASK-D08: Upgrade Flow — переход на более длительный тариф

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-D08 |
| Title | Upgrade: переход с короткого тарифа на более длинный |
| Phase | D — Retention |
| Priority | P1 |

---

## A) Краткое описание

Дать подписчику возможность перейти на более длинный (и более выгодный per month) тариф. Доступно только для активных подписок с переходом на тариф с бо́льшим количеством месяцев. Upgrade выполняется атомарно: отмена текущего рекуррента + оплата нового тарифа + создание нового рекуррента — в одной транзакции. Остаток текущего периода «дарится» пользователю (без пересчёта).

---

## B) Scope / Out of Scope

### Scope
- UI: предложение upgrade в личном кабинете (для подписчиков с коротким тарифом)
- Backend: атомарный upgrade (отмена текущего + оплата нового + создание нового рекуррента)
- Остаток текущего периода «дарится» (не пересчитывается)
- Новый период начинается с момента оплаты upgrade
- Rollback при ошибке оплаты (текущая подписка не изменена)

### Out of Scope
- Downgrade (переход с длинного на короткий тариф)
- Pro-rata пересчёт (пропорциональный возврат за неиспользованный период)
- Upgrade из состояния PAUSED, GRACE_PERIOD, CANCELLED

---

## C) Бизнес-правила и состояния

### Правила upgrade
- Доступен только для подписок в статусе ACTIVE
- Только на тариф с бо́льшим количеством месяцев (1 → 3, 3 → 6, 6 → 12, 1 → 6, и т.д.)
- Нельзя выбрать тот же тариф
- При upgrade на 12-мес тариф — upgrade далее недоступен (нет более длинного)
- Остаток текущего оплаченного периода не пересчитывается

### Доступность upgrade по тарифам

| Текущий тариф | Доступные upgrade |
|:---:|---|
| 1 мес | 3, 6, 12 мес |
| 3 мес | 6, 12 мес |
| 6 мес | 12 мес |
| 12 мес | Upgrade недоступен |

### Процесс upgrade
1. Пользователь выбирает новый тариф
2. Отменяется текущий рекуррент у провайдера
3. Списывается полная стоимость нового тарифа
4. Создаётся новый рекуррент с соответствующим интервалом
5. Подписка обновляется: новый тариф, новый период, новая дата следующего списания

### Rollback при ошибке
- Если оплата не прошла → текущая подписка не изменяется
- Если рекуррент у провайдера уже отменён, но оплата не прошла → восстановить рекуррент
- Весь процесс должен быть атомарным

### UI в личном кабинете
- Блок «Сэкономьте до 38%» для подписчиков на коротких тарифах
- Показ: тариф, цена/мес, общая экономия
- Рекомендация оптимального тарифа (6 мес по умолчанию)

---

## D) Пользовательские и системные сценарии

1. **Given** месячный подписчик, **When** upgrade на 6 мес, **Then** списана полная стоимость 6-мес тарифа, период = 6 мес, старый рекуррент отменён, новый создан.
2. **Given** 6-мес подписчик, **When** upgrade на 12 мес, **Then** списана полная стоимость 12-мес тарифа.
3. **Given** 12-мес подписчик, **When** открывает ЛК, **Then** блок upgrade не отображается.
4. **Given** оплата за upgrade не прошла (недостаточно средств), **When** ошибка, **Then** текущая подписка не изменена (rollback).
5. **Given** месячный подписчик, 15 дней до конца периода, **When** upgrade, **Then** остаток 15 дней «подарен», новый период = 6 мес с текущей даты.
6. **Given** подписчик на паузе, **When** пытается upgrade, **Then** upgrade недоступен.
7. **Given** подписчик в grace period, **When** пытается upgrade, **Then** upgrade недоступен.
8. **Given** два одновременных запроса на upgrade, **When** обрабатываются, **Then** только один успешен, второй — ошибка.
9. **Given** подписчик выбирает тот же тариф, **When** пытается «upgrade», **Then** ошибка «Выберите другой тариф».
10. **Given** рекуррент отменён у провайдера, но оплата нового тарифа не прошла, **When** rollback, **Then** рекуррент восстанавливается.
11. **Given** 3-мес подписчик, **When** видит блок upgrade, **Then** отображаются варианты 6 мес и 12 мес с ценами и экономией.
12. **Given** успешный upgrade, **When** ЛК, **Then** отображается новый тариф, новая дата продления.

---

## E) Acceptance Criteria

- [ ] Upgrade доступен только для ACTIVE подписок
- [ ] Upgrade только на тариф с бо́льшим количеством месяцев
- [ ] При upgrade списывается полная стоимость нового тарифа
- [ ] При ошибке оплаты — текущая подписка не изменена (rollback)
- [ ] 12-мес подписчики не видят предложение upgrade
- [ ] Блок upgrade в ЛК показывает доступные тарифы с ценами и экономией
- [ ] Race condition: параллельные запросы — только один проходит
- [ ] ЛК обновляется после upgrade: новый тариф, дата, статус

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `subscription_upgraded` | user_id, from_plan, to_plan, amount |
| `upgrade_cta_viewed` | user_id, current_plan |
| `upgrade_cta_clicked` | user_id, target_plan |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Upgrade реализуется как «отмена + новая покупка» (нет нативного механизма upgrade у провайдера)
- Остаток периода не пересчитывается (бизнес-решение «подарить»)
- Токен карты сохраняется и может быть использован для нового рекуррента

### Риски
- Rollback при ошибке: если рекуррент уже отменён у провайдера, восстановление может быть невозможно → тестировать в sandbox
- Race condition при параллельных запросах → обеспечить уникальность на уровне хранилища
- Токен карты может не работать для нового рекуррента → тестировать в sandbox

---

## H) Open questions для CTO/разработчиков

1. Как обеспечить атомарность upgrade: операция «отмена + оплата + создание» в одной транзакции или saga-паттерн?
2. Можно ли восстановить рекуррент у провайдера после отмены (для rollback)?
3. Нужно ли показывать пользователю confirmation step перед upgrade («Вы уверены?»)?
4. Как обрабатывать 3D Secure при upgrade: inline виджет или redirect?
5. Нужен ли email-уведомление о successful upgrade?
6. Как рассчитывать «экономию» в UI: по сравнению с месячным тарифом или с текущим?
7. Нужно ли показывать upgrade-предложение в cancellation flow (C04)?
8. Как обрабатывать ситуацию: upgrade прошёл, но через минуту пользователь хочет отменить?
9. Нужно ли ограничивать количество upgrade в период (например, max 1 upgrade за тариф)?
10. Как считать дату следующего списания: от момента upgrade или от начала нового тарифного периода?
11. Нужно ли предлагать upgrade в email-уведомлениях (T6 в B06, P3 в D04)?
12. Как обрабатывать upgrade при предстоящем renewal (менее 24ч до списания)?

---

## I) Что убрано из исходника

- **Ruby-код** (`UpgradeService.upgrade`, `ActiveRecord::Base.transaction`) → заменён на бизнес-правила процесса upgrade
- **Конкретные вызовы API провайдера** (`CloudPaymentsClient.cancel_subscription`, `charge_saved_card`, `create_subscription`) → заменены на описание шагов
- **ASCII wireframe** блока upgrade в ЛК → заменён на описание UI-элементов
- **Конкретные цены** (17 400 ₽, 28 800 ₽) → заменены на формулировку «полная стоимость тарифа»
- **Конкретные поля модели** → заменены на описание обновления подписки
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
