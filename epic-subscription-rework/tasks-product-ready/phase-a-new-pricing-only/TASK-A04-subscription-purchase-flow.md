# TASK-A04: Покупка нового тарифа (Purchase Flow)

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-A04 |
| Title | End-to-end flow покупки нового тарифа |
| Phase | A — New Pricing |
| Priority | P0 |

---

## A) Краткое описание

Связать страницу тарифов с модулем биллинга: пользователь выбирает тариф → вводит данные карты → оплачивает → получает доступ. Это основной happy path для новых подписчиков. Включает страницу оформления (checkout), страницу подтверждения и отображение активной подписки в личном кабинете.

---

## B) Scope / Out of Scope

### Scope
- Checkout flow: выбор тарифа → ввод карты через виджет провайдера → оплата → подтверждение
- Интеграция с платёжным виджетом провайдера для ввода карты (из документации CloudPayments: виджет поддерживает inline 3D Secure)
- Создание подписки через модуль биллинга (A02)
- Страница подтверждения: «Подписка оформлена», тариф, дата окончания, дата следующего списания
- Обработка ошибок оплаты (показ пользователю)
- Обновление личного кабинета: активная подписка с деталями
- Обязательное согласие с офертой и условиями автопродления

### Out of Scope
- Trial (Phase B)
- Upgrade с одного тарифа на другой (D08)
- Cancellation (Phase C)

---

## C) Бизнес-правила и состояния

### Валидации
- Пользователь должен быть авторизован
- У пользователя нет активной подписки (статус ACTIVE, TRIAL, GRACE_PERIOD, PAUSED)
- Тариф существует и доступен для новых подписок
- Согласие с офертой обязательно

### Доступность покупки по состояниям

| Состояние | Покупка доступна | Поведение |
|-----------|:---:|---|
| Неавторизованный | Нет | Redirect на регистрацию → возврат на checkout |
| Нет подписки | Да | Стандартный checkout |
| Active подписка | Нет | «У вас уже есть подписка» |
| Cancelled (доступ есть) | Да | Новая подписка, начнётся после текущего периода |
| Expired | Да | Стандартный checkout |

### Checkout page
- Выбранный тариф: название, цена/мес, общая стоимость
- Дата следующего списания
- Виджет ввода карты
- Чекбокс согласия с офертой (обязателен)
- Кнопка «Оплатить [сумма]»

### Страница подтверждения
- Тариф, срок действия, дата следующего списания
- CTA «Начать обучение» → каталог навыков

### Личный кабинет
- Тариф, цена, статус, дата продления, кнопка отмены

---

## D) Пользовательские и системные сценарии

1. **Given** авторизованный пользователь без подписки, **When** выбирает тариф 6 мес и оплачивает, **Then** подписка создана, доступ открыт, период = 6 мес.

2. **Given** авторизованный пользователь с active подпиской, **When** пытается оформить ещё одну, **Then** ошибка «У вас уже есть подписка».

3. **Given** оплата не прошла (недостаточно средств), **When** провайдер возвращает ошибку, **Then** пользователь видит сообщение об ошибке, подписка НЕ создана.

4. **Given** пользователь не согласился с офертой, **When** нажимает «Оплатить», **Then** кнопка заблокирована или ошибка валидации.

5. **Given** неавторизованный пользователь, **When** нажимает «Оформить» на тарифе, **Then** redirect на регистрацию → после регистрации возврат на checkout.

6. **Given** 3D Secure требуется банком-эмитентом, **When** пользователь проходит верификацию, **Then** виджет обрабатывает inline, оплата проходит.

7. **Given** пользователь закрыл страницу во время оплаты, **When** callback от провайдера приходит, **Then** подписка создаётся в фоновом режиме.

8. **Given** два одновременных запроса на покупку от одного пользователя, **When** обрабатываются, **Then** только один создаёт подписку, второй — ошибка.

9. **Given** пользователь с cancelled подпиской (доступ ещё есть), **When** покупает новый тариф, **Then** новая подписка создаётся, старая завершается корректно.

10. **Given** пользователь на странице подтверждения, **When** видит результат, **Then** отображается тариф, дата окончания, дата следующего списания, CTA «Начать обучение».

---

## E) Acceptance Criteria

- [ ] Полный flow: pricing page → checkout → оплата → подтверждение → ЛК показывает подписку
- [ ] Пользователь с active подпиской не может оформить новую
- [ ] Ошибка оплаты корректно отображается пользователю
- [ ] Без согласия с офертой оплата невозможна
- [ ] Неавторизованный пользователь перенаправляется на регистрацию с возвратом
- [ ] 3D Secure обрабатывается inline в виджете провайдера
- [ ] Параллельные запросы на покупку от одного пользователя: только один проходит
- [ ] ЛК отображает: тариф, цена, статус, дата продления, кнопка отмены

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `checkout_started` | user_id, plan_id, plan_months |
| `checkout_payment_attempted` | user_id, plan_id |
| `subscription_started` | user_id, plan_id, plan_months, amount, source: "direct" |
| `checkout_error` | user_id, plan_id, error_code |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Виджет провайдера поддерживает inline 3D Secure — **подтверждено из документации CloudPayments**
- 3D Secure применяется только при первом платеже, не при рекуррентных — **подтверждено из документации CloudPayments**
- Пользователь с cancelled подпиской может оформить новую до окончания текущего периода

### Риски
- Виджет провайдера может конфликтовать с текущим frontend → тестировать на staging заранее
- Race condition при параллельных запросах → обеспечить уникальность на уровне хранилища

---

## H) Open questions для CTO/разработчиков

1. Как реализовать checkout: отдельная страница, модальное окно, или inline на pricing page?
2. Как обрабатывать ситуацию, когда пользователь с cancelled подпиской покупает новый тариф: новый период начинается сразу или после окончания текущего?
3. Нужно ли подтверждение email перед покупкой?
4. Как обеспечить защиту от двойной покупки (два таба, два клика)?
5. Нужно ли хранить согласие с офертой (дата, версия оферты)?
6. Куда вести пользователя после регистрации: обратно на checkout или на pricing page?
7. Как интегрировать виджет провайдера: стандартный iframe, кастомная форма, или redirect?
8. Нужен ли email-чек (кассовый чек) после оплаты?
9. Как отображать состояние «оплата в процессе» (waiting for callback)?
10. Нужна ли поддержка нескольких валют или только RUB?

---

## I) Что убрано из исходника

- **JavaScript-код инициализации CloudPayments Widget** (`new cp.CloudPayments()`, параметры `publicTerminalId`, `tokenize`, `recurrent`) → заменён на «интеграция с виджетом провайдера»
- **Конкретный API endpoint** (`POST /api/subscriptions`) → заменён на требование checkout flow
- **Request/Response JSON-структуры** → заменены на описание данных на страницах
- **ASCII wireframe** checkout и success page → заменены на описание элементов
- **Test Cases (Unit / Integration / E2E)** → трансформированы в Acceptance Criteria и сценарии
