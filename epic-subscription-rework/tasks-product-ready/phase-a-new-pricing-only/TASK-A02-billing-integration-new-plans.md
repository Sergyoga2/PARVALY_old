# TASK-A02: Интеграция с платёжным провайдером для новых тарифов

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-A02 |
| Title | Интеграция с платёжным провайдером для мультимесячных рекуррентных подписок |
| Phase | A — New Pricing |
| Priority | P0 |

---

## A) Краткое описание

Настроить модуль биллинга для создания и управления рекуррентными подписками с интервалами 1/3/6/12 месяцев через платёжного провайдера. Это ядро платёжной системы: создание подписки, обработка входящих уведомлений (webhook) об успешных и неуспешных списаниях, отмена рекуррента, логирование каждой попытки списания.

Задача необходима для того, чтобы пользователи могли оплачивать новые тарифы, а система корректно обрабатывала все платёжные события.

---

## B) Scope / Out of Scope

### Scope
- Создание рекуррентной подписки у провайдера с корректным интервалом (1/3/6/12 мес) — **подтверждено из документации CloudPayments**: поддержка Period=1/3/6/12 с Interval=Month, максимальный интервал 1 год
- Обработка входящих callback-уведомлений от провайдера: успешное списание, неуспешное списание, отмена
- Отмена рекуррентной подписки у провайдера
- Логирование всех попыток списания в хранилище данных
- Абстракция (обёртка) над API провайдера для тестируемости и возможной замены
- Идемпотентная обработка повторных callback-ов (один и тот же callback не обрабатывается дважды)
- Верификация подлинности входящих callback-ов от провайдера

### Out of Scope
- Trial-период (Phase B)
- UI покупки (A04)
- Расширенная retry/grace period логика (B07)

---

## C) Бизнес-правила и состояния

### Создание подписки
- При создании подписки передаётся: токен карты, идентификатор пользователя, сумма, валюта (RUB), интервал и период
- Для каждого тарифа устанавливается свой период рекуррента: 1 мес, 3 мес, 6 мес, 12 мес
- Провайдер возвращает уникальный идентификатор подписки (формат строки, например `sc_XXXXXXXXXXXX` — из документации CloudPayments)

### Обработка callback-ов
- **Успешное списание:** обновить текущий период подписки, создать запись об успешной оплате
- **Неуспешное списание:** создать запись о неуспешной попытке; при этом провайдер самостоятельно выполняет повторные попытки (retry)
- **Отмена:** обновить статус подписки в системе

### Retry-логика (из документации CloudPayments)
- Провайдер сам выполняет повторные попытки: **3 попытки, каждый день, в течение 72 часов**
- После 3 неуспешных попыток провайдер автоматически отменяет подписку
- Поле retry_count в callback-е **отсутствует** — количество попыток нужно считать на стороне приложения

### Идемпотентность
- Callback может прийти дважды; обработка должна быть идемпотентной (по уникальному идентификатору транзакции от провайдера)
- Поддерживается заголовок идемпотентности при отправке запросов к API провайдера (`X-Request-ID` — из документации CloudPayments)

### Безопасность
- Входящие callback-ы должны быть верифицированы (подпись/HMAC от провайдера)
- Callback-эндпоинт должен возвращать HTTP 200 даже при ошибке обработки (чтобы провайдер не пересылал повторно)
- Необработанные данные callback-а логируются для отладки

---

## D) Пользовательские и системные сценарии

1. **Given** новый тариф «квартальный» (3 мес, 9 900 ₽), **When** пользователь оплачивает, **Then** у провайдера создаётся подписка на сумму 9 900 ₽ с периодом 3 мес.

2. **Given** активная подписка, **When** приходит callback об успешном списании, **Then** запись об оплате создана, период подписки обновлён.

3. **Given** активная подписка, **When** приходит callback о неуспешном списании, **Then** запись о неуспешной попытке создана, статус подписки пока не меняется.

4. **Given** callback с идентификатором транзакции, который уже обработан, **When** callback приходит повторно, **Then** повторная обработка пропускается (идемпотентно).

5. **Given** подписка отменена пользователем, **When** выполняется отмена у провайдера, **Then** рекуррент прекращён, дата отмены зафиксирована.

6. **Given** callback с невалидной подписью, **When** обрабатывается, **Then** callback отклоняется, запись в лог безопасности.

7. **Given** callback приходит раньше, чем завершилось создание подписки в системе, **When** обрабатывается, **Then** обработка корректна (race condition учтён).

8. **Given** API провайдера недоступен при создании подписки, **When** запрос отправляется, **Then** выполняются повторные попытки (до 3), затем ошибка пользователю.

9. **Given** сумма в callback-е не совпадает с ценой тарифа, **When** обрабатывается, **Then** создаётся алерт, но обработка выполняется (провайдер — source of truth для сумм).

10. **Given** подписка отменена через панель провайдера (не через наш API), **When** приходит callback об отмене, **Then** статус в системе корректно обновляется.

---

## E) Acceptance Criteria

- [ ] Рекуррентная подписка создаётся у провайдера с корректным интервалом для каждого из 4 тарифов
- [ ] Callback об успешном списании корректно обновляет период подписки и создаёт запись оплаты
- [ ] Callback о неуспешном списании создаёт запись с кодом ошибки
- [ ] Повторный callback с тем же идентификатором транзакции не обрабатывается повторно
- [ ] Подписка успешно отменяется у провайдера при отмене в системе
- [ ] Все callback-ы верифицируются по подписи/HMAC
- [ ] При недоступности API провайдера выполняются повторные попытки с back-off
- [ ] Каждая попытка списания (успешная/неуспешная) логируется в хранилище данных
- [ ] Сырые данные callback-а логируются для отладки

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `subscription_started` | user_id, plan_id, plan_months, amount, source |
| `subscription_renewed` | user_id, plan_id, plan_months, amount |
| `subscription_payment_failed` | user_id, plan_id, attempt_number, error_code |
| `subscription_cancelled` | user_id, plan_id, tenure_months |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Платёжный провайдер поддерживает мультимесячные интервалы нативно — **подтверждено из документации CloudPayments**
- Провайдер сам управляет retry: 3 попытки, 1/день, 72 часа — **подтверждено из документации CloudPayments**
- Идентификатор подписки у провайдера — строка формата `sc_XXXXXXXXXXXX` — **из документации CloudPayments**
- Rate limit: 30 одновременных запросов (production), 5 (test) — **из документации CloudPayments**
- Sandbox (тестовая среда) доступна через отдельный терминал ID — **из документации CloudPayments**

### Риски
- Задержка доставки callback-ов (> 5 мин) — не зависеть от real-time доставки, предусмотреть fallback-проверку
- API провайдера может измениться — абстракция (адаптер) для изоляции от API
- Некорректная сумма в callback-е — алерт + логирование

---

## H) Open questions для CTO/разработчиков

1. Какую архитектуру выбрать для обёртки над API провайдера: адаптер, отдельный сервис, модуль?
2. Как хранить записи об оплатах (billing attempts): отдельная сущность, лог, или иная структура?
3. Каким образом обеспечить атомарность: если callback приходит раньше, чем подписка создана в системе?
4. Нужен ли polling (периодическая проверка статуса подписки у провайдера) как fallback при пропущенных callback-ах?
5. Как обрабатывать ситуацию, когда сумма в callback-е не совпадает с ценой тарифа?
6. Как верифицировать подлинность callback-ов? Какой механизм подписи использовать?
7. Нужен ли отдельный endpoint для callback-ов или они идут на общий?
8. Как обрабатывать HTTP 429 (rate limit) от провайдера?
9. Нужно ли логировать сырые данные callback-ов? Если да — каков срок хранения?
10. Как обеспечить идемпотентность создания подписки при повторном запросе от пользователя?
11. Нужна ли очередь для обработки callback-ов или обработка синхронная?
12. Как считать количество неуспешных попыток (attempt_number), если провайдер не передаёт это поле?

---

## I) Что убрано из исходника

- **Конкретные endpoint-ы CloudPayments** (`POST /subscriptions/create`, `POST /subscriptions/cancel`) → заменены на «создание подписки у провайдера», «отмена подписки у провайдера»
- **Конкретные параметры API** (`Token`, `AccountId`, `Amount`, `Currency`, `Period`, `Interval`) → заменены на описание передаваемых данных
- **Имя класса `BillingService`** и его методы (`create_subscription`, `cancel_subscription`, `process_renewal_webhook`) → заменены на описание функций модуля биллинга
- **Ruby-код** обработки webhook-ов → заменён на бизнес-правила обработки callback-ов
- **Конкретная структура таблицы `billing_attempts`** (UUID, VARCHAR, DECIMAL и т.д.) → заменена на требование «логировать каждую попытку списания»
- **Расширение таблицы `subscriptions`** (конкретные поля `cloudpayments_subscription_id`, `card_token`) → заменено на требование «хранить идентификатор подписки у провайдера и токен карты»
- **Endpoint `/api/webhooks/cloudpayments/recurrent`** → заменён на «endpoint для приёма callback-ов»
- **HMAC конкретная реализация** → заменена на «верификация подлинности callback-ов»
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
