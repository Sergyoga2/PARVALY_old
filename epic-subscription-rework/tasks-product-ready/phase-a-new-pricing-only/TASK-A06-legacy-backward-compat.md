# TASK-A06: Обратная совместимость для legacy-тарифов

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-A06 |
| Title | Обеспечение обратной совместимости для legacy-тарифов |
| Phase | A — New Pricing |
| Priority | P0 |

---

## A) Краткое описание

Гарантировать, что все изменения Phase A не затрагивают текущих подписчиков. Legacy-тарифы (месячный 3 900, годовой 2 900/мес, 3-летний 2 400/мес) должны продолжать работать без изменений: автопродление, доступ к контенту (включая профессии для 3-year), отображение в ЛК.

Задача критична для безопасного релиза Phase A: ни один текущий подписчик не должен заметить изменений.

---

## B) Scope / Out of Scope

### Scope
- Аудит: все места в коде, где используются тарифные планы и подписки — убедиться, что добавление новых полей/тарифов не ломает существующую логику
- Автопродление legacy-тарифов работает корректно после миграции
- ЛК для legacy-подписчиков: текущий тариф + пометка «архивный» + баннер о новых тарифах
- Правила перехода legacy → new: только через отмену текущего и оформление нового
- Документирование поведения legacy-тарифов

### Out of Scope
- Принудительная миграция legacy-подписчиков на новые тарифы
- Изменение цен legacy-тарифов
- Массовые уведомления legacy-подписчикам о новых тарифах

---

## C) Бизнес-правила и состояния

### Legacy-тарифы в ЛК

| Состояние | Отображение |
|-----------|-------------|
| Legacy monthly (active) | «Ежемесячный (архивный)», 3 900 ₽/мес, баннер о новых тарифах |
| Legacy annual (active) | «Годовой (архивный)», 2 900 ₽/мес, баннер |
| Legacy 3-year (active) | «3 года (архивный)», 2 400 ₽/мес, + «включает профессии», баннер |
| Legacy cancelled | Стандартное cancelled-состояние, при переоформлении — только новые |

### Правила перехода
- Legacy-подписчик может посмотреть новые тарифы (баннер в ЛК ведёт на pricing page)
- Для перехода на новый тариф: сообщение «Для перехода необходимо отменить текущий. Текущий тариф будет действовать до [дата]. После этого вы сможете оформить новый.»
- Legacy-подписчик, отменивший подписку, может оформить ТОЛЬКО новые тарифы (legacy недоступны)
- Legacy 3-year подписчик: при отмене и переоформлении на новый тариф — профессии теряются. Необходимо предупреждение.

---

## D) Пользовательские и системные сценарии

1. **Given** legacy monthly подписчик, **When** наступает renewal, **Then** списывается 3 900 ₽, подписка продлена корректно.

2. **Given** legacy annual подписчик, **When** наступает renewal, **Then** списывается 34 800 ₽, подписка продлена.

3. **Given** legacy подписчик, **When** открывает ЛК, **Then** видит «архивный тариф» + баннер о новых тарифах.

4. **Given** legacy подписчик отменил подписку, **When** пытается переоформить, **Then** видит только новые тарифы.

5. **Given** legacy 3-year подписчик, **When** проверяем доступ к профессиям, **Then** профессии доступны.

6. **Given** legacy 3-year подписчик нажимает «Перейти на новый тариф», **When** flow, **Then** видит предупреждение «При переходе вы потеряете доступ к профессиям».

7. **Given** Phase A задеплоен, **When** проверяем все legacy подписки, **Then** ни одна не изменила status/plan/amount.

8. **Given** страница тарифов для покупки, **When** legacy-подписчик открывает, **Then** для покупки доступны только новые тарифы.

9. **Given** legacy-тариф помечен как недоступный для новых покупок, **When** наступает автопродление, **Then** продление проходит успешно (флаг не влияет на renewal).

10. **Given** legacy подписчик нажимает «Посмотреть тарифы» в баннере, **When** переход, **Then** попадает на pricing page с новыми тарифами.

---

## E) Acceptance Criteria

- [ ] Автопродление legacy monthly (3 900 ₽) работает корректно после миграции
- [ ] Автопродление legacy annual (34 800 ₽) работает корректно после миграции
- [ ] Legacy 3-year: доступ к профессиям сохранён
- [ ] ЛК legacy-подписчика: «архивный тариф» + баннер
- [ ] Legacy-подписчик после отмены: видит только новые тарифы
- [ ] Ни одна legacy подписка не изменилась после деплоя Phase A
- [ ] Предупреждение о потере профессий для 3-year подписчиков при переходе

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `legacy_plan_viewed` | user_id, plan_type |
| `legacy_plan_new_plans_cta_clicked` | user_id, plan_type |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Legacy-подписки продолжают работать на тех же условиях у провайдера (сумма, период)
- Провайдер не меняет условия рекуррента без нашего запроса
- Нет механизма мгновенного upgrade: только отмена → оформление нового

### Риски
- Код renewal может проверять флаг «доступен для новых подписок» и заблокировать legacy renewal → аудит кода
- Запросы к тарифам могут не фильтровать по группе (legacy/new), смешивая данные → аудит запросов

---

## H) Open questions для CTO/разработчиков

1. Есть ли в коде места, где проверка «тариф доступен для покупки» может заблокировать автопродление legacy?
2. Сколько сейчас legacy-подписчиков? По каким тарифам? Нужна ли отдельная метрика?
3. Нужно ли предусмотреть механизм мгновенного upgrade (не через отмену + переоформление)?
4. Legacy 3-year: при переходе на new annual — нужно ли предложить компенсацию за потерю профессий?
5. Как обрабатывать edge case, когда legacy renewal проходит после того, как пользователь уже начал процесс перехода?
6. Нужно ли хранить историю смены тарифа (audit trail)?
7. Нужна ли admin-панель для просмотра и управления legacy-подписками?
8. Есть ли внешние системы, которые зависят от списка тарифных планов?
9. Как обрабатывать ситуацию, если legacy подписчик видит новый тариф дешевле текущего?
10. Нужно ли предусмотреть принудительную миграцию legacy в будущем?

---

## I) Что убрано из исходника

- **Ruby-код** (`plan.can_be_purchased?`, `plan.can_be_renewed?`) → заменён на бизнес-правила
- **ASCII wireframe** ЛК legacy-подписчика → заменён на описание элементов
- **Конкретные имена scopes** → заменены на описание фильтрации
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
