# TASK-A05: Автопродление подписок на новых тарифах

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-A05 |
| Title | Автопродление подписок на новых тарифах |
| Phase | A — New Pricing |
| Priority | P0 |

---

## A) Краткое описание

Обеспечить корректное автоматическое продление подписок на новых тарифах. Для месячного — ежемесячно, для 3/6/12 мес — по окончании оплаченного периода. Включает обработку callback-ов рекуррентного списания, email-напоминание за 7 дней (для мультимесячных) и базовую обработку неуспешных списаний.

Из документации CloudPayments: провайдер сам управляет рекуррентными списаниями по расписанию. Задача — корректно обрабатывать callback-ы и обновлять состояние в системе.

---

## B) Scope / Out of Scope

### Scope
- Обработка callback-а успешного рекуррентного списания (renewal): обновление периода подписки
- Email-подтверждение продления
- Email-напоминание за 7 дней до продления (для тарифов 3/6/12 мес)
- Базовая обработка неуспешного renewal: логирование, уведомление пользователя
- Правила перехода при исчерпании попыток: EXPIRED (месячный) или CANCELLED (мультимесячный с оставшимся периодом)

### Out of Scope
- Полноценная retry/grace period логика (B07)
- Cancellation flow (Phase C)

---

## C) Бизнес-правила и состояния

### Успешное продление
- При получении callback об успешном списании: текущий период сдвигается вперёд на длительность тарифа
- Email «Подписка продлена» отправляется пользователю

### Напоминание о продлении
- За 7 дней до окончания периода для мультимесячных тарифов (3/6/12 мес) отправляется email-напоминание
- Для месячных (1 мес) напоминание не отправляется
- Напоминание отправляется однократно (не дублируется при повторном запуске)

### Неуспешное продление
- Из документации CloudPayments: провайдер сам повторяет попытки (3 попытки, 1/день, 72 часа)
- При первой неуспешной попытке: статус подписки не меняется, пользователь получает email
- При 3-й неуспешной попытке подряд:
  - **Месячный тариф:** статус → EXPIRED, доступ закрыт
  - **Мультимесячный (оплаченный период не закончился):** статус → CANCELLED, доступ до конца оплаченного периода

### Renewal для cancelled подписки
- Если callback о продлении приходит для уже отменённой подписки → игнорируется, логируется warning

---

## D) Пользовательские и системные сценарии

1. **Given** активная месячная подписка, **When** проходит 1 месяц и провайдер списывает, **Then** период обновлён, запись об оплате создана, email отправлен.

2. **Given** активная 6-мес подписка, **When** за 7 дней до окончания, **Then** пользователь получает email-напоминание.

3. **Given** месячная подписка, **When** за 7 дней до окончания, **Then** напоминание НЕ отправляется (только для мультимесячных).

4. **Given** renewal не прошёл (fail), **When** 3 попытки исчерпаны, **Then** месячная подписка → EXPIRED, доступ закрыт.

5. **Given** renewal не прошёл, **When** 3 попытки исчерпаны для 6-мес подписки (оплаченный период не истёк), **Then** статус → CANCELLED, доступ до конца оплаченного периода.

6. **Given** renewal callback для CANCELLED подписки, **When** обрабатывается, **Then** подписка НЕ обновляется, warning логируется.

7. **Given** пользователь отменил подписку за 1 минуту до renewal, **When** callback приходит, **Then** проверяется текущий статус, renewal не выполняется.

8. **Given** напоминание уже отправлено, **When** периодическая задача запускается повторно, **Then** дубликат НЕ отправлен.

9. **Given** renewal для годового тарифа прошёл успешно, **When** обрабатывается, **Then** период обновлён на 12 месяцев.

10. **Given** renewal callback с несовпадающей суммой, **When** обрабатывается, **Then** создаётся алерт, обработка выполняется.

---

## E) Acceptance Criteria

- [ ] Успешное продление: период подписки корректно обновляется для каждого из 4 тарифов
- [ ] Email-подтверждение отправляется при успешном продлении
- [ ] Email-напоминание отправляется за 7 дней для мультимесячных тарифов
- [ ] Напоминание не дублируется
- [ ] При 3 неуспешных попытках: месячный → EXPIRED, мультимесячный → CANCELLED с сохранением доступа
- [ ] Callback для отменённой подписки игнорируется с логированием

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `subscription_renewed` | user_id, plan_id, plan_months, amount, period_start, period_end |
| `subscription_payment_failed` | user_id, plan_id, attempt_number, error_code |
| `subscription_expired_payment_failed` | user_id, plan_id, total_attempts |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Провайдер сам выполняет retry рекуррентных списаний — **подтверждено из документации CloudPayments** (3 попытки, 1/день)
- Цена при продлении = цена на момент создания подписки у провайдера (провайдер хранит сумму)
- Для изменения цены при продлении нужно явное обновление у провайдера

### Риски
- Неизвестная retry-логика провайдера → подтверждено: 3 retry, 1/день, 72 часа
- Дублирование email-напоминаний → использовать флаг идемпотентности

---

## H) Open questions для CTO/разработчиков

1. Как реализовать периодическую задачу для отправки напоминаний (за 7 дней): cron, фоновая очередь, или другой механизм?
2. Нужно ли отправлять напоминание пользователям, которые уже инициировали отмену (статус = отмена ожидает)?
3. Как обрабатывать ситуацию, когда провайдер списал деньги за отменённую подписку: автоматический refund или ручная обработка?
4. Нужно ли предусмотреть механизм изменения цены при продлении (если мы обновили цены тарифов)?
5. Как определять, что 3 неуспешные попытки произошли подряд, если провайдер не передаёт номер попытки?
6. В какой timezone считать «за 7 дней до продления» для email-напоминаний?
7. Являются ли email-напоминания о продлении transactional (отправляются даже при отписке от маркетинговых)?
8. Нужно ли в email указывать точную сумму следующего списания?
9. Как обрабатывать race condition «отмена vs продление» при одновременном запросе?
10. Нужен ли grace period между неуспешной попыткой и закрытием доступа?

---

## I) Что убрано из исходника

- **Ruby-код** (`RenewalReminderJob`, webhook processing) → заменён на бизнес-правила
- **Конкретные cron-расписания** (`ежедневно, 10:00 UTC`) → заменены на «периодическая задача»
- **SQL-подобные запросы** (`WHERE current_period_end BETWEEN...`) → заменены на бизнес-логику
- **Конкретный формат webhook payload** → заменён на «callback от провайдера»
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
