# TASK-A01: Модель данных для новых тарифных планов

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-A01 |
| Title | Модель данных для новых тарифных планов |
| Phase | A — New Pricing |
| Priority | P0 |

---

## A) Краткое описание

Создать фундамент данных для новой тарифной сетки (4 тарифа: 1/3/6/12 месяцев). Все последующие задачи Phase A зависят от этой модели. Необходимо обеспечить параллельное существование старых (legacy) и новых тарифов без нарушения работы текущих подписчиков.

Задача нужна для перехода на новую ценовую модель: текущие подписчики продолжают работать на старых тарифах, а новые пользователи видят и оформляют только новые.

---

## B) Scope / Out of Scope

### Scope
- Разделение тарифных планов на две группы: «архивные» (legacy) и «новые»
- Возможность маркировать тарифы как доступные/недоступные для новых подписок
- Создание 4 новых тарифных планов с ценами: 3 900 ₽/мес, 3 300 ₽/мес (за 3 мес), 2 900 ₽/мес (за 6 мес), 2 400 ₽/мес (за 12 мес)
- Деактивация старых тарифов для новых покупок (но не для продлений)
- Логика фильтрации: возможность запрашивать только активные / только новые / только legacy тарифы
- Валидация: невозможность оформить новую подписку на деактивированный тариф (кроме автопродления)

### Out of Scope
- Поля и логика trial-периода (Phase B)
- Поля и логика паузы (Phase D)
- Изменения в UI
- Интеграция с платёжным провайдером

---

## C) Бизнес-правила и состояния

### Тарифные планы

| Тариф | Длительность | Цена за месяц | Общая стоимость | Группа |
|-------|-------------|---------------|-----------------|--------|
| Месячный | 1 мес | 3 900 ₽ | 3 900 ₽ | Новый |
| Квартальный | 3 мес | 3 300 ₽ | 9 900 ₽ | Новый |
| Полугодовой | 6 мес | 2 900 ₽ | 17 400 ₽ | Новый |
| Годовой | 12 мес | 2 400 ₽ | 28 800 ₽ | Новый |

### Правила
- Каждый тариф принадлежит одной из групп: «legacy» или «new»
- Тариф имеет флаг «доступен для новых подписок» (true/false)
- Legacy-тарифы помечаются как недоступные для новых подписок, но продолжают работать для автопродлений
- Новый пользователь не может оформить подписку на legacy-тариф
- Существующие подписки на legacy-тарифы не затрагиваются

---

## D) Пользовательские и системные сценарии

1. **Given** миграция данных выполнена, **When** система запрашивает список доступных для покупки тарифов, **Then** возвращаются только 4 новых тарифа.

2. **Given** миграция данных выполнена, **When** система запрашивает список архивных тарифов, **Then** возвращаются все старые тарифы.

3. **Given** legacy-тариф помечен как недоступный для новых подписок, **When** новый пользователь пытается оформить на него подписку, **Then** система возвращает ошибку валидации.

4. **Given** legacy-тариф помечен как недоступный, **When** наступает автопродление legacy-подписки, **Then** продление выполняется успешно (флаг «доступен» не влияет на продление).

5. **Given** новый тариф активен, **When** пользователь без подписки пытается оформить подписку, **Then** подписка создаётся успешно.

6. **Given** два тарифа с одинаковой длительностью (legacy и new), **When** система выбирает тариф для новой покупки, **Then** выбирается только тариф из группы «new».

7. **Given** существующая подписка на legacy 3-летний тариф, **When** проверяется доступ к «профессиям», **Then** доступ к профессиям сохранён.

8. **Given** новый годовой тариф, **When** проверяется доступ к «профессиям», **Then** профессии НЕ включены (отличие от legacy 3-year).

9. **Given** миграция выполнена, **When** проверяются все существующие подписки, **Then** ни одна из них не изменила свой статус, тариф или сумму.

10. **Given** необходимость отката, **When** выполняется rollback миграции, **Then** все новые тарифы удаляются, добавленные поля удаляются, система возвращается в прежнее состояние.

---

## E) Acceptance Criteria

- [ ] 4 новых тарифа созданы с корректными ценами и длительностями
- [ ] Все legacy-тарифы помечены как «архивные» и недоступные для новых подписок
- [ ] Запрос «доступные для покупки» возвращает только 4 новых тарифа
- [ ] Попытка создать подписку на деактивированный legacy-тариф возвращает ошибку
- [ ] Автопродление legacy-тарифов работает без ошибок
- [ ] Существующие подписки не затронуты миграцией (status, plan, amount неизменны)
- [ ] Есть возможность отличить legacy-тарифы от новых при любом запросе
- [ ] Миграция данных обратима (rollback)

---

## F) Аналитика/события

Нет аналитических событий в этой задаче (только изменения модели данных).

---

## G) Риски и допущения (Assumptions)

### Допущения
- Добавление новых полей и данных к существующей модели не нарушит работу текущих запросов (additive изменения)
- Legacy-тарифы могут иметь тот же период длительности, что и новые — разделение осуществляется по группе
- CloudPayments поддерживает мультимесячные интервалы (1/3/6/12 мес) — **подтверждено из документации CloudPayments** (параметры Period=1/3/6/12, Interval=Month)

### Риски
- Миграция может затронуть запросы, которые не фильтруют по группе тарифа → необходимо провести аудит всех существующих запросов к тарифам
- Коллизия наименований тарифов (legacy и new с одинаковой длительностью) → необходимо обеспечить уникальность идентификации

---

## H) Open questions для CTO/разработчиков

1. Какой механизм хранения данных используется сейчас для тарифных планов? Нужно ли учесть миграцию с существующей модели?
2. Как именно различать legacy и new тарифы: отдельное поле-группа, разные таблицы, или другой механизм?
3. Нужно ли вводить версионирование тарифов (v1, v2) для будущих изменений цен?
4. Как обеспечить, что автопродление legacy не блокируется флагом «недоступен для новых подписок»? Нужна ли отдельная проверка?
5. Нужно ли хранить поле «включает профессии» для тарифов, или доступ к профессиям определяется иначе?
6. Как выполнять миграцию на production: online без downtime или с maintenance window?
7. Нужен ли бэкап данных перед миграцией или достаточно rollback-скрипта?
8. Есть ли другие системы/сервисы, которые читают тарифные планы напрямую (кроме основного приложения)?
9. Нужно ли обеспечить идемпотентность seed-данных (повторный запуск не создаёт дубликаты)?
10. Каким образом тарифы будут передаваться в UI: через отдельный API-endpoint или через серверный рендеринг?

---

## I) Что убрано из исходника

Следующие части исходной задачи были техническими предположениями и удалены/обобщены:

- **SQL-миграции** (`ALTER TABLE subscription_plans ADD COLUMN ...`) → заменено на бизнес-требование «добавить возможность разделять тарифы на группы»
- **Конкретные имена полей** (`generation`, `is_active`, `includes_professions`) → заменены на описание бизнес-смысла
- **SQL-индексы** (`CREATE INDEX idx_plans_active_generation`) → убраны, решение CTO
- **Конкретные имена scopes/методов** (`SubscriptionPlan.active`, `.new_generation`, `.legacy`, `.can_be_purchased?`) → заменены на бизнес-правила фильтрации
- **Конкретные имена seed-записей** (`monthly_v2`, `quarterly_v2`) → заменены на описание тарифов
- **Ruby-валидации** → заменены на бизнес-правила
- **Test Cases (Unit / Integration)** → трансформированы в Acceptance Criteria и сценарии
