# TASK-C04: Удерживающее предложение — апгрейд на мультимесячный тариф

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-C04 |
| Title | Save-offer: предложение перехода на мультимесячный тариф |
| Phase | C — Cancellation Flow |
| Priority | P2 |

---

## A) Краткое описание

Вторичное удерживающее предложение в рамках флоу отмены по причине «Слишком дорого» (`too_expensive`): показать пользователю мультимесячные тарифы с более низкой ценой за месяц. Предложение выступает альтернативой скидке (C03) и становится единственным save-offer, если лимит скидок исчерпан.

Отображаются только тарифы с периодом длиннее текущего. Если пользователь уже на максимальном тарифе (12 месяцев), предложение апгрейда не показывается. Переход на выбранный тариф ведёт либо на страницу тарифов, либо на встроенный интерфейс смены тарифа (если соответствующая функциональность готова).

---

## B) Scope / Out of Scope

### Scope
- UI блока предложения мультимесячных тарифов (в рамках шага 2 флоу отмены)
- Логика фильтрации: показывать только тарифы длиннее текущего
- Отображение цены за месяц и экономии для каждого тарифа
- CTA для выбранного тарифа: переход на страницу тарифов или встроенный апгрейд
- Адаптивный дизайн (desktop + mobile)

### Out of Scope
- Логика применения скидки (C03)
- Фактический процесс смены тарифа (оплата, пересчёт, взаимодействие с провайдером)
- Встроенный интерфейс смены тарифа (D08 — если будет реализован)
- Экран подтверждения отмены (C05)

---

## C) Бизнес-правила и состояния

### Правила отображения тарифов

| Текущий тариф | Показываемые варианты апгрейда |
|---------------|-------------------------------|
| 1 месяц | 3 мес, 6 мес, 12 мес |
| 3 месяца | 6 мес, 12 мес |
| 6 месяцев | 12 мес |
| 12 месяцев | — (блок апгрейда не показывается) |

### Условия показа
- Причина отмены: `too_expensive`
- Текущий тариф НЕ является максимальным (12 мес)
- Пользователь НЕ на пробном периоде (trial → пропуск save-offer)

### Данные для отображения

Для каждого предлагаемого тарифа показывать:
- Период (3 / 6 / 12 мес)
- Цена за месяц
- Экономия по сравнению с текущим тарифом (в ₽ или %)
- Общая стоимость за период (опционально)

### Ценовая таблица (справочно)

| Тариф | Цена/мес | Общая стоимость |
|-------|----------|-----------------|
| 1 мес | 3 900 ₽ | 3 900 ₽ |
| 3 мес | 3 300 ₽ | 9 900 ₽ |
| 6 мес | 2 900 ₽ | 17 400 ₽ |
| 12 мес | 2 400 ₽ | 28 800 ₽ |

### Действия пользователя

| Действие | Результат |
|----------|-----------|
| Выбрал мультимесячный тариф | Переход к оформлению: страница тарифов или встроенный апгрейд (если D08 готов) |
| Нажал «Всё равно отменить» | Переход к подтверждению (C05) |
| Нажал «Назад» | Возврат к экрану выбора причины (C01, шаг 1) |

### Взаимодействие с C03
- Если лимит скидок не исчерпан: апгрейд отображается как вторичное предложение ниже скидки
- Если лимит скидок исчерпан: апгрейд становится единственным предложением (primary)

---

## D) Пользовательские и системные сценарии

1. **Given** пользователь на месячном тарифе с причиной `too_expensive`, лимит скидок не исчерпан, **When** переходит на шаг 2, **Then** видит скидку (C03, primary) и ниже — варианты мультимесячных тарифов: 3, 6, 12 мес.

2. **Given** пользователь на месячном тарифе с причиной `too_expensive`, лимит скидок исчерпан, **When** переходит на шаг 2, **Then** видит только предложение мультимесячных тарифов (3, 6, 12 мес) как основное предложение.

3. **Given** пользователь на 3-месячном тарифе, **When** видит предложение апгрейда, **Then** отображаются только 6 мес и 12 мес.

4. **Given** пользователь на 6-месячном тарифе, **When** видит предложение апгрейда, **Then** отображается только 12 мес.

5. **Given** пользователь на 12-месячном тарифе, **When** переходит на шаг 2 с причиной `too_expensive`, **Then** блок апгрейда не отображается (только скидка, если лимит доступен, или сразу «Всё равно отменить»).

6. **Given** пользователь на 12-месячном тарифе, лимит скидок исчерпан, **When** переходит на шаг 2, **Then** ни скидка, ни апгрейд не доступны — пользователь переходит сразу к подтверждению (C05).

7. **Given** пользователь выбрал мультимесячный тариф, встроенный апгрейд (D08) готов, **When** нажимает CTA, **Then** переходит к встроенному интерфейсу смены тарифа.

8. **Given** пользователь выбрал мультимесячный тариф, D08 НЕ готов, **When** нажимает CTA, **Then** переходит на страницу тарифов с предвыбранным тарифом.

9. **Given** пользователь на экране апгрейда, **When** нажимает «Всё равно отменить», **Then** переходит к подтверждению (C05).

10. **Given** пользователь на мобильном устройстве, **When** видит предложения тарифов, **Then** карточки отображаются вертикально, все данные (цена/мес, экономия) читаемы.

11. **Given** пользователь на пробном периоде (trial), **When** выбрал причину `too_expensive`, **Then** экран апгрейда пропускается (правило из C01).

12. **Given** API тарифов не отвечает, **When** экран апгрейда загружается, **Then** отображаются fallback-данные или блок апгрейда скрывается с корректным сообщением.

---

## E) Acceptance Criteria

- [ ] Для каждого текущего тарифа отображаются только тарифы с большим периодом
- [ ] Для тарифа 12 мес блок апгрейда не отображается
- [ ] Для каждого предлагаемого тарифа указана цена за месяц и экономия
- [ ] CTA ведёт на страницу тарифов или встроенный апгрейд (в зависимости от готовности D08)
- [ ] При исчерпанном лимите скидок апгрейд отображается как основное предложение
- [ ] При исчерпанном лимите скидок И тарифе 12 мес — пользователь переходит сразу к подтверждению
- [ ] Кнопка «Всё равно отменить» ведёт к подтверждению (C05)
- [ ] Экран корректно отображается на desktop и mobile
- [ ] Данные о тарифах загружаются динамически (не захардкожены)

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `save_offer_shown` | user_id, subscription_id, offer_type: `upgrade`, current_plan_months, offered_plans |
| `save_offer_accepted` | user_id, subscription_id, offer_type: `upgrade`, selected_plan_months |
| `save_offer_rejected` | user_id, subscription_id, offer_type: `upgrade` |
| `save_offer_skipped` | user_id, subscription_id, offer_type: `upgrade`, skip_reason: `max_plan` |

Подробная аналитика — в задаче C06.

---

## G) Риски и допущения (Assumptions)

### Допущения
- Данные о тарифах и ценах доступны через существующее хранилище / API тарифов
- Переход на мультимесячный тариф не требует немедленной оплаты в рамках этого экрана — оплата происходит на странице тарифов или во встроенном апгрейде
- Встроенный апгрейд (D08) — опциональная зависимость; fallback — redirect на страницу тарифов

### Риски
- Если пользователь переходит на страницу тарифов, он может не завершить апгрейд (контекст отмены теряется) → потенциальная потеря конверсии
- Для мультимесячных пользователей предложение может быть неочевидно выгодным (они уже получают скидку за период)
- Тариф 12 мес + исчерпанный лимит скидок = нет save-offer → высокий риск churn для этой когорты

---

## H) Open questions для CTO/разработчиков

1. При переходе на страницу тарифов — как передать контекст отмены (чтобы трекать, что апгрейд произошёл из cancellation flow)?
2. Если пользователь перешёл на страницу тарифов, но не оформил апгрейд — он возвращается в флоу отмены или начинает заново?
3. Как определить готовность D08 (встроенный апгрейд) в runtime: feature flag или проверка наличия?
4. Нужно ли показывать разницу в цене «вы платите сейчас X/мес, с тарифом Y будет Z/мес» или достаточно абсолютных цен?
5. Для мультимесячных подписчиков: пересчёт стоимости при апгрейде (за оставшийся период) → отображать на экране или нет?
6. Что происходит при смене тарифа в середине оплаченного периода: доплата, возврат, пересчёт?
7. Как отображать тарифы: карточками (как на pricing page) или компактным списком?
8. Нужно ли визуально выделять рекомендованный тариф (например, 6 мес как «Выбор большинства»)?
9. Скидку 30% (C03) можно применить к мультимесячному тарифу одновременно с апгрейдом?
10. Нужен ли таймер или срок действия предложения апгрейда (urgency)?
11. Если все доступные тарифы дороже текущего в абсолютном выражении — предложение может показаться контринтуитивным. Как коммуницировать выгоду?
12. Для пользователя на 12-месячном тарифе с исчерпанным лимитом скидок — нужно ли специальное сообщение перед переходом к подтверждению?

---

## I) Что убрано из исходника

- **Ссылка на конкретный эндпоинт или страницу** (pricing page URL) → заменена на «переход на страницу тарифов»
- **Упоминание конкретной задачи D08 как технической зависимости** → оставлена как опциональная функциональная зависимость
- **Детали реализации inline upgrade** → вынесены в open questions
- **Конкретная логика оформления смены тарифа** → отнесена к out of scope
