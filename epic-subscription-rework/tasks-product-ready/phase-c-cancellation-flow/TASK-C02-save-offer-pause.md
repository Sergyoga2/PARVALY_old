# TASK-C02: Удерживающее предложение — пауза подписки

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-C02 |
| Title | Save-offer: предложение паузы вместо отмены |
| Phase | C — Cancellation Flow |
| Priority | P1 |

---

## A) Краткое описание

При выборе причины отмены «Нет времени» (`no_time`) пользователю показывается удерживающее предложение — поставить подписку на паузу на 1 месяц вместо полной отмены. Это UI-шаг внутри флоу отмены (шаг 2 из C01). Экран содержит два варианта действия: основная кнопка «Поставить на паузу на 1 месяц» и второстепенная кнопка «Всё равно отменить».

Фактическая логика паузы реализуется в отдельной задаче (D01). Данная задача покрывает только интерфейс предложения и интеграцию с флоу отмены. Если функциональность паузы ещё не готова — показывается fallback-сообщение. Если пользователь уже использовал лимит пауз — шаг пропускается, пользователь переходит сразу к подтверждению отмены.

---

## B) Scope / Out of Scope

### Scope
- UI экрана save-offer с предложением паузы
- Основная кнопка (primary): «Поставить на паузу на 1 месяц»
- Второстепенная кнопка (ghost): «Всё равно отменить»
- Проверка готовности функциональности паузы (D01) и отображение fallback при её отсутствии
- Проверка лимита пауз: если лимит исчерпан — пропуск шага
- Интеграция с флоу отмены (C01): получение причины, передача управления к C05

### Out of Scope
- Логика паузы подписки на стороне платёжного провайдера (D01)
- Определение правил лимитов пауз (бизнес-правила лимитов — в D01)
- Аналитика (C06)
- Экран подтверждения отмены (C05)

---

## C) Бизнес-правила и состояния

### Условия показа экрана
- Показывается только при причине `no_time`
- Не показывается trial-подписчикам (управляется в C01)
- Не показывается, если лимит пауз уже исчерпан

### Поведение кнопок

| Кнопка | Тип | Действие |
|--------|-----|----------|
| Поставить на паузу на 1 месяц | Primary | Если D01 готова — вызвать функцию паузы → показать success-состояние. Если D01 не готова — показать fallback-сообщение |
| Всё равно отменить | Ghost | Перейти к шагу подтверждения отмены (C05) |

### Fallback при отсутствии функциональности паузы
- Если D01 не готова (определяется через feature flag или проверку доступности): показать сообщение «Функция паузы скоро появится. Пока вы можете отменить подписку, а позже оформить её заново»
- Кнопка «Поставить на паузу» в fallback-режиме заменяется на неактивную или скрытую
- Кнопка «Всё равно отменить» остаётся доступной

### Success-состояние (при успешной паузе)
- Сообщение: «Ваша подписка поставлена на паузу до [дата возобновления]»
- Кнопка возврата в личный кабинет
- Флоу отмены завершается без фактической отмены

### Лимит пауз
- Если пользователь уже использовал допустимое количество пауз — экран save-offer пропускается
- Пользователь переходит напрямую к экрану подтверждения отмены (C05)

---

## D) Пользовательские и системные сценарии

1. **Given** активный подписчик выбрал причину `no_time`, пауза ещё не использована, D01 готова, **When** переходит на шаг 2, **Then** видит экран с предложением паузы: primary-кнопка «Поставить на паузу на 1 месяц» и ghost-кнопка «Всё равно отменить».

2. **Given** пользователь на экране save-offer паузы, **When** нажимает «Поставить на паузу на 1 месяц», **Then** подписка ставится на паузу, показывается success-сообщение с датой возобновления.

3. **Given** пользователь на экране save-offer паузы, **When** нажимает «Всё равно отменить», **Then** переходит к экрану подтверждения отмены (C05).

4. **Given** функциональность паузы (D01) не готова, **When** пользователь с причиной `no_time` переходит на шаг 2, **Then** видит fallback-сообщение о том, что пауза скоро появится, с возможностью отменить подписку.

5. **Given** пользователь уже исчерпал лимит пауз, **When** выбирает причину `no_time`, **Then** шаг 2 пропускается, пользователь переходит сразу к подтверждению отмены (C05).

6. **Given** пользователь нажал «Поставить на паузу», но запрос к D01 завершился ошибкой, **When** получен ответ об ошибке, **Then** показывается сообщение об ошибке с предложением повторить или отменить подписку.

7. **Given** пользователь на экране save-offer паузы, **When** нажимает «Назад», **Then** возвращается к шагу выбора причины (C01, шаг 1), причина `no_time` остаётся выделенной.

8. **Given** trial-подписчик с причиной `no_time`, **When** проходит флоу отмены, **Then** экран save-offer паузы не показывается (управляется в C01).

9. **Given** пользователь на мобильном устройстве, **When** видит экран save-offer паузы, **Then** обе кнопки полноразмерные, без горизонтальной прокрутки.

10. **Given** пользователь успешно поставил подписку на паузу, **When** видит success-экран, **Then** кнопка «Вернуться в личный кабинет» возвращает его в раздел подписки, флоу отмены завершён.

---

## E) Acceptance Criteria

- [ ] Экран save-offer паузы отображается только при причине `no_time`
- [ ] Primary-кнопка «Поставить на паузу на 1 месяц» вызывает функцию паузы (при готовности D01)
- [ ] Ghost-кнопка «Всё равно отменить» ведёт к подтверждению отмены (C05)
- [ ] При неготовности D01 отображается fallback-сообщение, кнопка паузы недоступна
- [ ] При исчерпании лимита пауз экран пропускается, пользователь идёт к C05
- [ ] Success-состояние показывает дату возобновления подписки
- [ ] Обработка ошибок при вызове паузы: сообщение об ошибке с возможностью повторить
- [ ] Кнопка «Назад» возвращает на шаг выбора причины
- [ ] Интерфейс корректно отображается на desktop и mobile

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `save_offer_shown` | user_id, subscription_id, offer_type: `pause`, reason_code: `no_time` |
| `save_offer_accepted` | user_id, subscription_id, offer_type: `pause` |
| `save_offer_rejected` | user_id, subscription_id, offer_type: `pause` |
| `save_offer_skipped_limit` | user_id, subscription_id, offer_type: `pause`, skip_reason: `limit_exhausted` |
| `save_offer_fallback_shown` | user_id, subscription_id, offer_type: `pause`, fallback_reason: `feature_not_ready` |

Подробная аналитика — в задаче C06.

---

## G) Риски и допущения (Assumptions)

### Допущения
- Длительность паузы фиксирована — 1 месяц (не настраивается пользователем)
- Лимит пауз определяется в задаче D01; C02 только проверяет, исчерпан ли лимит
- Платёжный провайдер поддерживает статус «пауза» нативно (подтверждено документацией)
- Дизайн-макеты для экрана save-offer, fallback и success будут предоставлены

### Риски
- D01 может быть не готова к моменту реализации C02 — необходим fallback-режим
- Неясен механизм определения готовности D01 (feature flag или проверка доступности)
- Лимит пауз может зависеть от истории использования, которая пока не реализована

---

## H) Open questions для CTO/разработчиков

1. Как определять готовность D01: через feature flag, проверку доступности функции, или конфигурацию?
2. Каков лимит пауз: 1 пауза за всё время подписки, 1 пауза за 6 месяцев, или иной период?
3. Откуда C02 получает информацию об исчерпании лимита пауз: локальный запрос к хранилищу данных или отдельный сервис проверки?
4. Дизайн fallback-состояния: это полноценный экран или уведомление (toast/banner)?
5. Нужно ли показывать оставшееся количество пауз пользователю?
6. Если пользователь принял предложение паузы — нужно ли дополнительное подтверждение («Вы уверены?»)?
7. Что показывать в success-состоянии, если дата возобновления ещё не известна (например, D01 вернул только подтверждение)?
8. Нужна ли анимация или промежуточный loading-экран при выполнении запроса на паузу?
9. Как обрабатывать ситуацию, когда подписка истекла между открытием экрана и нажатием кнопки паузы?
10. Должен ли fallback-текст содержать ссылку на форму обратной связи или предложение подписаться на уведомление о появлении функции?
11. Нужно ли учитывать, что пользователь находится в grace period при показе предложения паузы?
12. Если пауза поставлена успешно — должен ли пользователь получить email-подтверждение (или это в D01)?

---

## I) Что убрано из исходника

- **Упоминание конкретного API** (`pause API`, `call pause API`) — заменено на «вызвать функцию паузы»
- **Детали реализации кнопок** (конкретные стили, CSS-классы `ghost`, `primary`) — заменены на описание типов кнопок (primary/ghost)
- **Прямая ссылка на Phase D, D01** как конкретный endpoint — сохранена как зависимость задачи, но без деталей реализации
- **Конкретный формат ответа API** — заменён на описание success/error состояний
