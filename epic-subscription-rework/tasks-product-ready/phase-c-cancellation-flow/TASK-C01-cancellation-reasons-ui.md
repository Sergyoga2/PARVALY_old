# TASK-C01: UI выбора причины отмены подписки

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-C01 |
| Title | Многошаговый флоу отмены подписки с выбором причины |
| Phase | C — Cancellation Flow |
| Priority | P0 |

---

## A) Краткое описание

Реализовать многошаговый интерфейс отмены подписки, состоящий из трёх шагов: (1) выбор причины отмены, (2) показ удерживающего предложения (save-offer), подобранного под причину, (3) экран подтверждения отмены. Каждая причина ведёт к своему сценарию удержания или напрямую к подтверждению.

Для пользователей на пробном периоде (trial) флоу упрощён: шаг с удерживающим предложением пропускается, пользователь сразу переходит к подтверждению. Интерфейс должен быть адаптивным (desktop + mobile). Причина отмены сохраняется в хранилище данных для последующей аналитики.

---

## B) Scope / Out of Scope

### Scope
- Многошаговый интерфейс: шаг выбора причины, шаг save-offer, шаг подтверждения
- 6 причин отмены с маршрутизацией на соответствующие шаги
- Адаптивный дизайн (desktop + mobile)
- Сохранение причины отмены в хранилище данных
- Упрощённый флоу для trial-подписчиков (без save-offer)
- Маршрутизация к внешним задачам: C02 (пауза), C03 (скидка), C04 (апгрейд), C05 (подтверждение)

### Out of Scope
- Логика паузы подписки (C02, D01)
- Логика применения скидки (C03, C07)
- Логика смены тарифа / апгрейда (C04)
- Экран подтверждения отмены (C05)
- Аналитические события (C06)
- Фактическая отмена подписки на стороне платёжного провайдера

---

## C) Бизнес-правила и состояния

### Причины отмены и маршрутизация

| Причина | Код причины | Шаг 2 (save-offer) | Шаг 3 |
|---------|-------------|---------------------|--------|
| Нет времени | `no_time` | Предложение паузы (C02) | Подтверждение |
| Слишком дорого | `too_expensive` | Предложение скидки (C03) + апгрейд (C04) | Подтверждение |
| Нет интересного контента | `no_content` | — (пропуск) | Подтверждение напрямую |
| Уже всё изучил | `learned_enough` | — (пропуск) | Подтверждение + поздравительное сообщение |
| Перехожу на другой сервис | `switching` | — (пропуск) | Подтверждение + мини-опрос (куда уходит) |
| Другое | `other` | — (пропуск) | Подтверждение |

### Правила для trial-подписчиков
- Шаг 2 (save-offer) всегда пропускается
- Причины отображаются, но без удерживающих предложений
- Переход напрямую к экрану подтверждения (C05)

### Правила сохранения данных
- Причина отмены сохраняется при переходе с шага 1 на шаг 2 (или на шаг 3)
- Если пользователь передумал (нажал «Назад» или закрыл окно), причина всё равно сохраняется для аналитики, но отмена не происходит
- Одна подписка может иметь историю нескольких попыток отмены с разными причинами

---

## D) Пользовательские и системные сценарии

1. **Given** активный подписчик на месячном тарифе, **When** нажимает «Отменить подписку» в личном кабинете, **Then** открывается шаг 1 — экран выбора причины с 6 вариантами.

2. **Given** пользователь на шаге 1 выбрал причину «Нет времени» (`no_time`), **When** нажимает «Продолжить», **Then** переходит на шаг 2 с предложением паузы (C02).

3. **Given** пользователь на шаге 1 выбрал причину «Слишком дорого» (`too_expensive`), **When** нажимает «Продолжить», **Then** переходит на шаг 2 с предложением скидки (C03) и опцией апгрейда (C04).

4. **Given** пользователь на шаге 1 выбрал причину «Нет интересного контента» (`no_content`), **When** нажимает «Продолжить», **Then** переходит сразу на шаг 3 — экран подтверждения (C05).

5. **Given** пользователь на шаге 1 выбрал причину «Уже всё изучил» (`learned_enough`), **When** нажимает «Продолжить», **Then** переходит на шаг 3 с поздравительным сообщением.

6. **Given** пользователь на шаге 1 выбрал причину «Перехожу на другой сервис» (`switching`), **When** нажимает «Продолжить», **Then** переходит на шаг 3 с мини-опросом (свободное поле или список конкурентов).

7. **Given** пользователь на пробном периоде (trial), **When** выбирает любую причину, **Then** шаг 2 (save-offer) пропускается, пользователь переходит сразу к подтверждению.

8. **Given** пользователь на шаге 2, **When** нажимает «Назад», **Then** возвращается к шагу 1, ранее выбранная причина остаётся выделенной.

9. **Given** пользователь на шаге 1, **When** закрывает окно / нажимает «Отмена» (cancel диалога), **Then** возвращается в личный кабинет, подписка не отменяется, но причина (если была выбрана) сохраняется для аналитики.

10. **Given** пользователь на мобильном устройстве, **When** открывает флоу отмены, **Then** все шаги корректно отображаются, кнопки доступны без горизонтальной прокрутки.

11. **Given** пользователь без активной подписки (expired), **When** пытается открыть флоу отмены, **Then** кнопка «Отменить подписку» не отображается или неактивна.

12. **Given** причина «Другое» (`other`) выбрана, **When** пользователь нажимает «Продолжить», **Then** переходит к подтверждению, опционально отображается текстовое поле для комментария.

---

## E) Acceptance Criteria

- [ ] Экран выбора причины отображает 6 причин с возможностью выбрать одну
- [ ] Каждая причина корректно маршрутизирует на соответствующий шаг 2 или шаг 3
- [ ] Для trial-подписчиков шаг save-offer всегда пропускается
- [ ] Причина отмены сохраняется в хранилище данных
- [ ] Кнопка «Назад» возвращает на предыдущий шаг с сохранением выбора
- [ ] Закрытие флоу без подтверждения не приводит к отмене подписки
- [ ] Интерфейс корректно отображается на desktop и mobile
- [ ] Кнопка «Отменить подписку» не отображается для пользователей без активной подписки
- [ ] Для причины `switching` отображается мини-опрос с вариантами или свободным полем
- [ ] Для причины `learned_enough` на шаге подтверждения отображается поздравительное сообщение

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `cancellation_flow_started` | user_id, subscription_id, plan_months, is_trial |
| `cancellation_reason_selected` | user_id, subscription_id, reason_code |
| `cancellation_flow_step_viewed` | user_id, step_number (1/2/3), step_type |
| `cancellation_flow_abandoned` | user_id, subscription_id, reason_code (nullable), last_step |

Подробная аналитика — в задаче C06.

---

## G) Риски и допущения (Assumptions)

### Допущения
- Дизайн-макеты для всех шагов и состояний будут предоставлены до начала разработки
- Список из 6 причин финальный и согласован с продуктом
- Trial-подписчики могут отменить подписку через тот же раздел личного кабинета

### Риски
- Зависимость от C02, C03, C04, C05: если эти задачи не готовы, шаг 2 должен корректно обрабатывать отсутствие (fallback — переход к подтверждению)
- Конфликт с текущим флоу отмены: нужно предусмотреть feature flag для переключения между старым и новым флоу
- Мини-опрос для причины `switching` может усложнить поддержку (список конкурентов нужно обновлять)

---

## H) Open questions для CTO/разработчиков

1. Где именно в личном кабинете расположена точка входа в флоу отмены (кнопка «Отменить подписку»)?
2. Флоу отмены — это модальное окно, отдельная страница или выдвижная панель (drawer)?
3. Как хранить историю попыток отмены: каждая попытка — отдельная запись или перезапись?
4. Нужен ли feature flag для переключения между старым и новым флоу отмены?
5. Для причины `switching` — список конкурентов захардкожен в интерфейсе или берётся из хранилища данных?
6. Нужна ли валидация на стороне сервера, что пользователь не может перейти к шагу 3 без выбора причины?
7. Как обрабатывать ситуацию, когда пользователь начал флоу отмены, но его подписка истекла до завершения?
8. Для причины `other` — текстовое поле для комментария обязательно или опционально?
9. Нужно ли ограничивать количество попыток отмены за определённый период (anti-abuse)?
10. Каким образом шаг 2 определяет, готова ли зависимая задача (C02/C03/C04)? Через feature flag или через проверку наличия функциональности?
11. Поддерживается ли deep link на конкретный шаг флоу (для email-рассылок)?
12. Нужна ли offline-совместимость (сохранение состояния при потере соединения)?
13. Каков таймаут сессии флоу? Сохраняется ли прогресс при обновлении страницы?
14. Как определяется, что пользователь на trial, — по статусу подписки или по отдельному флагу?

---

## I) Что убрано из исходника

- **Конкретное упоминание backend-сохранения поля** (`cancellation_reason`) — заменено на «сохранение причины отмены в хранилище данных»
- **Детали маршрутизации** (конкретные эндпоинты, вызовы API) — заменены на бизнес-правила маршрутизации по причинам
- **Детали реализации адаптивности** — заменены на требование «адаптивный дизайн (desktop + mobile)»
- **Конкретные UI-компоненты** — заменены на описание шагов и поведения
