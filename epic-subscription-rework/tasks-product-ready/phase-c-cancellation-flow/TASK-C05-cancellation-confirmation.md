# TASK-C05: Экран подтверждения отмены подписки

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-C05 |
| Title | Финальный экран подтверждения отмены и состояние успеха |
| Phase | C — Cancellation Flow |
| Priority | P0 |

---

## A) Краткое описание

Финальный шаг флоу отмены подписки: экран подтверждения, на котором пользователь видит чёткую информацию о последствиях отмены — до какой даты сохраняется доступ — и подтверждает своё решение. После подтверждения отображается экран успеха с информацией о завершении.

Дата окончания доступа рассчитывается по-разному в зависимости от типа подписки: для мультимесячных — до конца оплаченного периода, для месячных — до конца текущего месяца, для trial — до даты окончания пробного периода. Экран содержит кнопку «Подтвердить отмену» и кнопку «Остаться» для возврата в личный кабинет.

---

## B) Scope / Out of Scope

### Scope
- UI экрана подтверждения отмены (шаг 3 флоу)
- Отображение даты окончания доступа с учётом типа подписки
- Кнопка «Подтвердить отмену» — выполнение отмены
- Кнопка «Остаться» — возврат в личный кабинет без отмены
- Экран успеха после подтверждения отмены
- Вариации экрана для разных причин отмены (поздравление для `learned_enough`, мини-опрос для `switching`)
- Адаптивный дизайн (desktop + mobile)

### Out of Scope
- Логика взаимодействия с платёжным провайдером для фактической отмены рекуррентных платежей
- Save-offer экраны (C02, C03, C04)
- Аналитические события (C06)
- Email-уведомление об отмене
- Возможность повторной подписки после отмены

---

## C) Бизнес-правила и состояния

### Расчёт даты окончания доступа

| Тип подписки | Дата окончания доступа |
|-------------|----------------------|
| Мультимесячная (3/6/12 мес) | Конец оплаченного периода |
| Месячная (1 мес) | Конец текущего оплаченного месяца |
| Пробный период (trial) | Дата окончания trial |

### Формулировки на экране подтверждения

| Тип подписки | Текст |
|-------------|-------|
| Мультимесячная | «Доступ сохранится до [дата окончания оплаченного периода]» |
| Месячная | «Доступ сохранится до [дата окончания текущего месяца]» |
| Trial | «Доступ сохранится до [дата окончания пробного периода]» |

### Вариации экрана по причине отмены

| Причина | Дополнительный элемент на экране подтверждения |
|---------|-----------------------------------------------|
| `learned_enough` | Поздравительное сообщение: «Поздравляем с достижением! Вы можете вернуться в любой момент.» |
| `switching` | Мини-опрос: «На какой сервис вы переходите?» (список вариантов или свободное поле) |
| `no_time` | Стандартный экран |
| `too_expensive` | Стандартный экран |
| `no_content` | Стандартный экран |
| `other` | Опциональное поле для комментария |

### Экран успеха (после подтверждения)
- Сообщение: «Подписка отменена»
- Информация о дате окончания доступа
- CTA: «Вернуться в личный кабинет»
- Опционально: ссылка «Передумали? Оформите подписку заново»

### Кнопки

| Кнопка | Стиль | Действие |
|--------|-------|----------|
| «Подтвердить отмену» | Деструктивный (red / warning) | Выполняет отмену подписки |
| «Остаться» / «Вернуться» | Primary / положительный | Закрывает флоу, возвращает в личный кабинет |

---

## D) Пользовательские и системные сценарии

1. **Given** пользователь на мультимесячном тарифе (6 мес), оплаченный период до 15.09.2026, **When** видит экран подтверждения, **Then** отображается текст «Доступ сохранится до 15.09.2026».

2. **Given** пользователь на месячном тарифе, текущий период до 05.04.2026, **When** видит экран подтверждения, **Then** отображается текст «Доступ сохранится до 05.04.2026».

3. **Given** пользователь на пробном периоде, trial до 20.03.2026, **When** видит экран подтверждения, **Then** отображается текст «Доступ сохранится до 20.03.2026».

4. **Given** пользователь на экране подтверждения, **When** нажимает «Подтвердить отмену», **Then** подписка отменяется, отображается экран успеха.

5. **Given** пользователь на экране подтверждения, **When** нажимает «Остаться», **Then** флоу отмены закрывается, пользователь возвращается в личный кабинет, подписка не отменяется.

6. **Given** причина отмены `learned_enough`, **When** пользователь видит экран подтверждения, **Then** дополнительно отображается поздравительное сообщение.

7. **Given** причина отмены `switching`, **When** пользователь видит экран подтверждения, **Then** дополнительно отображается мини-опрос о конкуренте.

8. **Given** пользователь нажал «Подтвердить отмену», но запрос завершился ошибкой, **When** ошибка обработана, **Then** пользователь видит сообщение об ошибке с возможностью повторить.

9. **Given** экран успеха после отмены, **When** пользователь видит результат, **Then** отображается дата окончания доступа и кнопка возврата в личный кабинет.

10. **Given** пользователь на мобильном устройстве, **When** видит экран подтверждения, **Then** все элементы (дата, кнопки, дополнительные блоки) корректно отображаются.

11. **Given** пользователь дважды нажал «Подтвердить отмену» (double click), **When** обрабатывается, **Then** отмена выполняется только один раз (идемпотентность).

12. **Given** подписка пользователя истекла во время прохождения флоу (edge case), **When** нажимает «Подтвердить отмену», **Then** отображается корректное сообщение (подписка уже неактивна).

---

## E) Acceptance Criteria

- [ ] Экран подтверждения отображает корректную дату окончания доступа для всех типов подписки (месячная, мультимесячная, trial)
- [ ] Кнопка «Подтвердить отмену» выполняет отмену подписки
- [ ] Кнопка «Остаться» возвращает в личный кабинет без отмены
- [ ] После подтверждения отображается экран успеха с датой окончания доступа
- [ ] Для причины `learned_enough` отображается поздравительное сообщение
- [ ] Для причины `switching` отображается мини-опрос
- [ ] Двойной клик на «Подтвердить отмену» не вызывает дублирования (идемпотентность)
- [ ] Ошибки при отмене обрабатываются с понятным сообщением пользователю
- [ ] Экран корректно отображается на desktop и mobile
- [ ] Мини-опрос для `switching` сохраняется в хранилище данных

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `cancellation_confirmation_viewed` | user_id, subscription_id, reason_code, plan_months, access_end_date |
| `cancellation_confirmed` | user_id, subscription_id, reason_code, plan_months, access_end_date |
| `cancellation_aborted` | user_id, subscription_id, reason_code, abort_step: `confirmation` |
| `cancellation_survey_submitted` | user_id, subscription_id, reason_code: `switching`, competitor_name (nullable), free_text (nullable) |

Подробная аналитика — в задаче C06.

---

## G) Риски и допущения (Assumptions)

### Допущения
- Дата окончания оплаченного периода доступна из данных подписки (не требует запроса к провайдеру)
- Фактическая отмена рекуррентных платежей выполняется через существующий модуль биллинга
- Отмена подписки на стороне провайдера выполняется синхронно (пользователь видит результат сразу)
- Email-уведомление об отмене отправляется автоматически (вне scope этой задачи)

### Риски
- Рассогласование дат: дата окончания в системе и у провайдера могут различаться → необходима синхронизация
- Если отмена на стороне провайдера не прошла, но в UI показан экран успеха — критичный UX-баг
- Мини-опрос для `switching` может снижать конверсию подтверждения (лишний шаг → пользователь передумывает уходить... или раздражается)

---

## H) Open questions для CTO/разработчиков

1. Как обеспечить идемпотентность отмены при двойном клике или повторном запросе?
2. Отмена выполняется синхронно (пользователь ждёт ответа) или асинхронно (показываем «отмена в обработке»)?
3. Какой таймаут на запрос отмены? Что показывать при timeout?
4. Нужно ли запрашивать у провайдера фактическую дату окончания или достаточно данных из системы?
5. Как обрабатывать ситуацию, когда отмена прошла на стороне провайдера, но ответ не дошёл до клиента (сетевая ошибка)?
6. Мини-опрос для `switching`: список конкурентов — откуда берётся? Захардкожен или из хранилища данных?
7. Поздравительное сообщение для `learned_enough`: нужен ли персонализированный текст (например, «Вы прошли N курсов»)?
8. Нужна ли кнопка «Передумали? Оформите подписку заново» на экране успеха?
9. Формат даты окончания доступа: «15 сентября 2026» или «15.09.2026»?
10. Нужно ли показывать, что именно будет отменено (название тарифа, сумма следующего списания)?
11. Отображается ли информация о возврате средств на экране подтверждения (для мультимесячных)?
12. Как обрабатывать отмену trial, если trial_ends_at уже в прошлом (edge case)?
13. Если пользователь подтвердил отмену, должен ли он быть разлогинен или оставаться в системе?
14. Нужно ли предупреждение «Вы уверены?» перед финальным подтверждением или достаточно одного экрана?
15. Как визуально различать экран подтверждения (до отмены) и экран успеха (после) — это два состояния одного экрана или два разных экрана?

---

## I) Что убрано из исходника

- **Конкретные поля данных** (`trial_ends_at`, `current_period_end`) → заменены на описание бизнес-логики расчёта даты
- **Детали взаимодействия с провайдером** → заменены на «фактическая отмена подписки»
- **Конкретные элементы UI** → заменены на описание требований к интерфейсу и поведению
- **Технические детали идемпотентности** → вынесены в open questions
