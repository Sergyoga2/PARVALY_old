# TASK-C06: Аналитика флоу отмены подписки

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-C06 |
| Title | Аналитические события и метрики для флоу отмены |
| Phase | C — Cancellation Flow |
| Priority | P1 |

---

## A) Краткое описание

Настроить сквозную аналитику для всего флоу отмены подписки: от инициации до завершения (отмена или сохранение). Аналитика охватывает все шаги флоу: выбор причины, показ удерживающих предложений (save-offer), принятие или отклонение предложений, подтверждение отмены или возврат.

Цель — обеспечить возможность построения воронки отмены, расчёта save rate (доля пользователей, которых удалось удержать), анализа эффективности каждого save-offer и выявления точек, где пользователи покидают флоу. Данные используются для оптимизации retention-стратегии.

---

## B) Scope / Out of Scope

### Scope
- Определение и документирование всех аналитических событий флоу отмены
- Отправка событий на каждом шаге флоу (C01–C05)
- Обязательные свойства для каждого события
- Ключевые метрики и дашборд
- Воронка: started → reason → offer shown → accepted/rejected → confirmed/aborted

### Out of Scope
- Аналитика win-back флоу (Phase D)
- Аналитика покупки подписки (Phase A)
- Построение ML-моделей предсказания churn
- Настройка конкретных дашбордов в инструментах аналитики

---

## C) Бизнес-правила и состояния

### Воронка отмены

```
Инициация → Выбор причины → Показ save-offer → Принятие / Отклонение → Подтверждение / Возврат
```

### Полный список аналитических событий

| # | Событие | Когда срабатывает | Шаг флоу |
|---|---------|-------------------|----------|
| 1 | `cancellation_flow_started` | Пользователь открыл флоу отмены | Вход |
| 2 | `cancellation_reason_selected` | Пользователь выбрал причину отмены | Шаг 1 |
| 3 | `cancellation_reason_submitted` | Пользователь нажал «Продолжить» после выбора причины | Шаг 1 |
| 4 | `save_offer_shown` | Удерживающее предложение отображено | Шаг 2 |
| 5 | `save_offer_accepted` | Пользователь принял save-offer | Шаг 2 |
| 6 | `save_offer_rejected` | Пользователь нажал «Всё равно отменить» | Шаг 2 |
| 7 | `save_offer_skipped` | Save-offer пропущен (лимит, недоступность, trial) | Шаг 2 |
| 8 | `cancellation_confirmation_viewed` | Экран подтверждения отображён | Шаг 3 |
| 9 | `cancellation_confirmed` | Пользователь подтвердил отмену | Шаг 3 |
| 10 | `cancellation_aborted` | Пользователь нажал «Остаться» / закрыл флоу | Любой шаг |
| 11 | `cancellation_survey_submitted` | Заполнен мини-опрос (для `switching`) | Шаг 3 |
| 12 | `cancellation_error` | Ошибка при выполнении отмены | Шаг 3 |

### Обязательные свойства событий

**Общие свойства (для всех событий):**
- user_id
- subscription_id
- plan_months (текущий тариф)
- is_trial (да/нет)
- timestamp

**Специфические свойства:**

| Событие | Дополнительные свойства |
|---------|----------------------|
| `cancellation_reason_selected` | reason_code |
| `cancellation_reason_submitted` | reason_code |
| `save_offer_shown` | offer_type (pause / discount / upgrade), reason_code |
| `save_offer_accepted` | offer_type, offer_details (discount_percent, selected_plan_months, и т.д.) |
| `save_offer_rejected` | offer_type |
| `save_offer_skipped` | offer_type, skip_reason (limit_exhausted / feature_unavailable / trial / max_plan) |
| `cancellation_confirmed` | reason_code, access_end_date |
| `cancellation_aborted` | last_step (reason / offer / confirmation), reason_code (nullable) |
| `cancellation_survey_submitted` | competitor_name (nullable), free_text (nullable) |
| `cancellation_error` | error_type, error_message |

### Ключевые метрики

| Метрика | Формула | Цель |
|---------|---------|------|
| **Save rate** | (принявшие offer) / (увидевшие offer) | Общая эффективность удержания |
| **Save rate по причине** | (принявшие offer для причины X) / (увидевшие offer для причины X) | Эффективность конкретного offer |
| **Completion rate** | (подтвердившие отмену) / (начавшие флоу) | Доля завершивших отмену |
| **Abort rate** | (вернувшиеся без отмены) / (начавшие флоу) | Доля передумавших |
| **Abort rate по шагам** | (вернувшиеся на шаге N) / (достигшие шага N) | Точки возврата |
| **Причина #1** | Самая частая причина отмены | Основной драйвер churn |
| **Pause acceptance rate** | (принявшие паузу) / (увидевшие предложение паузы) | Эффективность паузы |
| **Discount acceptance rate** | (принявшие скидку) / (увидевшие предложение скидки) | Эффективность скидки |
| **Upgrade acceptance rate** | (принявшие апгрейд) / (увидевшие предложение апгрейда) | Эффективность апгрейда |

### Сегментация

Все метрики должны поддерживать сегментацию по:
- Тип тарифа (1 / 3 / 6 / 12 мес)
- Trial / не-trial
- Причина отмены
- Платформа (desktop / mobile)
- Возраст подписки (время с момента первой оплаты)

---

## D) Пользовательские и системные сценарии

1. **Given** пользователь нажал «Отменить подписку», **When** флоу открылся, **Then** событие `cancellation_flow_started` отправлено с корректными user_id, subscription_id, plan_months, is_trial.

2. **Given** пользователь выбрал причину `no_time`, **When** нажал «Продолжить», **Then** отправлены события `cancellation_reason_selected` и `cancellation_reason_submitted` с reason_code: `no_time`.

3. **Given** предложение паузы отображено, **When** пользователь видит экран, **Then** событие `save_offer_shown` отправлено с offer_type: `pause`.

4. **Given** пользователь принял скидку 30%, **When** скидка применена, **Then** событие `save_offer_accepted` отправлено с offer_type: `discount`, discount_percent: 30.

5. **Given** пользователь нажал «Всё равно отменить» на экране скидки, **When** переходит к подтверждению, **Then** событие `save_offer_rejected` отправлено с offer_type: `discount`.

6. **Given** trial-пользователь в флоу отмены, **When** save-offer пропущен, **Then** событие `save_offer_skipped` отправлено с skip_reason: `trial`.

7. **Given** пользователь подтвердил отмену, **When** отмена выполнена, **Then** событие `cancellation_confirmed` отправлено с reason_code и access_end_date.

8. **Given** пользователь нажал «Остаться» на экране подтверждения, **When** вернулся в личный кабинет, **Then** событие `cancellation_aborted` отправлено с last_step: `confirmation`.

9. **Given** пользователь закрыл окно на шаге выбора причины, **When** флоу прерван, **Then** событие `cancellation_aborted` отправлено с last_step: `reason`, reason_code: null.

10. **Given** ошибка при отмене подписки, **When** ошибка произошла, **Then** событие `cancellation_error` отправлено с error_type и error_message.

11. **Given** пользователь на 12-месячном тарифе, лимит скидок исчерпан, **When** save-offer пропущен, **Then** событие `save_offer_skipped` отправлено с skip_reason: `max_plan` (для upgrade) и `limit_exhausted` (для discount).

12. **Given** пользователь заполнил мини-опрос (причина `switching`), **When** данные отправлены, **Then** событие `cancellation_survey_submitted` содержит competitor_name или free_text.

---

## E) Acceptance Criteria

- [ ] Все 12 событий из таблицы отправляются в корректных точках флоу
- [ ] Каждое событие содержит обязательные общие свойства (user_id, subscription_id, plan_months, is_trial, timestamp)
- [ ] Каждое событие содержит специфические свойства согласно таблице
- [ ] Воронка: по событиям можно построить полную воронку от started до confirmed/aborted
- [ ] Save rate рассчитывается корректно: по событиям `save_offer_shown` и `save_offer_accepted`
- [ ] Сегментация по тарифу, trial, причине, платформе работает корректно
- [ ] Событие `cancellation_aborted` корректно определяет last_step
- [ ] Дубликаты событий не отправляются (идемпотентность: одно действие = одно событие)
- [ ] События отправляются даже при ошибках в основном флоу (аналитика не блокирует UX)
- [ ] Ошибки отправки аналитики не влияют на работу флоу отмены

---

## F) Аналитика/события

Эта задача является основной задачей по аналитике флоу отмены. Полный список событий и свойств описан в разделе C) Бизнес-правила.

### Дашборд (рекомендуемый)

Рекомендуемые виджеты для дашборда:
1. Воронка отмены (общая и по причинам)
2. Save rate по типу offer (пауза / скидка / апгрейд)
3. Распределение причин отмены (pie chart)
4. Тренд: отмены в день/неделю
5. Save rate в динамике (по неделям)
6. Completion rate по тарифам
7. Топ конкурентов из мини-опроса `switching`

---

## G) Риски и допущения (Assumptions)

### Допущения
- В проекте уже есть инфраструктура для отправки аналитических событий
- Все задачи флоу отмены (C01–C05) будут отправлять события по единому контракту
- Дашборд будет создан в существующем инструменте аналитики
- Аналитические события не должны блокировать основной UX-флоу

### Риски
- Потеря событий при клиентских ошибках (пользователь закрыл вкладку) → использовать надёжный механизм доставки или серверную отправку
- Рассогласование между клиентскими и серверными событиями → определить, какие события отправляются с клиента, какие с сервера
- Чрезмерное количество событий может замедлять UI → отправлять асинхронно, не блокируя

---

## H) Open questions для CTO/разработчиков

1. Какой инструмент аналитики используется в проекте? Есть ли ограничения на количество свойств события?
2. Где отправляются события: на клиенте (фронтенд), на сервере (бэкенд) или и там, и там?
3. Как обрабатывать ситуацию, когда пользователь закрыл вкладку до отправки события?
4. Нужно ли дедуплицировать события (например, при retry после ошибки)?
5. Какой формат timestamp: UTC, timezone пользователя, или оба?
6. Нужно ли отправлять событие при каждом переключении причины (клик) или только при нажатии «Продолжить»?
7. Как определять платформу (desktop/mobile) для сегментации: user-agent, viewport или другой метод?
8. Нужно ли трекать время на каждом шаге (для расчёта time-to-decision)?
9. Есть ли требования к GDPR/персональным данным при отправке user_id и данных опроса?
10. Нужно ли отправлять события в систему A/B-тестирования (для оптимизации save-offers)?
11. Как обрабатывать события для пользователей с заблокированными трекерами (ad blockers)?
12. Нужен ли отдельный дашборд для trial-отмен (trial churn) или достаточно фильтра is_trial?
13. Как часто обновлять дашборд: realtime или с задержкой?
14. Событие `cancellation_error` — нужно ли включать технические детали ошибки или только тип?
15. Нужно ли трекать повторные попытки отмены одним и тем же пользователем? Через session_id или другой механизм?
16. Кто отвечает за создание дашбордов: аналитик, разработчик или продакт?

---

## I) Что убрано из исходника

- **Конкретные названия инструментов аналитики** → заменены на нейтральное «инструмент аналитики»
- **Форматы payload событий** (JSON-схемы) → заменены на таблицы свойств
- **Конкретные методы отправки** (SDK, API) → заменены на «отправка событий»
- **Детали реализации дашборда** → заменены на рекомендуемые виджеты
