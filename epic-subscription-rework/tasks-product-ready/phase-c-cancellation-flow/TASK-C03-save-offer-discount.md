# TASK-C03: Удерживающее предложение — скидка

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-C03 |
| Title | Save-offer: предложение скидки при отмене по причине «Слишком дорого» |
| Phase | C — Cancellation Flow |
| Priority | P1 |

---

## A) Краткое описание

При выборе причины отмены «Слишком дорого» (`too_expensive`) пользователю предлагается удерживающая скидка 30% на следующий биллинговый период. Это основное предложение (primary). Дополнительно показывается вторичное предложение — переход на мультимесячный тариф с более низкой ценой за месяц (подробности в C04).

Скидка применяется однократно (на один биллинговый цикл). Доступность скидки ограничена: не чаще 1 раза в 6 месяцев, лимит общий с win-back-предложениями (D03/D04). Проверка лимита выполняется через механизм C07. Если лимит исчерпан — скидка не предлагается, отображается только предложение перехода на мультимесячный тариф (C04).

---

## B) Scope / Out of Scope

### Scope
- UI экрана предложения скидки (шаг 2 флоу отмены для причины `too_expensive`)
- Основное действие: «Получить скидку 30% на следующий месяц»
- Вторичное действие: предложение перехода на мультимесячный тариф (C04)
- Кнопка «Всё равно отменить»
- Проверка лимита скидок (C07) перед показом
- Применение скидки к следующему биллинговому периоду
- Отображение итоговой цены со скидкой
- Поведение при исчерпанном лимите скидок

### Out of Scope
- Детальная логика перехода на мультимесячный тариф (C04)
- Экран подтверждения отмены (C05)
- Механизм хранения и проверки лимита скидок (C07)
- Win-back-предложения (D03/D04)
- Аналитические события (C06)

---

## C) Бизнес-правила и состояния

### Условия показа предложения скидки
- Причина отмены: `too_expensive`
- Пользователь НЕ на пробном периоде (trial → пропуск save-offer)
- Лимит скидок не исчерпан (проверка через C07)

### Параметры скидки
- Размер скидки: 30%
- Применяется к одному биллинговому циклу
- После скидочного цикла цена возвращается к стандартной

### Расчёт цены со скидкой (месячный тариф)

| Тариф | Стандартная цена | Цена со скидкой 30% |
|-------|-----------------|---------------------|
| 1 месяц | 3 900 ₽ | 2 730 ₽ |

> Для мультимесячных тарифов: продуктовое решение о применении скидки — open question.

### Лимит скидок (реализация — C07)
- 1 retention-скидка за 6 месяцев
- Лимит общий: используется и при отмене (C03), и при win-back (D03/D04)
- Если лимит исчерпан → предложение скидки не показывается

### Действия пользователя

| Действие | Лимит не исчерпан | Лимит исчерпан |
|----------|-------------------|----------------|
| Видит экран | Скидка (primary) + мультимесячный тариф (secondary) + «Всё равно отменить» | Только мультимесячный тариф (C04) + «Всё равно отменить» |
| Принял скидку | Скидка применяется, подписка сохраняется | — |
| Выбрал мультимесячный | Переход к оформлению мультимесячного тарифа (C04) | Переход к оформлению мультимесячного тарифа (C04) |
| Нажал «Всё равно отменить» | Переход к подтверждению (C05) | Переход к подтверждению (C05) |

### Механизм применения скидки
- Платёжный провайдер поддерживает изменение суммы подписки
- Рекомендованный подход из документации провайдера: отмена текущей подписки + разовое списание со скидкой + создание новой подписки с полной ценой
- Альтернативный подход: изменение суммы на 1 период, затем возврат к стандартной — требует механизма автоматического возврата цены
- Конкретный подход — решение CTO/разработчиков

---

## D) Пользовательские и системные сценарии

1. **Given** пользователь выбрал причину `too_expensive`, лимит скидок не исчерпан, **When** переходит на шаг 2, **Then** видит предложение скидки 30% с отображением цены до и после скидки.

2. **Given** пользователь выбрал причину `too_expensive`, лимит скидок исчерпан, **When** переходит на шаг 2, **Then** предложение скидки не отображается, показывается только предложение мультимесячного тарифа (C04) и кнопка «Всё равно отменить».

3. **Given** пользователь на экране скидки, **When** нажимает «Получить скидку 30%», **Then** скидка применяется к следующему биллинговому периоду, подписка сохраняется, пользователь видит подтверждение.

4. **Given** пользователь принял скидку, **When** наступает следующий биллинговый период, **Then** списывается сумма со скидкой (2 730 ₽ вместо 3 900 ₽ для месячного).

5. **Given** пользователь принял скидку, **When** наступает биллинговый период после скидочного, **Then** списывается стандартная сумма (3 900 ₽ для месячного).

6. **Given** пользователь на экране скидки, **When** нажимает «Всё равно отменить», **Then** переходит к экрану подтверждения (C05).

7. **Given** пользователь на экране скидки, **When** выбирает вторичное предложение (мультимесячный тариф), **Then** переходит к экрану выбора мультимесячного тарифа (C04).

8. **Given** пользователь на пробном периоде с причиной `too_expensive`, **When** переходит далее, **Then** экран скидки пропускается (правило из C01).

9. **Given** запрос на применение скидки завершился ошибкой, **When** ошибка обработана, **Then** пользователь видит сообщение об ошибке с возможностью повторить или продолжить отмену.

10. **Given** пользователь получил скидку 2 месяца назад (через win-back D03), **When** пытается отменить с причиной `too_expensive`, **Then** лимит исчерпан, скидка не предлагается.

11. **Given** пользователь получил скидку 7 месяцев назад, **When** пытается отменить с причиной `too_expensive`, **Then** лимит обновился, скидка доступна.

12. **Given** пользователь на мобильном устройстве, **When** видит экран скидки, **Then** все элементы (цена до/после, кнопки) корректно отображаются.

---

## E) Acceptance Criteria

- [ ] При причине `too_expensive` и доступном лимите отображается предложение скидки 30%
- [ ] На экране отображается стандартная цена и цена со скидкой
- [ ] Скидка применяется только к одному биллинговому циклу
- [ ] После скидочного периода цена автоматически возвращается к стандартной
- [ ] При исчерпанном лимите скидка не предлагается, отображается только мультимесячное предложение
- [ ] Лимит скидок корректно проверяется (общий с win-back)
- [ ] После принятия скидки дата последнего использования скидки обновляется
- [ ] Кнопка «Всё равно отменить» ведёт к подтверждению (C05)
- [ ] Экран корректно отображается на desktop и mobile
- [ ] Ошибки при применении скидки обрабатываются с понятным сообщением пользователю

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `save_offer_shown` | user_id, subscription_id, offer_type: `discount`, discount_percent, original_price, discounted_price |
| `save_offer_accepted` | user_id, subscription_id, offer_type: `discount`, discount_percent, discounted_price |
| `save_offer_rejected` | user_id, subscription_id, offer_type: `discount` |
| `save_offer_skipped` | user_id, subscription_id, offer_type: `discount`, skip_reason: `limit_exhausted` |

Подробная аналитика — в задаче C06.

---

## G) Риски и допущения (Assumptions)

### Допущения
- Размер скидки 30% — финальный, согласован с продуктом
- Платёжный провайдер поддерживает изменение суммы подписки — подтверждено из документации
- Лимит скидок (1 за 6 месяцев) — финальный, единый для cancellation и win-back
- Скидка применяется только к месячному тарифу; для мультимесячных требуется отдельное продуктовое решение

### Риски
- Два способа применения скидки через провайдера (изменение суммы vs. отмена + создание новой) имеют разные trade-offs — решение влияет на сложность реализации и надёжность
- Автоматический возврат цены после скидочного периода требует отдельного механизма (периодическая задача или callback)
- Общий лимит с win-back может привести к ситуации, когда пользователь не получает скидку при отмене, потому что недавно получил win-back — может вызвать негативную реакцию

---

## H) Open questions для CTO/разработчиков

1. Какой подход к применению скидки выбрать: изменение суммы на 1 период с последующим возвратом, или отмена + разовое списание со скидкой + создание новой подписки?
2. Если выбран подход «изменение суммы» — как гарантировать автоматический возврат к стандартной цене после скидочного периода?
3. Если выбран подход «отмена + создание» — как обеспечить бесшовность для пользователя (не должен заново вводить данные карты)?
4. Как применять скидку для мультимесячных тарифов (3/6/12 мес)? 30% на весь оставшийся период? На один «эквивалентный месяц»?
5. Нужно ли показывать пользователю, что скидка разовая, прямо на экране предложения?
6. Что происходит, если пользователь принял скидку, но до начала скидочного периода снова инициирует отмену?
7. Как обрабатывать race condition: пользователь принял скидку, но в этот момент произошло автосписание по старой цене?
8. Нужно ли отправлять email-подтверждение о применении скидки?
9. Скидка 30% захардкожена или должна быть настраиваемой (для A/B тестирования разных размеров скидки)?
10. Как отображать скидку в истории платежей / личном кабинете?
11. Нужно ли предупреждать пользователя за N дней до окончания скидочного периода о возврате к полной цене?
12. Если при применении скидки произошла ошибка на стороне провайдера — retry автоматически или показать ошибку пользователю?
13. Нужна ли возможность отмены принятой скидки (для поддержки / админки)?
14. Как корректно учитывать дату использования скидки для лимита: по дате показа предложения или по дате фактического списания со скидкой?
15. Должна ли скидка отображаться в предстоящем списании в личном кабинете до наступления биллингового периода?

---

## I) Что убрано из исходника

- **Ссылка на конкретный метод провайдера** (`subscriptions/update`) → заменена на «платёжный провайдер поддерживает изменение суммы подписки»
- **Детали реализации** (cancel + manual charge + create new) → вынесены как варианты в open questions для CTO
- **Конкретные поля хранилища данных** → заменены на бизнес-правила лимитов
- **Упоминание конкретных технологий** → заменено на нейтральные термины («платёжный провайдер», «биллинговый период»)
