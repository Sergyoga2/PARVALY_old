# TASK-B03: Автоматическая конвертация trial в платную подписку

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B03 |
| Title | Авто-конвертация trial в платную подписку |
| Phase | B — Trial |
| Priority | P0 |

---

## A) Краткое описание

По истечении 7-дневного trial автоматически списать 3 900 ₽ и перевести пользователя на месячную подписку. Это ядро монетизации trial-модели.

Из документации CloudPayments: при подходе с отложенной подпиской (StartDate) провайдер **сам выполняет первое списание** через 7 дней. Задача сводится к **обработке входящих callback-ов** (успех/ошибка) и обновлению состояния в системе. Фоновая задача-мониторинг нужна только как safety net.

---

## B) Scope / Out of Scope

### Scope
- Обработка callback-а об успешном списании (trial → ACTIVE)
- Обработка callback-а о неуспешном списании (trial → GRACE_PERIOD)
- Фоновая задача мониторинга: проверка, что провайдер действительно выполнил списание
- Идемпотентная обработка (повторный callback не вызывает повторных действий)
- **НЕ нужно:** самостоятельно инициировать списание (провайдер делает это сам по StartDate)

### Out of Scope
- Retry / grace period (B07)
- Emails (B06)

---

## C) Бизнес-правила и состояния

### Успешная конвертация (callback «Успех»)
- Подписка переходит: TRIAL → ACTIVE
- Начинается первый оплаченный период (1 месяц)
- Запись об успешной оплате создаётся
- Email «Подписка оформлена» отправляется

### Неуспешная конвертация (callback «Ошибка»)
- Подписка переходит: TRIAL → GRACE_PERIOD
- Провайдер сам выполнит повторные попытки (3 попытки, 1/день, 72ч — из документации CloudPayments)
- Запись о неуспешной попытке создаётся
- Email «Не удалось списать оплату» отправляется

### Safety-net мониторинг
- Периодическая проверка: если trial истёк (+ 1 час buffer), но статус всё ещё TRIAL → алерт (callback не дошёл)
- Мониторинг не инициирует списание, только оповещает

### Идемпотентность
- Если статус подписки уже не TRIAL — callback пропускается
- Уникальный идентификатор транзакции от провайдера как ключ идемпотентности

---

## D) Пользовательские и системные сценарии

1. **Given** trial истёк (7 дней прошли), **When** провайдер успешно списывает 3 900 ₽, **Then** статус → ACTIVE, период = 1 месяц.

2. **Given** trial конвертирован, **When** проверяем подписку, **Then** дата окончания периода = дата конвертации + 1 месяц.

3. **Given** списание не прошло (callback «Ошибка»), **Then** статус → GRACE_PERIOD, провайдер повторит через 24ч.

4. **Given** trial уже отменён пользователем, **When** callback от провайдера, **Then** подписка не трогается (skip).

5. **Given** trial уже конвертирован в ACTIVE, **When** повторный callback, **Then** пропускается (идемпотентно).

6. **Given** два параллельных callback-а, **When** обрабатываются, **Then** только один выполняет конвертацию.

7. **Given** trial истёк более 1 часа назад, статус всё ещё TRIAL, **When** мониторинг запускается, **Then** алерт для команды поддержки.

8. **Given** карта просрочилась за 7 дней trial, **When** провайдер пытается списать, **Then** callback «Ошибка» → GRACE_PERIOD.

9. **Given** успешная конвертация, **When** проверяем запись оплаты, **Then** запись создана с суммой 3 900 ₽ и идентификатором транзакции.

10. **Given** пользователь отменил trial за 10 секунд до callback-а, **When** callback приходит, **Then** проверяется статус, конвертация не выполняется.

---

## E) Acceptance Criteria

- [ ] Callback «Успех» → статус TRIAL → ACTIVE, период = 1 месяц
- [ ] Callback «Ошибка» → статус TRIAL → GRACE_PERIOD
- [ ] Отменённый trial не конвертируется
- [ ] Повторный callback не вызывает повторных действий
- [ ] Мониторинг: алерт если trial не конвертирован через 1 час после окончания
- [ ] Запись об оплате создаётся при успехе и при ошибке

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `trial_converted` | user_id, plan_months, amount |
| `trial_payment_failed` | user_id, attempt_number, error_code |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Провайдер выполняет списание в момент StartDate с погрешностью в минуты — **из документации CloudPayments**
- Callback приходит сразу после попытки списания
- Доступ сохраняется до получения callback-а «Ошибка»

### Риски
- Задержка callback-а от провайдера → safety-net мониторинг
- Двойное списание при сетевых ошибках → идемпотентность по идентификатору транзакции

---

## H) Open questions для CTO/разработчиков

1. Как реализовать мониторинг «trial не конвертирован»: периодическая фоновая задача или событийная модель?
2. Какой интервал для мониторинга: каждые 15 минут, каждый час?
3. Куда отправлять алерт: email, мессенджер, система мониторинга?
4. Нужно ли при конвертации создавать НОВУЮ запись подписки или обновлять существующую?
5. Как обрабатывать ситуацию, когда callback пришёл, но запись подписки ещё не создана в системе (race condition с B02)?
6. Какой тип callback приходит при первом списании по StartDate: Pay или Recurrent?
7. Нужен ли лок на уровне хранилища при обработке callback-а?
8. Как считать начало первого оплаченного периода: от момента списания или от trial_ends_at?
9. Что делать, если мониторинг обнаружил «зависший» trial: автоматически конвертировать или только алерт?
10. Нужно ли предусмотреть обработку backlog (если мониторинг был остановлен на несколько часов)?

---

## I) Что убрано из исходника

- **Ruby-код** (`TrialConversionWebhookHandler`, `TrialExpirationJob`) → заменён на бизнес-правила
- **Конкретные параметры webhook payload** (`subscription_id`, `transaction_id`, `reason_code`) → заменены на «callback от провайдера»
- **Rails-специфичный код** (`find_by!`, `update!`, `deliver_later`) → убран
- **Расписание job** (`каждые 15 минут`) → вопрос для CTO
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
