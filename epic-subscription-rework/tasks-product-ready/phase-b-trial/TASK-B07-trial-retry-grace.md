# TASK-B07: Retry-логика и Grace Period при неуспешном списании

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B07 |
| Title | Retry-логика и grace period для неуспешных платежей |
| Phase | B — Trial |
| Priority | P1 |

---

## A) Краткое описание

Обеспечить корректную обработку неуспешных платежей: при конвертации trial и при renewal обычных подписок. Grace period = 72 часа (3 дня).

Из документации CloudPayments: провайдер **управляет retry нативно** — 3 попытки, 1/день, 72 часа. После 3-й неуспешной попытки провайдер автоматически отменяет подписку. Задача системы — **реагировать на callback-ы** и обновлять состояние, НЕ инициировать retry самостоятельно.

---

## B) Scope / Out of Scope

### Scope
- Grace period: 72 часа (3 дня) — управляется провайдером
- Retry: 3 попытки, 1/день — провайдер делает автоматически
- Обработка callback-ов «Ошибка» и «Успех» для подписок в grace period
- Переходы: GRACE_PERIOD → ACTIVE (при успешном callback) или → EXPIRED/CANCELLED (при исчерпании попыток)
- Доступ сохраняется во время grace period
- Email при каждой неуспешной попытке
- Safety-net мониторинг: алерт если grace period длится дольше 72ч

### Out of Scope
- UI для обновления карты (минимальная кнопка в ЛК — B05)
- Ручная оплата через support

---

## C) Бизнес-правила и состояния

### Retry schedule (провайдер)
- Попытка 1: в момент авто-конвертации/renewal → callback «Ошибка» → GRACE_PERIOD
- Попытка 2: +24ч (автоматически) → callback «Ошибка» или «Успех»
- Попытка 3: +24ч (автоматически) → callback «Ошибка» или «Успех»
- После 3-й неуспешной: провайдер отменяет подписку → callback «Отмена»

### Доступ во время grace period
- GRACE_PERIOD = доступ **сохранён** (как при ACTIVE)
- Стимулирует пользователя обновить карту

### Правила при исчерпании попыток
- **Месячный тариф (период истёк):** статус → EXPIRED, доступ закрыт
- **Мультимесячный (оплаченный период ещё идёт):** статус → CANCELLED, доступ до конца оплаченного периода

### Восстановление
- Если retry провайдера успешен (callback «Успех»): GRACE_PERIOD → ACTIVE, период обновлён

---

## D) Пользовательские и системные сценарии

1. **Given** первый callback «Ошибка», **When** авто-конвертация/renewal, **Then** статус = GRACE_PERIOD, доступ сохранён.

2. **Given** grace period + callback «Успех» (retry провайдера), **Then** статус → ACTIVE, период обновлён.

3. **Given** 3 callback-а «Ошибка» подряд (месячный), **Then** статус → EXPIRED, доступ закрыт.

4. **Given** 3 callback-а «Ошибка» подряд (6-мес, период не истёк), **Then** статус → CANCELLED, доступ до конца периода.

5. **Given** grace period, **When** пользователь отменяет подписку, **Then** статус → CANCELLED, провайдер прекращает retry.

6. **Given** grace period, **When** пользователь обновил карту у провайдера, **Then** следующий retry использует новую карту.

7. **Given** grace period длится >72ч (webhook не дошёл), **When** мониторинг, **Then** алерт для команды.

8. **Given** callback «Ошибка» #2, **When** обрабатывается, **Then** запись о неуспешной попытке создана, email пользователю.

9. **Given** grace period, **When** проверяем доступ, **Then** доступ полный (как ACTIVE).

10. **Given** callback «Успех» после 2-й неуспешной попытки, **When** обрабатывается, **Then** GRACE_PERIOD → ACTIVE, email «Оплата прошла».

---

## E) Acceptance Criteria

- [ ] Первый callback «Ошибка» → GRACE_PERIOD, доступ сохранён
- [ ] Callback «Успех» во время grace period → ACTIVE, период обновлён
- [ ] 3 неуспешных попытки (месячный) → EXPIRED, доступ закрыт
- [ ] 3 неуспешных попытки (мультимесячный, период не истёк) → CANCELLED, доступ до конца периода
- [ ] Отмена во время grace period → CANCELLED, retry прекращён
- [ ] Мониторинг: алерт при grace period > 72ч
- [ ] Email при каждой неуспешной попытке

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `subscription_payment_failed` | user_id, attempt_number, error_code |
| `subscription_payment_recovered` | user_id, attempt_number |
| `subscription_expired_payment_failed` | user_id, total_attempts |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Провайдер управляет retry автоматически — **подтверждено из документации CloudPayments**: 3 попытки, 1/день
- Провайдер позволяет обновить карту через свою страницу (my.cloudpayments.ru)
- Callback «Ошибка» приходит при каждой неуспешной попытке

### Риски
- Callback не дошёл (сетевая проблема) → safety-net мониторинг + ручная проверка через API провайдера
- Провайдер изменит retry-логику → абстракция, мониторинг

---

## H) Open questions для CTO/разработчиков

1. Как считать номер попытки (attempt_number), если провайдер не передаёт его в callback?
2. Нужно ли предусмотреть собственный механизм retry как fallback (если провайдер изменит поведение)?
3. Как реализовать обновление карты: через страницу провайдера, собственную форму, или оба варианта?
4. Нужен ли grace period для trial-конвертации отдельно от renewal grace period?
5. Как обрабатывать callback «Отмена» от провайдера (после 3-х неуспешных): отдельный handler или общий?
6. Нужно ли показывать пользователю номер попытки («2-я из 3-х»)?
7. Какой интервал для safety-net мониторинга: каждый час, каждые 15 минут?
8. Нужно ли логировать причину отказа оплаты (insufficient funds, expired card, etc.) для аналитики?
9. Что происходит, если пользователь обновил карту, но retry уже прошёл неуспешно: нужно ли запросить ручной retry?
10. Нужна ли admin-панель для ручного управления grace period (продление, принудительное закрытие)?

---

## I) Что убрано из исходника

- **Ruby-код** (`GracePeriodWebhookHandler`, `GracePeriodMonitorJob`, `expire_subscription`) → заменён на бизнес-правила
- **Конкретные webhook-поля** (`subscription_id`, `transaction_id`, `reason_code`) → заменены на «callback от провайдера»
- **Конкретное расписание job** (`каждый час`) → вопрос для CTO
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
