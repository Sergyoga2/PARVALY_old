# TASK-B06: Email-уведомления trial (юридически обязательные)

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B06 |
| Title | Email-уведомления trial: welcome, напоминания, конвертация |
| Phase | B — Trial |
| Priority | P0 |

---

## A) Краткое описание

Юридически обязательные уведомления перед автоматическим списанием: пользователь должен быть предупреждён за 24 часа и за 1 час до окончания trial. Также — welcome email для онбординга и email при конвертации/отмене/ошибке оплаты.

Уведомления T4 (за 24ч) и T5 (за 1ч) являются **transactional** и отправляются даже при отписке от маркетинговых рассылок.

---

## B) Scope / Out of Scope

### Scope
- T1: Welcome email (при активации trial) — немедленно
- T4: Email за 24 часа до окончания trial (юридический) — по расписанию
- T5: Email за 1 час до окончания trial (юридический) — по расписанию
- T6: Email при конвертации (подписка оформлена) — немедленно
- T7: Email при отмене trial — немедленно
- T8: Email при неуспешном списании — немедленно
- Идемпотентность: каждый email отправляется однократно
- Отложенная отправка T4, T5 по расписанию

### Out of Scope
- T2, T3: вовлечение (день 3, день 5) — Phase D
- Win-back серия — Phase D
- Финальные тексты email (утверждаются с маркетингом)

---

## C) Бизнес-правила и состояния

### Обязательное содержание email

**T4 (за 24ч) — юридически обязательный:**
- Дата и время списания
- Сумма: 3 900 ₽
- Как отменить: ссылка на ЛК → отмена
- «Если хотите продолжить — ничего делать не нужно»

**T5 (за 1ч) — юридически обязательный:**
- «Через 1 час будет списано 3 900 ₽»
- Быстрая ссылка на отмену

**T6 (конвертация):**
- Подписка оформлена, сумма списана
- Дата следующего списания
- Upsell: «Сэкономьте до 38% с тарифом на 6 или 12 месяцев»

### Правила отправки
- T4, T5: отправляются только если статус = TRIAL (не отменён)
- T4, T5: transactional (отправляются даже при отписке от маркетинга)
- Каждый email одного типа отправляется один раз на подписку (идемпотентность)
- При ошибке отправки (SMTP): retry, но НЕ блокировать авто-конвертацию

---

## D) Пользовательские и системные сценарии

1. **Given** trial активирован, **When** немедленно, **Then** email T1 (welcome) отправлен.

2. **Given** trial active, **When** trial_ends_at - 24ч, **Then** email T4 отправлен с датой и суммой.

3. **Given** trial active, **When** trial_ends_at - 1ч, **Then** email T5 отправлен.

4. **Given** trial cancelled перед T4/T5, **When** наступает запланированное время, **Then** email НЕ отправлен.

5. **Given** email T4 уже отправлен, **When** задача перезапускается, **Then** дубликат НЕ отправлен.

6. **Given** trial конвертирован, **When** немедленно, **Then** email T6 отправлен с upsell.

7. **Given** trial payment failed, **When** немедленно, **Then** email T8 отправлен.

8. **Given** trial отменён, **When** немедленно, **Then** email T7 отправлен.

9. **Given** email T5 задержался (отправлен за 30 мин вместо 1ч), **When** проверяем, **Then** допустимо — главное до списания.

10. **Given** пользователь отписался от маркетинга, **When** T4/T5, **Then** всё равно отправляются (transactional).

---

## E) Acceptance Criteria

- [ ] T1 отправляется немедленно при активации trial
- [ ] T4 отправляется за 24ч до окончания trial
- [ ] T5 отправляется за 1ч до окончания trial
- [ ] T4 и T5 содержат обязательную информацию (дата, сумма, ссылка отмены)
- [ ] Отменённый trial: T4/T5 НЕ отправляются
- [ ] Идемпотентность: дубликаты не отправляются
- [ ] T6 отправляется при конвертации, T8 при ошибке оплаты
- [ ] T4/T5 отправляются даже при отписке от маркетинга (transactional)

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `trial_email_sent` | user_id, email_type (T1/T4/T5/T6/T7/T8) |
| `trial_email_opened` | user_id, email_type (если отслеживание включено) |
| `trial_email_clicked` | user_id, email_type, link (если отслеживание включено) |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Инфраструктура отправки email уже существует
- Есть механизм отложенной отправки (scheduled emails)
- SPF/DKIM/DMARC настроены для домена

### Риски
- Email попадает в спам → пользователь не увидит T4/T5 → проверить deliverability
- Задержка в очереди отправки → T5 приходит после списания → выделенная очередь для time-critical emails

---

## H) Open questions для CTO/разработчиков

1. Как реализовать отложенную отправку T4 и T5: фоновая задача по расписанию, отложенное сообщение в очереди, или scheduled job при создании trial?
2. Какой механизм идемпотентности: лог отправленных email, уникальный ключ, или другой?
3. Нужна ли отдельная очередь для time-critical emails (T5)?
4. В каком timezone показывать дату/время в email?
5. Являются ли T4/T5 юридически обязательными в РФ? Какие регуляторные требования?
6. Нужно ли отслеживать открытие email (pixel tracking)?
7. Кто утверждает тексты email: маркетинг, юристы, product?
8. Нужен ли email T7 (отмена trial) или это nice-to-have?
9. Как обрабатывать bounce (email не доставлен): retry, алерт, или игнорировать?
10. Нужно ли в T6 (конвертация) включать чек/квитанцию об оплате?
11. Максимально допустимая задержка отправки T5 (за 1ч): 30 мин, 15 мин?
12. Нужен ли механизм ручной переотправки email (admin tool)?

---

## I) Что убрано из исходника

- **Ruby-код** (`TrialReminderJob`, `TrialMailer`, `EmailLog`) → заменён на бизнес-правила
- **SQL-таблица `email_logs`** → заменена на требование идемпотентности
- **Конкретные имена email-шаблонов** (`day_before_charge`, `hour_before_charge`) → заменены на T4, T5
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
