# TASK-B04: Отмена trial-подписки

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B04 |
| Title | Отмена trial-подписки пользователем |
| Phase | B — Trial |
| Priority | P0 |

---

## A) Краткое описание

Пользователь должен иметь возможность отменить trial в любой момент в течение 7 дней. Это юридическое требование и важный UX-элемент доверия. При отмене: доступ сохраняется до конца trial-периода, списания не происходит. После окончания trial — доступ закрывается.

---

## B) Scope / Out of Scope

### Scope
- Отмена trial: изменение статуса, отмена запланированного списания у провайдера
- Сохранение доступа до конца trial-периода (trial_ends_at)
- После trial_ends_at: статус → EXPIRED, доступ закрыт
- Защита от авто-конвертации: отменённый trial не конвертируется (B03)
- Минимальная UI: кнопка отмены в ЛК с диалогом подтверждения
- Идемпотентность: повторная отмена — успешный ответ без ошибки

### Out of Scope
- Cancellation flow с причинами (Phase C)
- Win-back серия после отмены (Phase D)

---

## C) Бизнес-правила и состояния

### Правила отмены
- Отмена доступна только для подписок со статусом TRIAL
- При отмене: статус → CANCELLED, дата отмены фиксируется
- Доступ сохраняется до trial_ends_at
- Флаг «trial использован» остаётся true (повторный trial невозможен)
- Запланированное списание у провайдера отменяется
- Отменённый trial-пользователь может в любой момент купить платный тариф

### Закрытие доступа
- Когда trial_ends_at наступает для отменённого trial → статус EXPIRED, доступ закрыт

### Подтверждение отмены
- Диалог: «Вы уверены? Доступ сохранится до [дата]. После этого потребуется оплата.»

---

## D) Пользовательские и системные сценарии

1. **Given** пользователь в trial, **When** отменяет, **Then** статус = CANCELLED, доступ сохранён до trial_ends_at.

2. **Given** trial отменён, **When** trial_ends_at наступает, **Then** статус = EXPIRED, доступ закрыт.

3. **Given** trial отменён, **When** авто-конвертация (B03) проверяет, **Then** пропускается (не конвертируется).

4. **Given** trial отменён, **When** пользователь пытается отменить повторно, **Then** идемпотентный ответ (успех).

5. **Given** trial отменён, **When** пользователь хочет купить платный тариф, **Then** покупка доступна.

6. **Given** пользователь не в trial (active/expired), **When** пытается отменить trial, **Then** ошибка «Нет активного trial».

7. **Given** отмена за 1 минуту до авто-конвертации, **When** callback от провайдера приходит, **Then** проверяется текущий статус, конвертация не выполняется.

8. **Given** trial отменён, **When** пользователь покупает 6-мес тариф, **Then** новая подписка создаётся, trial → expired.

9. **Given** trial отменён, доступ ещё есть, **When** пользователь пользуется контентом, **Then** доступ полный до trial_ends_at.

10. **Given** trial отменён, **When** email-напоминания (T4, T5) запланированы, **Then** напоминания НЕ отправляются (проверка статуса).

---

## E) Acceptance Criteria

- [ ] Отмена trial → статус CANCELLED, доступ до trial_ends_at
- [ ] После trial_ends_at → статус EXPIRED, доступ закрыт
- [ ] Авто-конвертация не происходит для отменённого trial
- [ ] Повторная отмена — идемпотентный ответ
- [ ] Покупка платного тарифа доступна после отмены trial
- [ ] Запланированные email-напоминания не отправляются для отменённого trial

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `trial_cancelled` | user_id, day_of_trial (на какой день отменил) |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Отмена подписки у провайдера до StartDate гарантирует отсутствие списания — **нужно подтвердить в sandbox**
- Флаг «trial использован» не сбрасывается при отмене

### Риски
- Race condition: отмена vs авто-конвертация одновременно → необходим лок на уровне хранилища

---

## H) Open questions для CTO/разработчиков

1. Как обеспечить атомарность отмены (обновить статус + отменить у провайдера): если одно из действий не удалось?
2. Как реализовать закрытие доступа после trial_ends_at: фоновая задача, проверка при каждом запросе, или комбинация?
3. Нужно ли отменять запланированные email-напоминания или достаточно проверки статуса перед отправкой?
4. Что если отмена у провайдера не удалась (сетевая ошибка): повторить, алерт, или поставить в очередь?
5. Нужно ли логировать причину отмены trial (для аналитики) или это только в Phase C?
6. Может ли пользователь «передумать» после отмены trial (восстановить)?
7. Если пользователь покупает платный тариф во время отменённого trial — когда начинается платный период?
8. Нужен ли отдельный email при отмене trial (T7)?
9. Как обрабатывать ситуацию, когда пользователь отменил trial, а callback от провайдера приходит с небольшой задержкой?
10. Нужно ли в диалоге подтверждения показывать, что trial использован и повторный невозможен?

---

## I) Что убрано из исходника

- **Ruby-код** (`TrialCancellationService`, `CancelledExpirationJob`) → заменён на бизнес-правила
- **API endpoint** (`DELETE /api/trial`) и Response JSON → убраны
- **ASCII wireframe** диалога подтверждения → заменён на описание
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
