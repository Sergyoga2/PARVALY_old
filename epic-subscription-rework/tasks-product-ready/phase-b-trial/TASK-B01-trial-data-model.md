# TASK-B01: Модель данных для пробного периода (trial)

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B01 |
| Title | Модель данных для пробного периода |
| Phase | B — Trial |
| Priority | P0 |

---

## A) Краткое описание

Расширить модель данных подписок для поддержки пробного периода (trial). Необходимо добавить возможность хранить даты начала и окончания trial-периода, отслеживать факт использования trial на уровне пользователя, а также ввести новые статусы подписки: «пробный период» и «льготный период» (grace period).

Задача является фундаментом для всех последующих задач Phase B. Без этих данных невозможно реализовать активацию, конвертацию, отмену и аналитику trial-периода. Помимо новых полей, необходимо провести обратную миграцию (backfill) для существующих подписчиков, чтобы пометить их как использовавших trial (они не должны получить trial повторно).

---

## B) Scope / Out of Scope

### Scope
- Возможность хранить дату начала и дату окончания пробного периода для подписки
- Возможность хранить факт использования пробного периода на уровне пользователя (использовал / не использовал, когда использовал)
- Новые статусы подписки: TRIAL (пробный период) и GRACE_PERIOD (льготный период после неуспешного списания)
- Валидация: один пользователь может использовать trial только один раз
- Валидация: пользователь, ранее имевший оплаченную подписку, не может активировать trial
- Обратная миграция (backfill): все существующие подписчики помечаются как «trial использован»
- Обратимость миграции (rollback)

### Out of Scope
- Логика активации trial (B02)
- Логика конвертации trial в платную подписку (B03)
- Логика отмены trial (B04)
- UI-изменения (B05)
- Интеграция с платёжным провайдером

---

## C) Бизнес-правила и состояния

### Расширенная диаграмма статусов подписки

| Статус | Описание | Доступ к контенту |
|--------|----------|-------------------|
| TRIAL | Пробный период (7 дней), карта привязана, списаний ещё не было | Полный |
| ACTIVE | Оплаченная подписка, действует | Полный |
| GRACE_PERIOD | Первое списание не прошло, провайдер выполняет retry (до 72 часов) | Полный |
| CANCELLED | Подписка отменена, но оплаченный период не истёк | Полный (до конца оплаченного периода) |
| EXPIRED | Подписка истекла (period ended или все retry неуспешны) | Нет |

### Правила trial-периода
- Trial длится ровно 7 дней
- Один пользователь может использовать trial только один раз за всё время существования аккаунта
- Пользователь, который ранее имел или имеет оплаченную подписку, не может активировать trial
- Факт использования trial сохраняется навсегда (даже если trial отменён досрочно)
- Дата использования trial фиксируется для аналитики

### Правила backfill
- Все пользователи, у которых есть или была подписка (любого статуса), помечаются как «trial использован»
- Дата «trial использован» для таких пользователей не устанавливается (или устанавливается как дата миграции)
- Backfill не меняет статусы и параметры существующих подписок

---

## D) Пользовательские и системные сценарии

1. **Given** новый пользователь без истории подписок, **When** система проверяет доступность trial, **Then** trial доступен (факт использования = false).

2. **Given** пользователь активировал trial, **When** проверяется его факт использования trial, **Then** факт = true, дата зафиксирована.

3. **Given** пользователь с активной оплаченной подпиской, **When** система проверяет доступность trial, **Then** trial недоступен.

4. **Given** пользователь с истёкшей подпиской (EXPIRED), **When** система проверяет доступность trial, **Then** trial недоступен (бывший подписчик).

5. **Given** backfill выполнен, **When** проверяются все существующие подписчики, **Then** у всех факт использования trial = true.

6. **Given** backfill выполнен, **When** проверяются существующие подписки, **Then** ни одна подписка не изменила статус, тариф или суммы.

7. **Given** подписка в статусе TRIAL, **When** система запрашивает список активных подписок с доступом к контенту, **Then** TRIAL-подписка включена в результат.

8. **Given** подписка в статусе GRACE_PERIOD, **When** система проверяет доступ к контенту, **Then** доступ предоставлен (grace period = полный доступ).

9. **Given** пользователь отменил trial досрочно, **When** проверяется его факт использования trial, **Then** факт = true (отмена trial не сбрасывает флаг).

10. **Given** необходимость отката, **When** выполняется rollback миграции, **Then** новые поля и статусы удалены, система вернулась в прежнее состояние.

11. **Given** пользователь, помеченный backfill как «trial использован», **When** пытается активировать trial, **Then** система отказывает с понятным сообщением.

12. **Given** подписка со статусом TRIAL, **When** запрашивается дата окончания trial, **Then** возвращается корректная дата (дата начала + 7 дней).

---

## E) Acceptance Criteria

- [ ] В модели подписки доступны поля для хранения даты начала и окончания trial
- [ ] В модели пользователя доступны поля для хранения факта использования trial и даты использования
- [ ] Статус TRIAL добавлен к набору допустимых статусов подписки
- [ ] Статус GRACE_PERIOD добавлен к набору допустимых статусов подписки
- [ ] Подписки в статусе TRIAL и GRACE_PERIOD предоставляют полный доступ к контенту
- [ ] Валидация: невозможно создать подписку с trial, если у пользователя trial уже использован
- [ ] Валидация: невозможно активировать trial для бывшего подписчика (любой прошлый статус подписки)
- [ ] Backfill: все существующие подписчики помечены как «trial использован»
- [ ] Backfill не изменяет существующие подписки (статус, тариф, суммы)
- [ ] Миграция обратима (rollback)

---

## F) Аналитика/события

Нет аналитических событий в этой задаче (только изменения модели данных). Аналитика активации и конвертации — в задачах B02, B03, B08.

---

## G) Риски и допущения (Assumptions)

### Допущения
- Текущая модель подписки поддерживает расширение новыми полями без нарушения существующей логики (additive изменения)
- 7 дней — финальная длительность trial, согласованная с продуктом
- Один аккаунт = один пользователь (в V1 не учитываются shared-аккаунты)
- Подтверждено из документации CloudPayments: платёжный провайдер не имеет нативной поддержки trial-периода — trial реализуется на стороне приложения через параметр отложенного старта подписки (StartDate)

### Риски
- Backfill для большого количества пользователей может занять значительное время — необходимо оценить объём данных и запланировать online-миграцию
- Добавление новых статусов может затронуть существующие запросы, фильтрующие по статусу — необходим аудит
- Критерий «бывший подписчик» может быть неоднозначен: нужно определить, считается ли бывшим тот, кто начинал оформление, но не оплатил

---

## H) Open questions для CTO/разработчиков

1. Как хранить факт использования trial: отдельное поле на уровне пользователя или вычислять из истории подписок?
2. Нужно ли хранить причину, по которой trial недоступен (бывший подписчик / уже использовал / другое)?
3. Как определять «бывшего подписчика»: любой статус подписки в прошлом или только ACTIVE/CANCELLED/EXPIRED?
4. Нужна ли отдельная сущность «trial-период» или достаточно полей в подписке?
5. Какова стратегия backfill: online без downtime или с maintenance window?
6. Нужно ли хранить «дату использования trial» для пользователей, помеченных backfill-ом?
7. Есть ли сервисы, которые фильтруют подписки по статусу и могут сломаться при появлении TRIAL и GRACE_PERIOD?
8. Нужна ли возможность программного сброса флага «trial использован» (например, для поддержки или промоакций)?
9. Как обрабатывать переход TRIAL → GRACE_PERIOD, если первая оплата не прошла?
10. Нужно ли версионирование данных trial (например, если в будущем trial станет 14 дней)?
11. Нужен ли индекс для быстрой выборки пользователей, доступных для trial (для маркетинга)?
12. Как обеспечить атомарность: факт использования trial + создание подписки должны быть в одной транзакции?
13. Нужно ли хранить источник trial-активации (органический, промокод, реферал) уже на уровне модели данных?
14. Как обрабатывать edge case: пользователь удалил аккаунт и зарегистрировался заново — trial доступен?

---

## I) Что убрано из исходника

- **Конкретные имена полей** (`trial_started_at`, `trial_ends_at`, `trial_used`, `trial_used_at`) → заменены на описание бизнес-данных, которые необходимо хранить
- **Конкретное перечисление enum-значений** (`SubscriptionStatus::TRIAL`, `GRACE_PERIOD`) → заменены на описание статусов и их смысла
- **Конкретные SQL-миграции и backfill-скрипты** → заменены на бизнес-требование backfill
- **Конкретные валидации** (проверка `user.trial_used`) → заменены на бизнес-правила ограничения trial
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
