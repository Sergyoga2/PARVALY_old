# TASK-B02: Активация trial-периода

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B02 |
| Title | Активация trial: привязка карты и старт 7-дневного бесплатного периода |
| Phase | B — Trial |
| Priority | P0 |

---

## A) Краткое описание

Реализовать основную механику trial: пользователь привязывает карту, получает 7 дней полного доступа бесплатно. Карта токенизируется для последующего автоматического списания по окончании trial.

Из документации CloudPayments: провайдер **не поддерживает** нативный trial-период. Рекомендуемый подход — создание подписки с отложенной датой первого списания (параметр StartDate = now + 7 дней). Альтернативный подход — сохранение токена карты и создание подписки через 7 дней собственной фоновой задачей.

---

## B) Scope / Out of Scope

### Scope
- Привязка карты пользователя через виджет провайдера (токенизация)
- Создание подписки со статусом TRIAL и периодом 7 дней
- Установка флага «trial использован» для пользователя
- Открытие полного доступа к 56 навыкам (без профессий)
- Планирование email-напоминаний за 24ч и 1ч до окончания trial
- Отправка welcome email
- Атомарность операции: если привязка карты не удалась — ничего не создаётся

### Out of Scope
- Автоматическая конвертация trial → paid (B03)
- Отмена trial (B04)
- UI (B05)

---

## C) Бизнес-правила и состояния

### Условия активации trial
- Пользователь авторизован
- Email верифицирован (для отправки обязательных уведомлений)
- Пользователь ранее не использовал trial (флаг «trial использован» = false)
- Пользователь ранее не имел платной подписки
- У пользователя нет активной подписки

### Действия при активации
1. Привязка карты через виджет провайдера
2. Создание подписки с отложенным первым списанием (через 7 дней) — из документации CloudPayments: параметр StartDate задаёт дату первого списания
3. Сохранение подписки в системе со статусом TRIAL
4. Установка флага «trial использован» = true
5. Открытие доступа к контенту подписки
6. Планирование email-напоминаний (T4: за 24ч, T5: за 1ч)
7. Отправка welcome email (T1)

### Особенности интеграции с провайдером
- Из документации CloudPayments: 3D Secure применяется **только при первом платеже** (привязка карты), не при рекуррентных списаниях
- Из документации CloudPayments: возможен верификационный платёж на минимальную сумму (1 ₽) для валидации карты — **нужно проверить в sandbox**, достаточно ли tokenize: true без списания
- Из документации CloudPayments: отмена trial до StartDate = отмена подписки у провайдера, списания не произойдёт

---

## D) Пользовательские и системные сценарии

1. **Given** новый пользователь с верифицированным email, **When** привязывает карту, **Then** trial активируется на 7 дней, доступ открыт.

2. **Given** trial активирован, **When** проверяем доступ, **Then** 56 навыков доступны, профессии — нет.

3. **Given** trial активирован, **When** проверяем пользователя, **Then** флаг «trial использован» = true.

4. **Given** пользователь уже использовал trial, **When** попытка повторной активации, **Then** ошибка «Trial уже использован».

5. **Given** пользователь ранее имел платную подписку (expired), **When** попытка trial, **Then** ошибка «Trial недоступен бывшим подписчикам».

6. **Given** карта отклонена при привязке, **When** активация trial, **Then** ошибка, trial НЕ создан, флаг НЕ изменён.

7. **Given** trial активирован, **When** проверяем запланированные уведомления, **Then** напоминания за 24ч и 1ч запланированы.

8. **Given** два параллельных запроса на активацию, **When** обрабатываются, **Then** только один успешен, второй — ошибка.

9. **Given** пользователь без верифицированного email, **When** попытка trial, **Then** ошибка «Необходимо подтвердить email».

10. **Given** API провайдера недоступен, **When** активация trial, **Then** повторные попытки (до 2), затем ошибка пользователю, ничего не создано.

11. **Given** trial активирован, **When** проверяем дату окончания, **Then** trial_ends_at = момент активации + ровно 7 дней.

12. **Given** trial активирован, **When** welcome email, **Then** email T1 отправлен немедленно.

---

## E) Acceptance Criteria

- [ ] Trial активируется на 7 дней при успешной привязке карты
- [ ] Полный доступ к 56 навыкам (без профессий) открыт
- [ ] Флаг «trial использован» устанавливается при активации
- [ ] Повторная активация trial невозможна
- [ ] Trial недоступен бывшим подписчикам
- [ ] При ошибке привязки карты: ничего не создаётся (атомарность)
- [ ] Email-напоминания за 24ч и 1ч запланированы
- [ ] Welcome email отправлен
- [ ] Параллельные запросы: только один проходит

---

## F) Аналитика/события

| Событие | Обязательные свойства |
|---------|----------------------|
| `trial_started` | user_id, source |
| `trial_card_declined` | user_id, error_code |

---

## G) Риски и допущения (Assumptions)

### Допущения
- Провайдер поддерживает создание подписки с отложенной датой первого списания — **из документации CloudPayments: параметр StartDate**
- Отмена подписки до StartDate не вызывает списания — **нужно подтвердить в sandbox**
- 3D Secure при привязке карты обрабатывается виджетом inline — **из документации CloudPayments**

### Риски
- Провайдер может требовать ненулевой платёж для токенизации → fallback: верификационный платёж 1 ₽
- Часовые пояса: trial_ends_at должен считаться в UTC
- Токенизация без списания может не работать у некоторых банков → проверить в sandbox

---

## H) Open questions для CTO/разработчиков

1. Какой подход к trial выбрать: отложенная подписка (StartDate) или сохранение токена + создание подписки через 7 дней?
2. Нужен ли верификационный платёж (1 ₽) для привязки карты или достаточно токенизации без списания?
3. Как обеспечить атомарность: если подписка создана у провайдера, но запись в системе не удалась?
4. Нужно ли хранить токен карты в системе, если подписка создаётся у провайдера сразу?
5. Как реализовать планирование email-напоминаний: фоновая очередь, отложенные задачи, или другой механизм?
6. В каком timezone считать trial_ends_at?
7. Нужна ли проверка verified email перед trial или это проверяется раньше (при регистрации)?
8. Как обрабатывать 3D Secure: полностью через виджет или есть серверная часть?
9. Нужен ли отдельный endpoint для trial или расширять существующий purchase flow?
10. Какие данные карты можно/нужно сохранять (last4, exp_date) для UI и антифрода?
11. Что происходит, если пользователь одновременно имеет cancelled trial и пытается активировать новый?
12. Нужно ли предусмотреть sandbox-тестирование как отдельный Spike перед реализацией?

---

## I) Что убрано из исходника

- **Ruby-код** (`TrialService.activate`, `CloudPaymentsClient.create_subscription`) → заменён на бизнес-правила
- **Конкретные параметры API** (`Token`, `AccountId`, `Amount`, `Interval`, `Period`, `StartDate`) → заменены на описание взаимодействия с провайдером
- **API endpoint** (`POST /api/trial/activate`) и Request/Response JSON → заменены на описание flow
- **JavaScript-код виджета** (`cp.CloudPayments`, `widget.start`) → заменён на «виджет провайдера»
- **Конкретные имена scheduled jobs** (`TrialReminderJob`) → заменены на «планирование email-напоминаний»
- **Test Cases** → трансформированы в Acceptance Criteria и сценарии
