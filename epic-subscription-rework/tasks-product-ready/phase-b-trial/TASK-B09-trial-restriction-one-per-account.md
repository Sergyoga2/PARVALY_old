# TASK-B09: Ограничение — один trial на аккаунт

## Meta

| Поле | Значение |
|------|----------|
| ID | TASK-B09 |
| Title | Ограничение: один trial на аккаунт |
| Phase | B — Trial |
| Priority | P1 |

---

## A) Краткое описание

Предотвратить повторное использование trial одним пользователем. V1: ограничение на уровне аккаунта (по идентификатору пользователя). Мониторинг масштаба abuse без автоматических блокировок.

---

## B) Scope / Out of Scope

### Scope
- Проверка флага «trial использован» перед активацией
- Возможность запросить доступность trial для пользователя (для UI)
- Логирование отклонённых попыток для мониторинга abuse
- Подготовка данных для антифрод-дашборда (Phase D)

### Out of Scope
- Дедупликация по токену карты (Phase D, антифрод)
- Ограничения по IP (Phase D)
- Device fingerprinting (не планируется)

---

## C) Бизнес-правила и состояния

### Доступность trial

| Условие | Trial доступен | Причина |
|---------|:---:|---------|
| Новый пользователь, нет подписки | Да | — |
| trial_used = true | Нет | already_used |
| Есть активная подписка | Нет | has_subscription |
| Был платным подписчиком ранее | Нет | was_subscriber |

### Логирование abuse
- При каждой попытке активации trial (успешной и отклонённой) логировать: идентификатор пользователя, email, IP, результат, время
- В Phase D: агрегация по IP и карте для обнаружения abuse patterns

---

## D) Пользовательские и системные сценарии

1. **Given** trial_used = false, нет подписки, **When** проверяем доступность, **Then** trial доступен.
2. **Given** trial_used = true, **When** проверяем, **Then** trial недоступен, причина: already_used.
3. **Given** активная подписка, **When** проверяем, **Then** trial недоступен, причина: has_subscription.
4. **Given** бывший платный подписчик (expired), **When** проверяем, **Then** trial недоступен, причина: was_subscriber.
5. **Given** отклонённая попытка trial, **When** проверяем логи, **Then** запись с user_id, IP, success: false.
6. **Given** успешная активация trial, **When** проверяем логи, **Then** запись с user_id, IP, success: true.
7. **Given** UI запрашивает доступность trial, **When** ответ получен, **Then** CTA показывается/скрывается.
8. **Given** пользователь создал новый аккаунт для повторного trial, **When** V1, **Then** trial доступен (принятый риск V1).

---

## E) Acceptance Criteria

- [ ] Запрос доступности trial возвращает корректный результат для всех условий
- [ ] Отклонённые попытки логируются с user_id и IP
- [ ] UI корректно скрывает/показывает trial CTA на основе доступности
- [ ] Повторная активация trial для пользователя с trial_used=true невозможна

---

## F) Аналитика/события

Нет дополнительных событий (используются события из B08: `trial_started`, `trial_card_declined`).

---

## G) Риски и допущения (Assumptions)

### Допущения
- V1: ограничение только по user_id; пользователь может обойти через новый аккаунт
- Антифрод (по карте/IP) реализуется в Phase D

### Риски
- Abuse через множественные аккаунты — принятый риск V1, мониторинг в Phase D

---

## H) Open questions для CTO/разработчиков

1. Как реализовать API проверки доступности trial: отдельный endpoint или поле в данных пользователя?
2. Где хранить логи попыток: основное хранилище, отдельный лог, или аналитическая система?
3. Нужно ли отображать причину недоступности trial пользователю?
4. Какие данные логировать при попытке: user_id, email, IP, user_agent? Есть ли ограничения GDPR?
5. Нужна ли admin-панель для просмотра логов попыток?
6. Как определять «бывший подписчик» для блокировки trial: по наличию любой подписки в истории?
7. Нужно ли блокировать trial для пользователей с cancelled (но ещё имеющих доступ) подпиской?
8. Как обрабатывать edge case: пользователь имел trial, отменил, expired — может ли повторно?
9. Срок хранения логов abuse?
10. Нужна ли rate-limiting на endpoint проверки доступности trial?

---

## I) Что убрано из исходника

- **Ruby-код** (`TrialAbuseLogger`, `Current.ip_address`) → заменён на бизнес-правила логирования
- **API endpoint** (`GET /api/trial/availability`) и Response JSON → заменён на описание
- **Test Cases** → трансформированы в Acceptance Criteria
