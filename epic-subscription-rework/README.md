# EPIC: Переработка подписочной модели Hexlet

## 1. Краткое summary

Полная переработка тарифной сетки подписки Hexlet: переход от трёх тарифов (1 мес / 12 мес / 36 мес) к четырём (1 / 3 / 6 / 12 мес), внедрение 7-дневного бесплатного trial-периода с привязкой карты, создание retention-механик (пауза, cancellation flow с save-offers, win-back email-серии) и расширение аналитики.

**Ключевая бизнес-цель:** увеличить количество новых подписчиков за счёт снижения порога входа (trial) и увеличить LTV за счёт мультимесячных тарифов и retention-механик.

**Ожидаемый impact (базовый сценарий):**
- Рост revenue от новых подписчиков: +73%
- Снижение churn за счёт паузы: -10-15%
- Win-back: +5% от отменивших

---

## 2. Порядок этапов и обоснование

### Почему A → B → C → D?

```
Phase A: Новые тарифы (фундамент)
   ↓
Phase B: Free trial (расширение воронки)
   ↓
Phase C: Cancellation flow (удержание)
   ↓
Phase D: Пауза, win-back, антифрод (оптимизация)
```

**Phase A первая**, потому что:
- Новая тарифная сетка — фундамент для всего остального
- Trial конвертируется в месячный тариф из **новой** сетки
- Cancellation flow предлагает переход на мультимесячные тарифы из **новой** сетки
- Можно выпустить и получить value без trial

**Phase B вторая**, потому что:
- Trial зависит от новых тарифов (автоконвертация → месячный 3 900 ₽)
- Trial даёт максимальный impact на верх воронки
- Требует интеграции с CloudPayments (trial → reccurent) — основной технический риск

**Phase C третья**, потому что:
- Cancellation flow работает с обоими типами подписчиков (direct и post-trial)
- Save-offers ссылаются на мультимесячные тарифы (Phase A) и скидки
- Без A и B cancellation flow не имеет полного контекста

**Phase D последняя**, потому что:
- Пауза, win-back, антифрод — оптимизации поверх стабильной базы
- Требуют стабильной аналитики и данных от A/B/C для калибровки
- Минимальный риск для основного flow

---

## 3. Scope по этапам

### Phase A: Новые тарифы (MVP)
**Входит:**
- Новая страница тарифов (UI): 1/3/6/12 мес
- Backend: создание и хранение новых планов
- Интеграция с CloudPayments: покупка и автопродление новых тарифов
- Legacy backward compatibility (старые тарифы продолжают работать)
- Базовая аналитика (subscription_started, subscription_renewed)
- Regression-тесты для legacy

**Не входит:**
- Trial, cancellation flow, пауза, win-back
- Какие-либо изменения для legacy-подписчиков
- Email-серии (кроме transactional: подтверждение оплаты)

### Phase B: Free Trial
**Входит:**
- Trial 7 дней, привязка карты, авто-конвертация в месячный
- Trial state в ЛК (UI)
- Ограничение 1 trial на аккаунт
- Юридически обязательные email (за 24ч и 1ч до списания)
- Retry при неуспешном списании (3 попытки + grace period)
- Staged rollout infrastructure (feature flag 20%/50%/100%)
- Trial-аналитика (trial_started, trial_converted, trial_cancelled)

**Не входит:**
- Cancellation flow с причинами (простая отмена: кнопка → подтверждение)
- Пауза, win-back, антифрод
- Контентные email (онбординг, вовлечение)

### Phase C: Cancellation Flow
**Входит:**
- Многошаговый flow отмены с причинами
- Save-offer: пауза (для «нет времени»)
- Save-offer: скидка на месяц (для «дорого»)
- Save-offer: мультимесячные тарифы (secondary для «дорого»)
- Ограничения на повторные скидки (1 раз / 6 мес)
- Cancellation analytics

**Не входит:**
- Реализация самой паузы (только UI-предложение, backend в Phase D)
- Win-back серии
- Антифрод

### Phase D: Retention и расширения
**Входит:**
- Пауза подписки (backend + UI + email)
- Read-only доступ к пройденному контенту во время паузы
- Win-back email-серии (trial-отменившие + paid-отменившие)
- Расширенные email (онбординг trial, вовлечение, пауза)
- Антифрод мониторинг (дашборд trial abuse)
- Расширенная аналитика и дашборды
- Upgrade flow (месячный → мультимесячный)

---

## 4. Главные архитектурные риски

| # | Риск | Severity | Митигация |
|---|------|----------|-----------|
| 1 | CloudPayments не поддерживает trial→recurring нативно | Высокий | **Spike в начале Phase B** (до основной разработки) |
| 2 | Параллельное существование legacy и new тарифов создаёт сложность в billing-логике | Средний | Единая абстракция `SubscriptionPlan` с полем `plan_generation: legacy/new` |
| 3 | State machine подписки усложняется (trial, paused, grace period) | Средний | Явная FSM-модель в коде, валидация переходов |
| 4 | Email-система должна обрабатывать scheduled sends (за 24ч, за 1ч) | Средний | Cron/scheduler job, а не event-driven для time-based emails |
| 5 | Rollback Phase A ломает подписки, оформленные на новые тарифы | Высокий | Feature flag для UI, но billing — отдельно. Rollback = скрыть UI, не удалять планы |

---

## 5. Что проверить до старта (Spike / PoC)

### Spike 1: CloudPayments Trial Integration (обязательно до Phase B)
- Можно ли создать подписку с trial period через API?
- Как передаётся trial duration?
- Как происходит автоматическое первое списание после trial?
- Что возвращает webhook при конвертации trial → paid?
- Как обрабатывается отмена во время trial?

### Spike 2: CloudPayments Multi-Month Plans (обязательно до Phase A)
- Как оформить подписку с интервалом 3/6/12 месяцев?
- Поддерживается ли разовое списание полной суммы + автопродление через N месяцев?
- Формат webhook-ов для multi-month renewals

### Spike 3: Feature Flag Infrastructure
- Есть ли на проекте feature flag система?
- Если нет — какой минимальный вариант? (env var / DB flag / внешний сервис)
- Поддержка % rollout для trial

---

## 6. Rollout и Rollback

### Rollout-стратегия

**Phase A:**
- Deploy новой страницы тарифов за feature flag
- Включить для 100% новых пользователей (новые тарифы не конфликтуют с legacy)
- Legacy-пользователи продолжают видеть свой тариф в ЛК

**Phase B (trial):**
- Staged rollout: 20% → 50% → 100%
- Feature flag по user_id (или cookie для неавторизованных)
- Kill-метрика: если trial→paid CR < 15% или RPV упал > 20% — стоп

**Phase C, D:**
- Full rollout (нет смысла делать partial для cancellation flow)
- Мониторинг: churn rate не должен вырасти после внедрения cancellation flow

### Rollback-план

| Phase | Rollback action | Последствия |
|-------|----------------|-------------|
| A | Скрыть новую страницу тарифов (flag off). Новые планы в billing остаются — подписчики продолжают платить | Новые покупки невозможны, но текущие не ломаются |
| B | Отключить trial flag. Убрать CTA trial. Страница тарифов показывает только прямую покупку | Пользователи в активном trial продолжают — их не трогаем |
| C | Заменить cancellation flow на простую кнопку «Отменить» | Теряем retention-механики, но core flow работает |
| D | Отключить паузу / win-back по отдельности | Каждая фича независима |

---

## 7. Безопасность legacy-пользователей

### Принципы
1. **Ни одно действие не должно менять условия текущих подписчиков без их явного согласия**
2. Legacy-тарифы продолжают автопродлеваться по старым ценам
3. Legacy-подписчики видят свой тариф в ЛК + баннер о новых тарифах
4. Переход на новый тариф — только по инициативе пользователя
5. При отмене legacy-тарифа повторное оформление — только на новые тарифы

### Regression-тесты (обязательны на каждом этапе)
- Автопродление legacy месячного: списание 3 900 ₽/мес
- Автопродление legacy годового: списание 34 800 ₽ (2 900 × 12)
- Legacy 3-летний подписчик (1 человек): доступ к профессиям сохраняется
- Legacy-подписчик не видит trial CTA
- Legacy-подписчик может отменить подписку стандартным способом

---

## 8. Open Questions

### Для продукта
1. При upgrade с месячного на мультимесячный: остаток текущего месяца «дарим» или пересчитываем?
2. Если пользователь на trial нажимает «Купить 12 мес» — trial-дни добавляются как бонус или нет?
3. Win-back скидка: -20/-30/-50% — это фиксированные значения или нужна гибкость?
4. Можно ли сделать trial доступным для пользователей, которые ранее имели платную подписку, но давно её отменили (> 12 мес)?

### Для backend / платежей
5. CloudPayments: поддерживает ли API нативный trial period? Или нужно реализовывать на стороне приложения?
6. Какой webhook приходит при неуспешном рекуррентном списании? Есть ли поле retry_count?
7. Как CloudPayments обрабатывает смену карты для текущей подписки?
8. Нужен ли отдельный subscription_id для trial и для платной подписки, или это одна сущность?

### Для юристов
9. Оферта: нужно ли отдельное согласие на автосписание после trial или достаточно галочки при привязке карты?
10. Нужен ли чек на 0 ₽ при активации trial (54-ФЗ)?
11. Обязательно ли уведомление за 24ч до автосписания по закону, или это best practice?
12. Политика возвратов для мультимесячных тарифов: нужно ли прописывать явно в оферте?

### Для аналитики
13. Какая система аналитики используется? (GA, Amplitude, Mixpanel, свой?)
14. Есть ли уже event tracking infrastructure или нужно создавать?
15. Нужен ли отдельный дашборд для trial funnel или интегрируем в существующий?

### Для инфраструктуры
16. Есть ли feature flag система на проекте?
17. Есть ли scheduler/cron для отложенных задач (email за 24ч)?
18. Какая email-система используется? (SendGrid, собственная, CRM?)
