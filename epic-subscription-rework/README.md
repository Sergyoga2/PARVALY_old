# EPIC: Переработка подписочной модели Hexlet

## 1. Краткое summary

Полная переработка тарифной сетки подписки Hexlet: переход от трёх тарифов (1 мес / 12 мес / 36 мес) к четырём (1 / 3 / 6 / 12 мес), внедрение 7-дневного бесплатного trial-периода с привязкой карты, создание retention-механик (пауза, cancellation flow с save-offers, win-back email-серии) и расширение аналитики.

**Ключевая бизнес-цель:** увеличить количество новых подписчиков за счёт снижения порога входа (trial) и увеличить LTV за счёт мультимесячных тарифов и retention-механик.

**Ожидаемый impact (базовый сценарий):**
- Рост revenue от новых подписчиков: +73%
- Снижение churn за счёт паузы: -10-15%
- Win-back: +5% от отменивших

---

## 2. Порядок этапов и обоснование

### Почему A → B → C → D?

```
Phase A: Новые тарифы (фундамент)
   ↓
Phase B: Free trial (расширение воронки)
   ↓
Phase C: Cancellation flow (удержание)
   ↓
Phase D: Пауза, win-back, антифрод (оптимизация)
```

**Phase A первая**, потому что:
- Новая тарифная сетка — фундамент для всего остального
- Trial конвертируется в месячный тариф из **новой** сетки
- Cancellation flow предлагает переход на мультимесячные тарифы из **новой** сетки
- Можно выпустить и получить value без trial

**Phase B вторая**, потому что:
- Trial зависит от новых тарифов (автоконвертация → месячный 3 900 ₽)
- Trial даёт максимальный impact на верх воронки
- Требует интеграции с CloudPayments (trial → reccurent) — основной технический риск

**Phase C третья**, потому что:
- Cancellation flow работает с обоими типами подписчиков (direct и post-trial)
- Save-offers ссылаются на мультимесячные тарифы (Phase A) и скидки
- Без A и B cancellation flow не имеет полного контекста

**Phase D последняя**, потому что:
- Пауза, win-back, антифрод — оптимизации поверх стабильной базы
- Требуют стабильной аналитики и данных от A/B/C для калибровки
- Минимальный риск для основного flow

---

## 3. Scope по этапам

### Phase A: Новые тарифы (MVP)
**Входит:**
- Новая страница тарифов (UI): 1/3/6/12 мес
- Backend: создание и хранение новых планов
- Интеграция с CloudPayments: покупка и автопродление новых тарифов
- Legacy backward compatibility (старые тарифы продолжают работать)
- Базовая аналитика (subscription_started, subscription_renewed)
- Regression-тесты для legacy

**Не входит:**
- Trial, cancellation flow, пауза, win-back
- Какие-либо изменения для legacy-подписчиков
- Email-серии (кроме transactional: подтверждение оплаты)

### Phase B: Free Trial
**Входит:**
- Trial 7 дней, привязка карты, авто-конвертация в месячный
- Trial state в ЛК (UI)
- Ограничение 1 trial на аккаунт
- Юридически обязательные email (за 24ч и 1ч до списания)
- Retry при неуспешном списании (3 попытки + grace period)
- Staged rollout infrastructure (feature flag 20%/50%/100%)
- Trial-аналитика (trial_started, trial_converted, trial_cancelled)

**Не входит:**
- Cancellation flow с причинами (простая отмена: кнопка → подтверждение)
- Пауза, win-back, антифрод
- Контентные email (онбординг, вовлечение)

### Phase C: Cancellation Flow
**Входит:**
- Многошаговый flow отмены с причинами
- Save-offer: пауза (для «нет времени»)
- Save-offer: скидка на месяц (для «дорого»)
- Save-offer: мультимесячные тарифы (secondary для «дорого»)
- Ограничения на повторные скидки (1 раз / 6 мес)
- Cancellation analytics

**Не входит:**
- Реализация самой паузы (только UI-предложение, backend в Phase D)
- Win-back серии
- Антифрод

### Phase D: Retention и расширения
**Входит:**
- Пауза подписки (backend + UI + email)
- Read-only доступ к пройденному контенту во время паузы
- Win-back email-серии (trial-отменившие + paid-отменившие)
- Расширенные email (онбординг trial, вовлечение, пауза)
- Антифрод мониторинг (дашборд trial abuse)
- Расширенная аналитика и дашборды
- Upgrade flow (месячный → мультимесячный)

---

## 4. Главные архитектурные риски

> **Обновлено 2026-02-24:** Риск #1 подтверждён (trial не нативно), но impact снижен. Риск о multi-month **снят** (поддерживается нативно).

| # | Риск | Severity | Статус | Митигация |
|---|------|----------|--------|-----------|
| 1 | CloudPayments не поддерживает trial→recurring нативно | Средний (снижен) | ✅ **Подтверждён**, но решение проще ожидаемого: `StartDate = now + 7 days` | Spike 1 упрощён: проверить в sandbox отложенную подписку |
| ~~2~~ | ~~CloudPayments не поддерживает multi-month intervals~~ | ~~Высокий~~ | ✅ **СНЯТ** | Поддерживает: `Period=3/6/12, Interval=Month` |
| 3 | Параллельное существование legacy и new тарифов создаёт сложность в billing-логике | Средний | Открыт | Единая абстракция `SubscriptionPlan` с полем `plan_generation: legacy/new` |
| 4 | State machine подписки усложняется (trial, paused, grace period) | Средний | Открыт | Явная FSM-модель в коде, валидация переходов |
| 5 | Email-система должна обрабатывать scheduled sends (за 24ч, за 1ч) | Средний | Открыт | Cron/scheduler job, а не event-driven для time-based emails |
| 6 | Rollback Phase A ломает подписки, оформленные на новые тарифы | Высокий | Открыт | Feature flag для UI, но billing — отдельно. Rollback = скрыть UI, не удалять планы |
| 7 | **Новый:** Retry логика CP (3 попытки, 72ч) отличается от нашего дизайна (4 попытки, 96ч) | Низкий | Открыт | Адаптировать дизайн под CP или управлять retry самостоятельно |

---

## 5. Что проверить до старта (Spike / PoC)

> **Обновлено 2026-02-24** по результатам исследования CloudPayments API.
> Полный отчёт: [appendix/cloudpayments-api-research.md](appendix/cloudpayments-api-research.md)

### ~~Spike 2: CloudPayments Multi-Month Plans~~ — СНЯТ

✅ **Подтверждено из документации API:** CloudPayments поддерживает мультимесячные интервалы нативно.
- `Interval: "Month"` + `Period: 3/6/12` — работает из коробки
- Ограничение: максимальный интервал = 1 год (нам подходит)
- Spike не нужен, достаточно проверить при реализации Phase A в sandbox

### Spike 1: CloudPayments Trial Integration (упрощён, обязательно до Phase B)

✅ **Выяснено:** CloudPayments **НЕ** поддерживает trial нативно (нет параметра trialDays).

**Рекомендуемый подход:** Создать подписку с `StartDate = now + 7 days`:
- `POST /subscriptions/create` с `StartDate = trial_ends_at`, `Amount = 3900`
- CloudPayments сам выполнит первое списание через 7 дней
- Отмена trial = `POST /subscriptions/cancel`

**Что осталось проверить в sandbox:**
1. Подписка с `StartDate = now + 7 days` — подтвердить, что списание происходит ровно в указанную дату
2. Cancel подписки до StartDate — подтвердить, что списания не будет
3. Какой webhook приходит при первом списании (Pay? Recurrent? Оба?)
4. Сохраняется ли Token после cancel (для win-back и переоформления)

### Spike 3: Feature Flag Infrastructure (без изменений)
- Есть ли на проекте feature flag система?
- Если нет — какой минимальный вариант? (env var / DB flag / внешний сервис)
- Поддержка % rollout для trial

---

## 6. Rollout и Rollback

### Rollout-стратегия

**Phase A:**
- Deploy новой страницы тарифов за feature flag
- Включить для 100% новых пользователей (новые тарифы не конфликтуют с legacy)
- Legacy-пользователи продолжают видеть свой тариф в ЛК

**Phase B (trial):**
- Staged rollout: 20% → 50% → 100%
- Feature flag по user_id (или cookie для неавторизованных)
- Kill-метрика: если trial→paid CR < 15% или RPV упал > 20% — стоп

**Phase C, D:**
- Full rollout (нет смысла делать partial для cancellation flow)
- Мониторинг: churn rate не должен вырасти после внедрения cancellation flow

### Rollback-план

| Phase | Rollback action | Последствия |
|-------|----------------|-------------|
| A | Скрыть новую страницу тарифов (flag off). Новые планы в billing остаются — подписчики продолжают платить | Новые покупки невозможны, но текущие не ломаются |
| B | Отключить trial flag. Убрать CTA trial. Страница тарифов показывает только прямую покупку | Пользователи в активном trial продолжают — их не трогаем |
| C | Заменить cancellation flow на простую кнопку «Отменить» | Теряем retention-механики, но core flow работает |
| D | Отключить паузу / win-back по отдельности | Каждая фича независима |

---

## 7. Безопасность legacy-пользователей

### Принципы
1. **Ни одно действие не должно менять условия текущих подписчиков без их явного согласия**
2. Legacy-тарифы продолжают автопродлеваться по старым ценам
3. Legacy-подписчики видят свой тариф в ЛК + баннер о новых тарифах
4. Переход на новый тариф — только по инициативе пользователя
5. При отмене legacy-тарифа повторное оформление — только на новые тарифы

### Regression-тесты (обязательны на каждом этапе)
- Автопродление legacy месячного: списание 3 900 ₽/мес
- Автопродление legacy годового: списание 34 800 ₽ (2 900 × 12)
- Legacy 3-летний подписчик (1 человек): доступ к профессиям сохраняется
- Legacy-подписчик не видит trial CTA
- Legacy-подписчик может отменить подписку стандартным способом

---

## 8. Open Questions

> **Обновлено 2026-02-24:** Вопросы 5-8 получили ответы из документации CloudPayments API.
> Полный отчёт: [appendix/cloudpayments-api-research.md](appendix/cloudpayments-api-research.md)

### Для продукта (ожидают ответа)
1. При upgrade с месячного на мультимесячный: остаток текущего месяца «дарим» или пересчитываем?
2. Если пользователь на trial нажимает «Купить 12 мес» — trial-дни добавляются как бонус или нет?
3. Win-back скидка: -20/-30/-50% — это фиксированные значения или нужна гибкость?
4. Можно ли сделать trial доступным для пользователей, которые ранее имели платную подписку, но давно её отменили (> 12 мес)?

### Для backend / платежей (✅ ответы найдены)
5. ✅ **CloudPayments НЕ поддерживает trial нативно.** Нет параметра trialDays/trialPeriod. Рекомендация: создавать подписку с `StartDate = now + 7 days` — CP сам спишет через 7 дней. Отмена trial = `subscriptions/cancel`.
6. ✅ **При неуспешном рекуррентном списании** приходит Fail webhook с полями: TransactionId, ReasonCode, Amount, AccountId. Поля `retry_count` **НЕТ** — CloudPayments управляет retry внутренне (3 попытки, 1/день). Для подсчёта retry нужно считать Fail webhooks на нашей стороне.
7. ✅ **Смена карты:** Пользователь вводит новую карту → новый Token → обновляем Token в подписке через `subscriptions/update` или создаём новую подписку. CloudPayments также предлагает пользователям обновить карту при failed payments через `my.cloudpayments.ru`.
8. ✅ **subscription_id:** При подходе с `StartDate` — одна сущность (`sc_XXXXXXXXXXXX`). Trial и paid-период — одна подписка с разными фазами. При отмене trial отменяется подписка в CP, новый subscription_id создаётся при переоформлении.

### Для юристов (ожидают ответа)
9. Оферта: нужно ли отдельное согласие на автосписание после trial или достаточно галочки при привязке карты?
10. Нужен ли чек на 0 ₽ при активации trial (54-ФЗ)?
11. Обязательно ли уведомление за 24ч до автосписания по закону, или это best practice?
12. Политика возвратов для мультимесячных тарифов: нужно ли прописывать явно в оферте?

### Для аналитики (ожидают ответа)
13. Какая система аналитики используется? (GA, Amplitude, Mixpanel, свой?)
14. Есть ли уже event tracking infrastructure или нужно создавать?
15. Нужен ли отдельный дашборд для trial funnel или интегрируем в существующий?

### Для инфраструктуры (ожидают ответа)
16. Есть ли feature flag система на проекте?
17. Есть ли scheduler/cron для отложенных задач (email за 24ч)?
18. Какая email-система используется? (SendGrid, собственная, CRM?)

### Дополнительные вопросы из исследования CP API (новые)
19. **Retry логика:** CloudPayments делает 3 retry (1/день), а не 4 retry как в нашем дизайне. Grace period = 72ч, не 96ч. Нужно согласовать: использовать встроенный retry CP или управлять самостоятельно?
20. **Token после cancel:** Документация явно не описывает. Нужно проверить в sandbox: сохраняется ли token после `subscriptions/cancel`. Критично для win-back и pause→resume.
21. **Установочный платёж 1 ₽:** Нужен ли для валидации карты при trial, или достаточно tokenize через виджет без списания? Если нужен — требуется чек по 54-ФЗ.
